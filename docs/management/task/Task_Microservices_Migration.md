> ‚ö†Ô∏è **PHASE 5 TARGET**
> –≠—Ç–∞ –∑–∞–¥–∞—á–∞ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ —ç—Ç–∞–ø "–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –†–µ–ª–∏–∑".

# üöÄ Microservices Architecture: Ideas & Patterns

> **Status:** Brainstorming
> **Goal:** –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏–¥–µ–∏ –¥–ª—è –±—É–¥—É—â–µ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É, –æ—Å–Ω–æ–≤–∞–Ω–Ω—É—é –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–µ Gateway.

## 1. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –°–µ—Ä–≤–∏—Å—ã (4-Tier Logic)

### üîª –£—Ä–æ–≤–µ–Ω—å 1-2: Bot Logic (UI & Orchestration)
*   **–°–µ—Ä–≤–∏—Å:** `Front-Bot Service`
*   **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
    *   **Handlers & UI Services:** –ü—Ä–∏–µ–º/–æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–ª–±—ç–∫–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ FSM (UI-–ª–æ–≥–∏–∫–∞).
    *   **Orchestrators:** –õ–æ–≥–∏–∫–∞ "—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤" –∏–≥—Ä–æ–∫–∞. –ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤—ã –∫ Gateway –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ü–æ–π—Ç–∏ –≤ —Ä–µ–π–¥" —Ç—Ä–µ–±—É–µ—Ç –≤—ã–∑–æ–≤–æ–≤ `get_location`, `create_clan`, `start_combat`).
*   **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** `aiogram`.
*   **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ:** –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî `API Gateway`.

### üîª –£—Ä–æ–≤–µ–Ω—å 3: Gateway (Bridge)
*   **–°–µ—Ä–≤–∏—Å:** `API-Gateway Service`
*   **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:**
    *   –°–ª—É–∂–∏—Ç –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (—Å–Ω–∞—á–∞–ª–∞ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è `Front-Bot`).
    *   –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º `Game Services`.
    *   –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, rate limiting.
    *   –ê–≥—Ä–µ–≥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.
*   **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** `FastAPI` –∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Gateway (–Ω–∞–ø—Ä–∏–º–µ—Ä, `Kong`, `Tyk`).
*   **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ:** –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç `Front-Bot`, –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `Game-Core` –∏ –¥—Ä—É–≥–∏–º —Å–µ—Ä–≤–∏—Å–∞–º.

### üîª –£—Ä–æ–≤–µ–Ω—å 4: Game Services (Domain Logic)
*   **–°–µ—Ä–≤–∏—Å:** `Game-Core Service`
    *   **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∏–≥—Ä–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ (–±–æ–π, –∫—Ä–∞—Ñ—Ç, —Å–∫–∏–ª–ª—ã, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∏—Ä–∞). –ù–µ –∑–Ω–∞–µ—Ç –æ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–∏ Telegram –∏–ª–∏ UI.
    *   **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** `FastAPI` –∏–ª–∏ `gRPC` —Å–µ—Ä–≤–µ—Ä.
    *   **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ:** –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –æ—Ç `API-Gateway`, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ë–î –∏ Redis.
*   **–°–µ—Ä–≤–∏—Å:** `Worker Service(s)`
    *   **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –§–æ–Ω–æ–≤—ã–µ, –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ –∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏.
    *   **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:** `Celery` (—Å `Celery Beat` –¥–ª—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π).
    *   **–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ:** –ú–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ `API-Gateway` (–¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∑–∞–¥–∞—á) –∏–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é. –ù–∞–ø—Ä—è–º—É—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å –ë–î/Redis.

---

## 2. –ü–∞—Ç—Ç–µ—Ä–Ω—ã –∏ –†–µ—à–µ–Ω–∏—è

### 2.1. –í–æ—Ä–∫–µ—Ä—ã: –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ó–∞–¥–∞—á

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–≥–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –≤ –∏–≥—Ä–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫ –∏ –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∏–ª–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é.

**–†–µ—à–µ–Ω–∏–µ (Celery Workers & Beat):**

*   **`TickerWorker` (–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏):**
    *   **Snapshot/Save State:** –†–∞–∑ –≤ N –º–∏–Ω—É—Ç —Å–∫–∞–Ω–∏—Ä—É–µ—Ç "–≥–æ—Ä—è—á–∏–µ" –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis (–ø–æ–∑–∏—Ü–∏–∏, HP) –∏ –º–∞—Å—Å–æ–≤–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ Postgres. –≠—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ.
    *   **World Events:** –ü–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–æ–±—ã—Ç–∏—è –≤ –º–∏—Ä–µ ‚Äî —Å–ø–∞–≤–Ω –º–∏—Ä–æ–≤—ã—Ö –±–æ—Å—Å–æ–≤, –∑–∞–∫—Ä—ã—Ç–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–æ–Ω, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã.
    *   **Recalculate Leaderboards:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –∫—ç—à–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–ª–∏—Ü –ª–∏–¥–µ—Ä–æ–≤.

*   **`AsyncJobWorker` (–∑–∞–¥–∞—á–∏ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é):**
    *   **Notifications:** –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–¥–∞—á—É "–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ" –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –µ–µ –≤ —Ñ–æ–Ω–µ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–¥–µ—Ä–∂–∏–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    *   **Generations:** –°–ª–æ–∂–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–∑–¥–∞–Ω–∏–µ –ª—É—Ç–∞ –ø–æ—Å–ª–µ –±–æ—è) –º–æ–≥—É—Ç –±—ã—Ç—å –≤—ã–Ω–µ—Å–µ–Ω—ã —Å—é–¥–∞, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ.
    *   **Matchmaking:** –ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–æ–≤ –¥–ª—è PvP –∏–ª–∏ –∫–æ–æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤.

### 2.2. –ú–µ–∂—Å–µ—Ä–≤–∏—Å–Ω–æ–µ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ

*   **–°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ (Bot -> Gateway -> Game-Core):**
    *   **REST API (FastAPI):** –ü—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è —Å—Ç–∞—Ä—Ç–∞. `Front-Bot` –¥–µ–ª–∞–µ—Ç HTTP-–∑–∞–ø—Ä–æ—Å –∫ `API-Gateway`, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –≤ `Game-Core`.
    *   **gRPC:** –ë–æ–ª–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (`Gateway` <-> `Game-Core`). –¢—Ä–µ–±—É–µ—Ç `proto`-—Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤.

*   **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ (–°–æ–±—ã—Ç–∏–π–Ω–∞—è –º–æ–¥–µ–ª—å):**
    *   **RabbitMQ / Redis Pub/Sub:** –î–ª—è —Å–æ–±—ã—Ç–∏–π, –Ω–µ —Ç—Ä–µ–±—É—é—â–∏—Ö –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.
    *   *–ü—Ä–∏–º–µ—Ä:* `Game-Core` –ø—É–±–ª–∏–∫—É–µ—Ç —Å–æ–±—ã—Ç–∏–µ `player_level_up`. `API-Gateway` –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞—Ç—å –µ–≥–æ `Front-Bot` –¥–ª—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è, –∞ `Worker` ‚Äî –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±–æ–Ω—É—Å–æ–≤.
