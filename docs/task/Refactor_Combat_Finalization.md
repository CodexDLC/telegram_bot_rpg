# ‚öîÔ∏è Refactoring: Combat Finalization Strategy

> **Status:** Planned
> **Target:** Phase 3 (Combat Polish)
> **Goal:** –†–∞–∑–¥–µ–ª–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–æ—è (–Ω–∞–≥—Ä–∞–¥—ã, –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è) –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞ –∏–≥—Ä—ã (PvE, PvP, Tutorial).

## 1. –ü—Ä–æ–±–ª–µ–º–∞
–°–µ–π—á–∞—Å –ª–æ–≥–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–æ—è (`finish_battle`) —Å–º–µ—à–∞–Ω–∞. –ù–µ—Ç —á–µ—Ç–∫–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –º–µ–∂–¥—É "—Å–º–µ—Ä—Ç–µ–ª—å–Ω—ã–º" –±–æ–µ–º –≤ –º–∏—Ä–µ, "—Å–ø–æ—Ä—Ç–∏–≤–Ω—ã–º" –±–æ–µ–º –Ω–∞ –∞—Ä–µ–Ω–µ –∏ "–æ–±—É—á–∞—é—â–∏–º" –±–æ–µ–º. –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ä–∏—Å–∫—É –±–∞–≥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Ç–µ—Ä—è –ª—É—Ç–∞ –Ω–∞ –ê—Ä–µ–Ω–µ –∏–ª–∏ —Å–º–µ—Ä—Ç—å –≤ –¢—É—Ç–æ—Ä–∏–∞–ª–µ).

## 2. –†–µ—à–µ–Ω–∏–µ: Combat Modes & Strategies

### 2.1. Enum `CombatMode`
–í–≤–æ–¥–∏–º —è–≤–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –±–æ—è –≤ `apps/common/schemas_dto/combat_source_dto.py`.

```python
from enum import StrEnum

class CombatMode(StrEnum):
    ADVENTURE = "adventure"   # –û–±—ã—á–Ω—ã–π PvE –≤ –º–∏—Ä–µ (–°–º–µ—Ä—Ç—å, –õ—É—Ç, –û–ø—ã—Ç, –ò–∑–Ω–æ—Å)
    TUTORIAL = "tutorial"     # –û–±—É—á–µ–Ω–∏–µ (–ë–µ—Å—Å–º–µ—Ä—Ç–∏–µ, –°–∫—Ä–∏–ø—Ç–æ–≤—ã–π –ª—É—Ç, –§–∏–∫—Å. XP)
    ARENA = "arena"           # –ê—Ä–µ–Ω–∞ (–ë–µ–∑ —Å–º–µ—Ä—Ç–∏, –†–µ–π—Ç–∏–Ω–≥ Elo, –ë–µ–∑ –ª—É—Ç–∞)
    DUEL = "duel"             # –î—Ä—É–∂–µ—Å–∫–∞—è –¥—É—ç–ª—å (–ë–µ–∑ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π)
    RIFT = "rift"             # –†–∏—Ñ—Ç (–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π –¥—Ä–æ–ø, —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –≤—Å–µ–≥–æ)
```

### 2.2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –†–µ–∂–∏–º–∞
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ (`CombatLifecycleService.create_battle`) –º—ã **–æ–±—è–∑–∞–Ω—ã** –ø–µ—Ä–µ–¥–∞—Ç—å `mode`. –≠—Ç–æ—Ç —Ä–µ–∂–∏–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–∏ –≤ Redis.

### 2.3. –î–∏—Å–ø–µ—Ç—á–µ—Ä –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (The Finalizer)
–í `CombatLifecycleService.finish_battle` —Ä–µ–∞–ª–∏–∑—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω **Strategy** (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ–π `match/case` –¥–ª—è –Ω–∞—á–∞–ª–∞).

#### –õ–æ–≥–∏–∫–∞ –î–∏—Å–ø–µ—Ç—á–µ—Ä–∞ (–ü—Å–µ–≤–¥–æ–∫–æ–¥)
```python
async def finish_battle(self, session_id: str, winner_team: str):
    meta = await self.combat_manager.get_session_meta(session_id)
    mode = meta.get("mode", CombatMode.ADVENTURE)
    
    log.info(f"Finalizing combat {session_id} | Mode: {mode} | Winner: {winner_team}")

    match mode:
        case CombatMode.TUTORIAL:
            await self._finalize_tutorial(session_id, winner_team)
        case CombatMode.ARENA:
            await self._finalize_arena(session_id, winner_team)
        case CombatMode.ADVENTURE | CombatMode.RIFT:
            await self._finalize_adventure(session_id, winner_team)
        case _:
            log.warning(f"Unknown combat mode: {mode}")
            
    # –û–±—â–∞—è –æ—á–∏—Å—Ç–∫–∞ (—É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ Redis)
    await self.combat_manager.delete_session(session_id)
```

---

## 3. –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –°—Ç—Ä–∞—Ç–µ–≥–∏–π

### üü¢ Strategy: TUTORIAL
*   **–¶–µ–ª—å:** –ù–∞—É—á–∏—Ç—å, –ø–æ—Ö–≤–∞–ª–∏—Ç—å, –Ω–µ –Ω–∞–∫–∞–∑–∞—Ç—å.
*   **–î–µ–π—Å—Ç–≤–∏—è:**
    1.  **HP/Energy:** –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è (–∏–≥—Ä–æ–∫–∞).
    2.  **XP:** –í—ã–¥–∞—á–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–ø—ã—Ç–∞ (–¥–ª—è Level Up -> 2).
    3.  **Loot:** –í—ã–¥–∞—á–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ (–µ—Å–ª–∏ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–æ).
    4.  **Death:** –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –ø—Ä–æ–∏–≥—Ä–∞–ª ‚Äî "–ì–æ–ª–æ—Å –≤ –≥–æ–ª–æ–≤–µ –≥–æ–≤–æ—Ä–∏—Ç: –í—Å—Ç–∞–≤–∞–π..." (–≤–æ—Å–∫—Ä–µ—à–µ–Ω–∏–µ —Å 1 HP –±–µ–∑ —à—Ç—Ä–∞—Ñ–æ–≤).

### üü° Strategy: ARENA
*   **–¶–µ–ª—å:** –°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ.
*   **–î–µ–π—Å—Ç–≤–∏—è:**
    1.  **Rating:** –†–∞—Å—á–µ—Ç Elo (–ø–æ–±–µ–¥–∏—Ç–µ–ª—å +, –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏–π -).
    2.  **Loot:** –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.
    3.  **Durability:** –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞ –ù–ï –ª–æ–º–∞–µ—Ç—Å—è.
    4.  **HP:** –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ 100% –ø–æ—Å–ª–µ –±–æ—è (–º–∞–≥–∏—è –∞—Ä–µ–Ω—ã).

### üî¥ Strategy: ADVENTURE / RIFT
*   **–¶–µ–ª—å:** –†–∏—Å–∫ –∏ –ù–∞–≥—Ä–∞–¥–∞.
*   **–î–µ–π—Å—Ç–≤–∏—è:**
    1.  **XP:** –†–∞—Å—á–µ—Ç –æ–ø—ã—Ç–∞ –ø–æ —Ñ–æ—Ä–º—É–ª–µ (—É—Ä–æ–≤–µ–Ω—å –º–æ–±–∞ vs —É—Ä–æ–≤–µ–Ω—å –∏–≥—Ä–æ–∫–∞).
    2.  **Loot:** –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥—Ä–æ–ø–∞ —Å –ø—Ä–æ–∏–≥—Ä–∞–≤—à–µ–≥–æ (–º–æ–±–∞).
    3.  **Durability:** –°–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–æ—á–Ω–æ—Å—Ç–∏ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ (–∑–∞ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —É–¥–∞—Ä—ã).
    4.  **Death (UX Flow):**
        *   **–ù–ï –¢–ï–õ–ï–ü–û–†–¢–ò–†–û–í–ê–¢–¨ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò.**
        *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ `is_dead=True` –≤ –ë–î –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.
        *   –°–±—Ä–æ—Å–∏—Ç—å FSM –∏–≥—Ä–æ–∫–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ `GameState.dead`.
        *   –ë–æ—Ç (UI) –ø–æ–∫–∞–∂–µ—Ç —ç–∫—Ä–∞–Ω —Å–º–µ—Ä—Ç–∏ —Å –∫–Ω–æ–ø–∫–æ–π "–í–æ–∑—Ä–æ–¥–∏—Ç—å—Å—è –≤ –≥–æ—Ä–æ–¥–µ" (–∏–ª–∏ "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ê–Ω–∫—Ö").

---

## 4. –ü–ª–∞–Ω –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (Tasks)

1.  **DTO Update:** –î–æ–±–∞–≤–∏—Ç—å `CombatMode` –≤ `combat_source_dto.py`.
2.  **Lifecycle Update:**
    *   –û–±–Ω–æ–≤–∏—Ç—å `create_battle` –¥–ª—è –ø—Ä–∏–µ–º–∞ `mode`.
    *   –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `match/case` –≤ `finish_battle`.
3.  **Implement Handlers:** –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã `_finalize_tutorial`, `_finalize_arena`, `_finalize_adventure`.
4.  **Integration:** –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—è –≤ `ArenaManager`, `EncounterService` –∏ `TutorialService`.
