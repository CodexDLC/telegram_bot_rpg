# Боевая Система (Tactical Combat)

Основана на тактическом размене ударами с разделением на фазы.

## 1. Геометрия Боя
Используется схема **4-х зон** (Голова, Корпус, Живот, Ноги). Игрок выбирает 1 зону для Атаки и 2 зоны для Блока (или пару зон).

## 2. Структура Хода (Async Turn-Based)
Бой асинхронный для каждой пары участников.
1.  **Заявка (Pending Move):** Игрок выбирает действие. Оно сохраняется в Redis с таймером (Deadline).
2.  **Ожидание:** Если противник еще не сходил, игрок ждет.
3.  **Разрешение (Resolution):** Как только оба участника сделали выбор, происходит мгновенный расчет раунда.

## 3. Техническая Реализация: Ability Pipeline
Расчет урона и эффектов проходит через конвейер (`AbilityService`), состоящий из трех фаз:

1.  **Pre-Calc (Подготовка):**
    * Модификация статов (например, временный бафф силы).
    * Установка флагов (Rules): `ignore_block`, `ignore_dodge`, `override_damage_type`.
    * *Пример:* Способность "Удар Тенью" включает флаг `ignore_block`.

2.  **Calculation (Математика):**
    * Сравнение Точности vs Уворота.
    * Сравнение Зон Атаки vs Зон Блока.
    * Расчет чистого урона (Raw Damage) с учетом брони и резистов.

3.  **Post-Calc (Эффекты):**
    * Применение эффектов на основе результата (Triggers).
    * Триггеры: `on_hit`, `on_crit`, `on_block`.
    * Действия: `apply_status` (яд, горение), `heal` (вампиризм), `deal_damage` (доп. урон).

## 4. Здоровье и Энергия
В коде реализована система, где **Энергия (Energy)** выступает не только ресурсом для каста, но и **Силовым Щитом**.

* **Поглощение Урона:** Входящий урон сначала вычитается из `energy_current`.
* **Пробой:** Если Энергия падает до 0 (или удар имеет свойство пробивания), урон начинает вычитаться из `hp_current`.
* **Смерть:** HP = 0.