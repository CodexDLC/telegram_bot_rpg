# БОЕВАЯ СИСТЕМА (PARALLEL EXCHANGE)

> Основа: независимые, параллельные обмены ударами между участниками боя.

---

## 1. Структура Боя: Параллельные Потоки

Бой не имеет глобальных раундов или общих таймеров. Вместо этого каждый участник может вести **несколько независимых дуэлей одновременно**.

1.  **Инициация Обмена (Initiation):**
    Игрок выбирает цель (например, Моб А) и отправляет заявку на атаку (выбор зоны удара).
    *   С этого момента создается "Поток Обмена" между Игроком и Мобом А.
    *   Этот поток находится в статусе **Ожидание (Pending)**, пока Моб А не ответит своим действием.

2.  **Параллельность (Multitasking):**
    **Не дожидаясь** ответа от Моба А, игрок может инициировать новый обмен с Мобом Б.
    *   Таким образом, один персонаж может иметь несколько активных, но незавершенных обменов с разными противниками.

3.  **Разрешение (Resolution):**
    Как только второй участник конкретного потока (например, Моб А) отправляет свое ответное действие, этот конкретный обмен **мгновенно рассчитывается**.
    *   *Пример:* Игрок может успеть провести 3 быстрых обмена ударами с шустрым Мобом Б, пока медленный Моб А только готовит свой первый удар в ответ на атаку игрока.

4.  **Динамика:**
    Скорость боя зависит от скорости реакции участников. Кто быстрее принимает решения, тот навязывает свой темп и совершает больше действий в единицу времени.

---

## 2. Способности: Навыки и Дары

Все активные и пассивные умения в бою делятся на два типа:

### I. Навыки (Skills)
Это базовые способности, доступные персонажу через тренировки и опыт. Они не требуют магической энергии, но расходуют выносливость.
*   **Источник:** Прокачка боевых веток (владение мечом, стрельба из лука, защита).
*   **Примеры:** "Мощный удар" (больше урона), "Парирование" (улучшенный блок), "Точный выстрел" (игнор части уворота).

### II. Дары (Gifts)
Это уникальные, мощные способности, которые дарует и усиливает **Симбиот**. Они являются проявлением его сущности и связи с носителем.
*   **Источник:** Прокачка и развитие Симбиота. Дары разделены на разные "школы", отражающие природу Симбиота.
*   **Механика:** Расходуют **Энергию (Energy)**, которая также является персональным щитом.
*   **Примеры:** "Удар Тенью" (игнорирует блок), "Эфирный Щит" (поглощает весь урон на 1 ход), "Цепная молния" (атакует несколько целей).

---

## 3. Техническая Реализация: Ability Pipeline

Расчет урона и эффектов проходит через конвейер (`AbilityService`), состоящий из трех фаз. Это позволяет гибко настраивать способности.

1.  **Pre-Calc (Подготовка):**
    *   Модификация статов (например, временный бафф силы).
    *   Установка флагов (Rules): `ignore_block`, `ignore_dodge`, `override_damage_type`.
    *   *Пример:* Способность "Удар Тенью" включает флаг `ignore_block`.

2.  **Calculation (Математика):**
    *   Сравнение Точности vs Уворота.
    *   Сравнение Зон Атаки vs Зон Блока.
    *   Расчет чистого урона (Raw Damage) с учетом брони и резистов.

3.  **Post-Calc (Эффекты):**
    *   Применение эффектов на основе результата (Triggers).
    *   Триггеры: `on_hit`, `on_crit`, `on_block`.
    *   Действия: `apply_status` (яд, горение), `heal` (вампиризм), `deal_damage` (доп. урон).

---

## 4. Здоровье и Энергия: Двойной Пул

В коде реализована система, где **Энергия (Energy)** выступает не только ресурсом для Даров, но и **Силовым Щитом**, который генерирует Симбиот.

*   **Поглощение Урона:** Входящий урон сначала вычитается из `energy_current`.
*   **Пробой:** Если Энергия падает до 0 (или удар имеет свойство "пробивание щита"), урон начинает вычитаться из `hp_current`.
*   **Смерть:** Наступает при HP = 0.
