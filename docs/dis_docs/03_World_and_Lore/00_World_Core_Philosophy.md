# ФИЛОСОФИЯ МИРА: ЛАТЕНТНОСТЬ И ГРАФ

**Тип документа:** Концептуальная Архитектура
**Суть:** Гибридная система хранения мира с механикой "Тумана Войны" на уровне бэкенда.

---

## 1. Философия и Масштаб

### 1.1 Топология: Сектора и Узлы
Мир — это не тайловая карта (где клетка = 1 метр). Это **Граф Локаций (Points of Interest)**.

*   **Макро-уровень (Регионы):** Мир поделен на сетку **7x7 регионов** (A-G по вертикали, 1-7 по горизонтали).
*   **Микро-уровень (Зоны):** Каждый регион состоит из 9 Зон (3x3).
*   **Нано-уровень (Клетки):** Каждая Зона — это квадрат 5x5 клеток.
    *   **Всего:** 105x105 = **11,025 уникальных локаций**.
*   **Смысл Клетки:** Одна координата `[x:15, y:15]` — это полноценная локация (например, *"Старая Ратуша"* или *"Поляна с Волками"*). В ней происходит геймплей.

### 1.2 Принцип "Латентного Мира" (The Latent World)
Мир огромен, но изначально он "спит". Мы не генерируем контент для 11 тысяч клеток сразу, чтобы не перегружать нейросеть и базу данных.

*   **Матрица (Postgres):** Знает о существовании **всех** 11,025 клеток. Но для большинства из них статус `is_active = False`. Это "Туман". Там есть координаты, биом, но нет описания и контента.
*   **Сцена (Redis):** Знает **ТОЛЬКО** о тех клетках, где `is_active = True`.
*   **Правило Навигации:** Игрок может перемещаться только по активным клеткам, загруженным в Redis.

---

## 2. Механика "Пробуждения" (World Awakening)

Как "неактивное" становится "активным".

### Активация Зонами
Мы не открываем мир по одной клетке. Мы активируем его **Зонами (Chunks 5x5)**.
1.  **Триггер:** Квест отправляет игрока в неизведанный регион, или игрок подходит к границе "Тумана".
2.  **Заказ:** Система (`ZoneOrchestrator`) получает задачу сгенерировать контент для всей Зоны (25 клеток).
3.  **Генерация:** Нейросеть (Gemini) создает описания и наполнение для всей Зоны разом, учитывая контекст соседей.
4.  **Результат:** Зона получает статус `is_active = True`, загружается в Redis и становится доступной для игроков.

### Протаптывание Троп
Если квест требует проложить маршрут через несколько "спящих" Зон, система запускает каскадную генерацию, последовательно пробуждая все Зоны на пути следования.

---

## 3. Техническая Реализация

### База Данных (PostgreSQL) — "Долговременная Память"
Хранит полную структуру мира, все флаги, настройки биомов и сгенерированный контент. Это источник истины.

### Redis (Runtime Cache) — "Оперативная Память"
Слой быстрого доступа для навигации.
*   При старте сервера (или при активации Зоны) данные из Postgres загружаются в Redis.
*   Вся навигация игроков (перемещение, проверка соседей) происходит **исключительно через Redis** для максимальной скорости.
