# ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ: THREAT SERVICE

**Сервис:** `apps/game_core/game_service/world/threat_service.py`
**Конфиг:** `apps/game_core/resources/game_data/world_config.py`

---

## 1. Концепция "Полевой Теории"

Система угроз в игре строится не на жестких зонах ("здесь уровень 5, там уровень 10"), а на динамическом расчете полей влияния.

Мир — это сетка, на которую воздействуют несколько сил:
1.  **Якоря (Anchors):** Источники аномальной энергии (Лед, Огонь, Гравитация, Био). Они повышают уровень угрозы.
2.  **Хаб (Portal):** Источник стабильности. Он генерирует "Щит", который понижает уровень угрозы.

Итоговый уровень угрозы (`threat_val`) в любой точке `(x, y)` рассчитывается как сумма влияний всех Якорей минус защита Хаба.

---

## 2. Математическая Модель

### Формула Влияния
Влияние любого источника падает с расстоянием по формуле обратной зависимости:
`Influence = Power / (1 + Distance * Falloff)`

*   **Power:** Мощность источника (например, 1.2 для Якоря).
*   **Distance:** Расстояние Чебышева (`max(|x1-x2|, |y1-y2|)`), что идеально подходит для квадратной сетки.
*   **Falloff:** Коэффициент затухания (насколько быстро слабеет сигнал).

### Расчет Threat Value
`Total Threat = (Sum(Anchor_Influences) - Shield_Stability)`
Результат нормализуется в диапазоне `[0.0, 1.0]`.

---

## 3. Логика Защиты Хаба (The Shield)

Регион D4 (Центральный Город) имеет особую логику защиты, чтобы обеспечить безопасную зону для новичков.

1.  **Глобальное подавление:** Внутри радиуса города (`CITY_RADIUS = 7`) итоговая угроза принудительно умножается на коэффициент `0.25`. Это гарантирует, что даже мощные Якоря не создадут здесь смертельных зон.
2.  **Зонирование внутри стен:**
    *   **Центр (Радиус 0-4):** Абсолютная безопасность. `Shield Modifier = 0.0`. Никакие аномальные теги не генерируются.
    *   **Окраины (Радиус 5-7):** `Shield Modifier = 0.2`. Пропускается лишь малая часть "флейвора" (например, легкий иней на стенах), но без реальной опасности.

---

## 4. Уровни Угрозы (Threat Tiers)

Числовое значение `threat_val` (0.0 - 1.0) конвертируется в дискретный **Tier** (0-7), который определяет сложность контента и спавн мобов.

| Threat Val | Tier | Описание |
| :--- | :--- | :--- |
| < 0.05 | **0** | **Safe Zone.** Полная безопасность. |
| < 0.20 | **1** | **Low Risk.** Тревожная атмосфера, слабые мобы. |
| < 0.35 | **2** | **Moderate.** Стандартная сложность для прокачки. |
| < 0.55 | **3** | **High.** Опасно для одиночек. |
| < 0.75 | **4** | **Extreme.** Нужна группа и подготовка. |
| < 0.90 | **5** | **Nightmare.** Эпицентры аномалий. |
| < 0.98 | **6** | **Hell.** Преддверие Якоря. |
| >= 0.98 | **7** | **Absolute.** Смерть без спец. защиты. |

---

## 5. Генерация Нарративных Тегов

Сервис не просто выдает число, он возвращает список тегов (`narrative_tags`), описывающих окружение для LLM.

1.  **Определение Доминанты:** Выбирается Якорь с самым сильным влиянием в данной точке (например, "Лед").
2.  **Градиент:** На основе Тира (Tier) из конфига выбираются соответствующие теги.
    *   *Tier 1 (Лед):* "frost", "cold_wind".
    *   *Tier 7 (Лед):* "absolute_zero", "time_stasis".
3.  **Гибридные Зоны:** Возникают в диагональных секторах карты, где пересекаются влияния двух Якорей (например, Северного и Западного).
    *   **Условие:** Вторая стихия должна быть достаточно сильной (`> 70%` от первой).
    *   **Результат:** Система добавляет уникальные теги из `HYBRID_TAGS` (например, "thermal_shock", "steam_fog").
