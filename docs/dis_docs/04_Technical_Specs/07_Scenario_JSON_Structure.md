# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –°—Ü–µ–Ω–∞—Ä–∏–µ–≤ (Quest Engine)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤. –ö–∞–∂–¥—ã–π –∫–≤–µ—Å—Ç —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º JSON-—Ñ–∞–π–ª–µ, —Å–æ–¥–µ—Ä–∂–∞—â–µ–º –¥–≤–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–µ–∫—Ü–∏–∏: `master` (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) –∏ `nodes` (—Å–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω).

---

## 1. –¢–∞–±–ª–∏—Ü–∞ A: ScenarioMaster (–®–∞–ø–∫–∞ –∫–≤–µ—Å—Ç–∞)

–û–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –≤—Ö–æ–¥–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–∏ –∏ –≤—ã—Ö–æ–¥–∞ (—ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–∞–≥—Ä–∞–¥—ã).

### –ü—Ä–∏–º–µ—Ä JSON
```json
{
  "quest_key": "awakening_rift",
  "start_node_id": "start_platform_01",
  "init_sync": {
    "method": "snapshot_ac",
    "key": "ac:{char_id}",
    "inject_fields": {
      "w_stats": {
        "strength": 0, "agility": 0, "endurance": 0, 
        "intelligence": 0, "wisdom": 0, "men": 0, 
        "perception": 0, "charisma": 0, "luck": 0
      },
      "t_elements": {
        "fire": 0, "water": 0, "earth": 0, "air": 0, 
        "dark": 0, "arcane": 0, "light": 0, "nature": 0
      },
      "loot_queue": [],
      "skills_queue": []
    }
  },
  "export_sync": {
    "method": "finalize_rift",
    "mapping": "standard_array",
    "materialize": "loot_queue",
    "skills": "skills_queue",
    "finalize_logic": {
      "spawn_offset": "d4",
      "center": [52, 52]
    }
  },
  "status_bar_fields": [
    {"key": "hp_current", "label": "‚ù§Ô∏è"},
    {"key": "step_counter", "label": "üë£"}
  ]
}
```

### –ü–æ–ª—è
*   **`quest_key`**: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–≤–µ—Å—Ç–∞.
*   **`start_node_id`**: ID –ø–µ—Ä–≤–æ–π —Å—Ü–µ–Ω—ã.
*   **`init_sync`**: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è `ScenarioManager` –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.
    *   `method`: –ú–µ—Ç–æ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `snapshot_ac` –∫–æ–ø–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞).
    *   `inject_fields`: –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `w_stats` –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –±–∏–ª–¥–∞).
*   **`export_sync`**: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∫–≤–µ—Å—Ç–∞.
    *   `method`: –ú–µ—Ç–æ–¥ —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `finalize_rift`).
    *   `mapping`: –õ–æ–≥–∏–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω—ã–µ.
    *   `materialize`: –ö–∞–∫—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å –≤ –ø—Ä–µ–¥–º–µ—Ç—ã.

---

## 2. –¢–∞–±–ª–∏—Ü–∞ B: ScenarioNode (–ö–æ–Ω—Ç–µ–Ω—Ç)

–ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –≤ –º–∞—Å—Å–∏–≤–µ `nodes` ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ü–µ–Ω–∞ (—ç–∫—Ä–∞–Ω) —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –∫–Ω–æ–ø–∫–∞–º–∏.

### –ü—Ä–∏–º–µ—Ä 1: –û–±—ã—á–Ω–∞—è —Å—Ü–µ–Ω–∞
```json
{
  "node_key": "start_platform_01",
  "quest_key": "awakening_rift",
  "text_content": "–ü—Ä–∏—á–∞–ª—å–Ω—ã–π –£–∑–µ–ª [52:52]. –í–æ–∫—Ä—É–≥ –ª–∏—à—å –≥—É–ª –ø–æ—Ä—Ç–∞–ª–æ–≤. –ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –û—Ü–µ–Ω—â–∏–∫.\n\n‚Äî –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–ª–∞–±–∞—è. –ü—Ä–∏–¥–µ—Ç—Å—è –∫–∞–ª–∏–±—Ä–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é.",
  "actions_logic": {
    "next": {
      "label": "‚Äî –ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç?",
      "to_node": "crash_sequence_02",
      "math": { "w_stats.wisdom": "+1" }
    }
  }
}
```

### –ü—Ä–∏–º–µ—Ä 2: –í—ã–±–æ—Ä —Å –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º–∏
```json
{
  "node_key": "rift_event_fire_01",
  "quest_key": "awakening_rift",
  "text_content": "–û—Å–∫–æ–ª–æ–∫ –ø—ã–ª–∞–µ—Ç. –ü—É—Ç—å –ø—Ä–µ–≥—Ä–∞–∂–¥–∞–µ—Ç –æ–≥–Ω–µ–Ω–Ω–∞—è —Å—Ç–µ–Ω–∞.",
  "actions_logic": {
    "power": {
      "label": "[–°–ò–õ–ê] –ü—Ä–æ–π—Ç–∏ –Ω–∞—Å–∫–≤–æ–∑—å",
      "to_node": "next_step",
      "math": { 
        "w_stats.strength": "+2", 
        "t_elements.fire": "+1" 
      }
    }
  }
}
```

### –ü—Ä–∏–º–µ—Ä 3: –õ–æ–≥–∏—á–µ—Å–∫–∏–π –∑–∞—Ç–≤–æ—Ä (Logic Gate)
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –±–µ–∑ —É—á–∞—Å—Ç–∏—è –∏–≥—Ä–æ–∫–∞, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ —É—Å–ª–æ–≤–∏—è—Ö.

```json
{
  "node_key": "reward_logic_04",
  "quest_key": "awakening_rift",
  "text_content": "–Ø–∫–æ—Ä—å —Ä–µ–∑–æ–Ω–∏—Ä—É–µ—Ç...",
  "actions_logic": {
    "auto": {
      "type": "logic_gate",
      "branching": [
        {
          "condition": "w_stats.strength >= w_stats.agility",
          "math": { "loot_queue": "push:sword_common" },
          "to_node": "rift_step_5"
        },
        {
          "condition": "default",
          "math": { "loot_queue": "push:dagger_common" },
          "to_node": "rift_step_5"
        }
      ]
    }
  }
}
```

---

## 3. –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã –î–≤–∏–∂–∫–∞

### Init / Export
*   **`snapshot_ac`**: –î–µ–ª–∞–µ—Ç –ø–æ–ª–Ω—É—é –∫–æ–ø–∏—é `ac:{id}` –∏–∑ Redis –≤ —Å–µ—Å—Å–∏—é —Å—Ü–µ–Ω–∞—Ä–∏—è (`scen:session:{id}`).
*   **`finalize_rift`**: –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Ç—É—Ç–æ—Ä–∏–∞–ª–∞. –ë–µ—Ä–µ—Ç `w_stats`, —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –∏—Ö –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –º–∞—Å—Å–∏–≤—É D&D (15, 14, 13...), –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.
*   **`materialize`**: –ë–µ—Ä–µ—Ç —Å–ø–∏—Å–æ–∫ ID –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `loot_queue`) –∏ —Å–æ–∑–¥–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `items`.

### Director (–ù–∞–≤–∏–≥–∞—Ü–∏—è)
*   **`logic_gate`**: –¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏. –î–≤–∏–∂–æ–∫ —Å–∞–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏—è –≤ `branching` —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ –ø–µ—Ä–≤–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é.
*   **`pool:tag`**: –ï—Å–ª–∏ `to_node` –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `pool:`, –î–∏—Ä–µ–∫—Ç–æ—Ä –∏—â–µ—Ç –≤—Å–µ –Ω–æ–¥—ã —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Ç–µ–≥–æ–º –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –æ–¥–Ω—É —Å–ª—É—á–∞–π–Ω–æ (–∏–ª–∏ –ø–æ –≤–µ—Å—É).
