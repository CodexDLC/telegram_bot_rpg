# 06. Monster System, Group Dynamics & Loot

## 1. Концепция (High Concept)

Монстры в игре — это процедурно генерируемые сущности, объединенные в группы (Кланы).
Система перешла от статических JSON-файлов к динамическим Python-классам с строгой типизацией (Pydantic), что обеспечивает валидацию данных на этапе запуска.

**Ключевые принципы:**
1.  **Code as Data:** Конфигурация монстров пишется на Python.
2.  **Clan-Based:** Монстры существуют и спавнятся группами (Кланами).
3.  **Deterministic Hashing:** Уникальность клана определяется хешем его состава и параметров.

---

## 2. Архитектура Данных (Data Structure)

### 2.1 Исходный код (Source of Truth)

Данные хранятся в `apps/game_core/resources/game_data/monsters/families/`.
Каждое семейство (Family) — это Python-файл, описывающий виды (Species).

**Иерархия классов (`monster_structs.py`):**

1.  **MonsterFamily (Семейство):**
    *   Группирует монстров по тематике (например, `Orcs`, `Undead`).
    *   Содержит список видов (`species`).
    *   Определяет базовые правила спавна.

2.  **MonsterSpecies (Вид):**
    *   Конкретный тип монстра (например, `Orc Grunt`, `Orc Shaman`).
    *   `base_stats`: Базовые характеристики (Strength, Agility и т.д.).
    *   `loadout_options`: Варианты экипировки (Main Hand, Armor).
    *   `tier_range`: Допустимый диапазон тиров.
    *   `roles`: Роли в бою (Tank, DPS, Support).

**Пример структуры (Python):**

```python
orcs_family = MonsterFamily(
    id="orcs",
    name="Orc Horde",
    species=[
        MonsterSpecies(
            id="orc_grunt",
            base_stats=MonsterStats(strength=12, ...),
            loadout_options=LoadoutOptions(main_hand=["rusty_axe", "club"]),
            ...
        )
    ]
)
```

### 2.2 Runtime Модели (DTO)

Во время работы игры используются DTO объекты (`monster_dto.py`), которые представляют конкретные экземпляры:

*   **MonsterUnit:** Единичный монстр с уже выбранной экипировкой, рассчитанными статами и уникальным ID.
*   **MonsterClan:** Группа монстров. Содержит лидера, миньонов, общий уровень угрозы и хеш.

---

## 3. Пайплайн: Генерация Кланов (Clan Factory)

Процесс создания врагов управляется `ClanFactory` (`apps/game_core/game_service/monster/clan_factory.py`).

### Шаг 1: Выбор Шаблона
На основе зоны и уровня сложности выбирается подходящее `MonsterFamily`.

### Шаг 2: Формирование Состава
Фабрика определяет состав клана:
1.  **Лидер:** Выбирается сильный вид (Elite/Boss).
2.  **Свита:** Набираются обычные виды (Minions) до заполнения бюджета "Угрозы" (Threat Rating) или лимита численности.

### Шаг 3: Конкретизация (Instantiation)
Для каждого монстра в клане:
*   Выбирается конкретная экипировка из `loadout_options`.
*   Применяется скалирование по Тиру (Tier Multiplier).
*   Рассчитываются финальные статы (HP, Damage).

### Шаг 4: Хеширование (Hashing)
Генерируется уникальный `clan_hash` (`clan_hashing.py`).
Хеш зависит от: *Seed зоны + Состава монстров + Тира + Экипировки*.
Это позволяет идемпотентно восстанавливать клан или проверять его целостность.

---

## 4. Хранение (Persistence)

Вместо хранения каждого монстра отдельно, мы храним **Кланы**.

**Таблица БД:** `clans` (ORM модель `monster.py`)

| Field | Type | Description |
|---|---|---|
| `id` | UUID | Уникальный ID записи в БД |
| `clan_hash` | String | Уникальный хеш конфигурации клана |
| `tier` | Integer | Уровень силы клана |
| `location_id` | String | Привязка к локации на карте |
| `units_data` | JSONB | Полный дамп всех монстров в клане (статы, лут, экипировка) |
| `is_active` | Boolean | Жив ли клан |
| `created_at` | Timestamp | Время спавна |

**Преимущества:**
*   Меньше записей в БД (1 запись на группу, а не 5-10).
*   Атомарность (клан либо есть, либо его нет).

---

## 5. Валидация и Инструменты

Для обеспечения целостности данных используются специальные инструменты:

1.  **Скрипты валидации (`scripts/validate_gamedata.py`):**
    *   Проверяют, что все ссылки на предметы в `loadout_options` существуют.
    *   Проверяют корректность распределения статов.
    *   Гарантируют, что монстры могут быть успешно инстанцированы.

2.  **Admin Dashboard (`tools/admin_dashboard`):**
    *   **Bestiary:** Визуальный просмотр всех семейств и видов.
    *   **Active Clans:** Мониторинг заспавненных кланов в реальном времени.
    *   **World Map:** Отображение распределения монстров по зонам.

---

## 6. Система Лута (Loot)

*(Раздел в разработке, базируется на `MonsterUnit`)*

Лут генерируется на основе экипировки монстра (`equipped_items`).
При смерти монстра:
1.  Проверяется шанс выпадения для каждого надетого предмета.
2.  Если предмет выпадает, он конвертируется в предмет для игрока (Item DTO).
3.  Материал и качество предмета зависят от Тира монстра.
