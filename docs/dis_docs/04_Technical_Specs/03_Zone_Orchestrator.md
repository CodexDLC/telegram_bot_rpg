# ТЕХНИЧЕСКАЯ СПЕЦИФИКАЦИЯ: ZONE ORCHESTRATOR

**Сервис:** `apps/game_core/game_service/world/zone_orchestrator.py`
**Зависимости:** `ContentGenerationService`, `ThreatService`, `WorldRepo`

---

## 1. Назначение

`ZoneOrchestrator` — это "режиссер" процедурной генерации. Его задача — превратить сухие данные из БД (координаты, ID биома) в богатый контекст для LLM, чтобы получить живое и логичное описание локации.

Он работает не с одной клеткой, а с **Чанком (Chunk)** размером 5x5, чтобы обеспечить связность повествования.

---

## 2. Алгоритм Работы (Pipeline)

Процесс генерации запускается для центральной точки зоны (например, при первом входе игрока).

### Шаг 1: Выборка Данных
Оркестратор запрашивает у Репозитория все клетки в квадрате 5x5 (плюс буферная зона для анализа соседей).

### Шаг 2: Анализ Клетки (Tag Assembly)
Для каждой клетки `(x, y)` собирается набор тегов:
1.  **Базовые теги:** Из конфига биома (напр. `dense_trees`, `mud`).
2.  **Структурные теги:** Определяются положением в чанке (`_center`, `_edge`, `deep_`).
3.  **Теги Влияния:** Запрашиваются у `ThreatService` (напр. `frost`, `low_gravity`).
4.  **Дороги:** Если рядом есть дорога, добавляется тег `road`.

### Шаг 3: Сбор Контекста (The "Senses")
Чтобы описание не существовало в вакууме, Оркестратор "осматривается" вокруг.

*   **Локальный контекст (`_scan_surroundings`):**
    Проверяет 8 соседних клеток. Если там есть **Визуальные Доминанты** (Гора, Башня, Стена), добавляет подсказку: *"На севере виднеется Стена"*.
*   **Глобальный контекст (`_scan_global_landmarks`):**
    Рассчитывает расстояние до ключевых точек мира (Хаб, Якоря). Если они ближе 35 клеток, добавляет подсказку: *"Вдалеке на востоке сияет Ледяной Пик"*.

### Шаг 4: Генерация (LLM Request)
Собранные данные упаковываются в JSON и отправляются в `ContentGenerationService`.
*   **Режим:** `batch_location_desc`
*   **Вход:** Список объектов `{"id": "x_y", "tags": [...], "context": [...]}`

### Шаг 5: Сохранение
Полученный от LLM JSON с описаниями (`title`, `description`) парсится и сохраняется в БД. Клетка помечается как `is_active = True`.

---

## 3. Особенности Реализации

### "Умные" Подсказки
Система не просто перечисляет все подряд. Используется словарь `VISUAL_DOMINANTS` (в `world_config.py`), чтобы фильтровать только значимые объекты для контекста. Обычное "дерево" не попадет в контекст соседа, а "Гигантское Древо" — попадет.

### Обработка Ошибок
Если LLM вернет битый JSON или пропустит клетку, Оркестратор залогирует ошибку, но не уронит процесс. "Битые" клетки останутся со старым описанием (или дефолтным), чтобы не блокировать игру.
