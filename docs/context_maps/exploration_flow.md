# Exploration Flow Context Map

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –º–∏—Ä–∞ (Exploration).

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### 1. Handlers (–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π)
*   `apps/bot/handlers/callback/game/navigation.py`
    *   **–†–æ–ª—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–æ –∫–∞—Ä—Ç–µ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –æ–±—ä–µ–∫—Ç–∞–º–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.
    *   **–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:** `navigation_move_handler` (–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π), `navigation_service_handler` (–≤—Ö–æ–¥ –≤ —Å–µ—Ä–≤–∏—Å—ã/—Ö–∞–±—ã), `navigation_action_stub` (–∑–∞–≥–ª—É—à–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π).
*   `apps/bot/handlers/callback/game/exploration/encounter_handlers.py`
    *   **–†–æ–ª—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (—ç–Ω–∫–∞—É–Ω—Ç–µ—Ä–æ–≤).
    *   **–ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:** `handle_encounter_action` (–∞—Ç–∞–∫–∞, –æ–±—Ö–æ–¥, –æ—Å–º–æ—Ç—Ä).

### 2. UI Layer (–ë–æ—Ç)
*   `apps/bot/ui_service/exploration/exploration_ui.py`
    *   **–†–æ–ª—å:** –ì–ª–∞–≤–Ω—ã–π UI-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π.
    *   **–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:** `move_character`, `render_map`.
*   `apps/bot/ui_service/exploration/navigation_ui.py`
    *   **–†–æ–ª—å:** –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —ç–∫—Ä–∞–Ω–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (—Ç–µ–∫—Å—Ç –ª–æ–∫–∞—Ü–∏–∏ + –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è).
*   `apps/bot/ui_service/exploration/encounter_ui.py`
    *   **–†–æ–ª—å:** –û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —ç–∫—Ä–∞–Ω–æ–≤ —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π (–±–æ–∏, –Ω–∞—Ö–æ–¥–∫–∏, –¥–∏–∞–ª–æ–≥–∏).

### 3. Client Layer
*   `apps/bot/core_client/exploration.py` (`ExplorationClient`)
    *   **–†–æ–ª—å:** –ê–¥–∞–ø—Ç–µ—Ä –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å —è–¥—Ä–æ–º.
    *   **–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã:** `move`, `get_current_location`.

### 4. Game Core (–Ø–¥—Ä–æ)
*   `apps/game_core/game_service/exploration/exploration_orchestrator.py` (–ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —Ñ–∞–π–ª)
    *   **–†–æ–ª—å:** –§–∞—Å–∞–¥ –ª–æ–≥–∏–∫–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —à–∞–Ω—Å—ã –Ω–∞ —ç–Ω–∫–∞—É–Ω—Ç–µ—Ä, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

### 5. DTOs
*   `apps/common/schemas_dto/exploration_dto.py`
    *   `WorldNavigationDTO`: –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞—Ä—Ç—ã (–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, –≤—ã—Ö–æ–¥—ã, –æ–±—ä–µ–∫—Ç—ã).
    *   `EncounterDTO`: –î–∞–Ω–Ω—ã–µ –æ —Å–æ–±—ã—Ç–∏–∏ (—Ç–∏–ø, –æ–ø–∏—Å–∞–Ω–∏–µ, –≤—Ä–∞–≥–∏).

---

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö: –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ (Move)

1.  **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°–µ–≤–µ—Ä") -> `navigation.py` (`navigation_move_handler`).
2.  **Handler**:
    *   –ó–∞–ø—É—Å–∫–∞–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (UIAnimationService).
    *   –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç `ExplorationUIService.move_character`.
3.  **UI Service** –≤—ã–∑—ã–≤–∞–µ—Ç `client.move`.
4.  **Core Orchestrator**:
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ—Ö–æ–¥–∞.
    *   –í—ã—á–∏—Å–ª—è–µ—Ç —à–∞–Ω—Å —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è (Encounter).
    *   –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `EncounterDTO`.
    *   –ï—Å–ª–∏ —á–∏—Å—Ç–æ: –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `WorldNavigationDTO` –Ω–æ–≤–æ–π –ª–æ–∫–∞—Ü–∏–∏.
5.  **UI Service**:
    *   –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª `EncounterDTO` -> –≤—ã–∑—ã–≤–∞–µ—Ç `EncounterUI` (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Ä–∞–≥–∞/—Å—É–Ω–¥—É–∫).
    *   –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª `WorldNavigationDTO` -> –≤—ã–∑—ã–≤–∞–µ—Ç `NavigationUI` (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é –∫–∞—Ä—Ç—É).
6.  **Handler** –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö: –≠–Ω–∫–∞—É–Ω—Ç–µ—Ä (Encounter)

1.  **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å** –≤–∏–¥–∏—Ç —ç–∫—Ä–∞–Ω —ç–Ω–∫–∞—É–Ω—Ç–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–í—Ä–∞–≥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω") –∏ –Ω–∞–∂–∏–º–∞–µ—Ç "–ê—Ç–∞–∫–æ–≤–∞—Ç—å" -> `encounter_handlers.py` (`handle_encounter_action`).
2.  **Handler**:
    *   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –±–æ–µ–≤—É—é —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ `CombatBotOrchestrator.start_new_battle`.
    *   –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM –Ω–∞ `InGame.combat`.
    *   –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω –±–æ—è.
