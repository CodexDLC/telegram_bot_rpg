# Задача: Реализация Lazy Loading и Стандартизация Схемы Redis

**Приоритет:** Критический
**Компоненты:** Core, Redis, Data Layer
**Статус:** К выполнению

## 1. Описание

Эта задача подразумевает фундаментальный рефакторинг слоя доступа к данным для реализации стратегии "Ленивой загрузки" (Lazy Loading) с откатом к БД (DB Fallback). Это унифицирует получение данных, повысит производительность и увеличит устойчивость системы к промахам кэша Redis или истечению TTL.

Кроме того, необходимо стандартизировать структуру основного хэша аккаунта `ac:{char_id}` в Redis, чтобы обеспечить согласованный маппинг данных во всех сервисах, особенно для Движка Сценариев (Scenario Engine).

## 2. Технические требования

### 2.1. Стратегия "Ленивой загрузки" (Lazy Loading)

Все менеджеры данных (`AccountManager`, `StatsManager` и др.), взаимодействующие с хэшем `ac:{char_id}`, должны быть обновлены в соответствии со следующим паттерном:

1.  **Сначала проверка Redis:** Когда сервис запрашивает данные (например, `get_stats(char_id)`), менеджер должен сначала попытаться прочитать соответствующее поле (например, `stats`) из хэша `ac:{char_id}` в Redis.

2.  **Откат к БД при промахе кэша (DB Fallback):**
    *   Если поле равно `nil` или весь ключ `ac:{char_id}` не существует, это считается промахом кэша.
    *   Менеджер должен инициировать вызов соответствующего сервиса базы данных (например, `CharacterStatsRepo`), чтобы получить данные из PostgreSQL.

3.  **Восстановление кэша:**
    *   Данные, полученные из базы данных, должны быть немедленно записаны обратно в хэш `ac:{char_id}` в Redis, восстанавливая кэш для последующих запросов.
    *   Данные должны храниться в стандартизированном формате (JSON).

4.  **Возврат данных:** Данные (из Redis или БД) возвращаются вызывающей функции.

### 2.2. Стандартизированная схема Redis `ac:{char_id}`

Для обеспечения универсального маппинга, особенно для процесса `init_sync` Движка Сценариев, хэш `ac:{char_id}` должен содержать следующие стандартизированные поля:

| Поле | Тип | Описание |
| :--- | :--- | :--- |
| **state** | `String` | Текущий режим персонажа (`world`, `scenario`, `combat`). |
| **location_id** | `String` | ID текущей локации персонажа. |
| **prev_state** | `String` | Предыдущее состояние (для возврата из меню/сценариев). |
| **prev_location_id** | `String` | ID предыдущей локации. |
| **hp_current** | `Integer` | Текущее здоровье. |
| **energy_current** | `Integer` | Текущая энергия. |
| **last_update** | `Float` | Timestamp последнего обновления (для регенерации). |
| **gear_score** | `Integer` | Расчетный уровень снаряжения. |
| **bio** | `JSON` | Базовая информация о персонаже (имя, пол). |
| **stats** | `JSON` | Все характеристики персонажа. |
| **equipment** | `JSON` | Список ID надетых предметов. |
| **combat_session_id** | `String` | UUID активной сессии боя. |
| **scenario_session_id** | `String` | UUID активной сессии сценария. |

## 3. План действий

1.  **Анализ `AccountManager`:** Проанализировать `AccountManager` и другие менеджеры данных, чтобы выявить все методы, читающие из `ac:{char_id}`.
2.  **Реализация логики Fallback:** Для каждого выявленного метода реализовать логику "DB Fallback" и "Восстановление кэша".
3.  **Рефакторинг сервисов:** Убедиться, что сервисы, такие как `LoginService`, `StatusCoreOrchestrator` и `ScenarioCoreOrchestrator`, полагаются на эти обновленные методы менеджеров и корректно обрабатывают небольшую задержку при промахе кэша.
4.  **Стандартизация записи данных:** Обновить все части кода, которые пишут в `ac:{char_id}` (создание персонажа, повышение уровня, смена экипировки), чтобы использовать новую стандартизированную JSON-структуру для `bio`, `stats` и `equipment`.
5.  **Тестирование:** Создать интеграционные тесты для проверки:
    *   Корректного получения данных, когда Redis заполнен.
    *   Корректного отката к БД и восстановления кэша при ручном удалении ключа Redis.
    *   Стабильности системы во время процесса восстановления.

## 4. Критерии приемки

*   Система корректно получает данные персонажа даже после полной очистки Redis.
*   Ключ `ac:{char_id}` в Redis последовательно соблюдает документированную схему.
*   Метод `initialize_scenario` Движка Сценариев может надежно синхронизировать данные, используя стандартизированные поля.
*   Существующий функционал (логин, просмотр статуса и т.д.) не нарушен.
