# üß≠ Exploration & Encounters System (Design Document)

> **Status:** Draft
> **Focus:** –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –º–µ–∂–¥—É –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ–º –º–∏—Ä–∞ –∏ –±–æ–µ–≤—ã–º–∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è–º–∏.

## 1. –ü—Ä–æ–±–ª–µ–º–∞ –∏ –†–µ—à–µ–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞
–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∏–º–µ–µ—Ç —Ä–∏—Å–∫ –Ω–∞—Ä—É—à–µ–Ω–∏—è **Single Responsibility Principle**:
1.  –ï—Å–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤ —Ö—ç–Ω–¥–ª–µ—Ä–∞—Ö (`apps/bot/handlers/...`), –∫–æ–¥ —Å—Ç–∞–Ω–µ—Ç –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º–∏ `if/else`.
2.  –ï—Å–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –ª–æ–≥–∏–∫—É —à–∞–Ω—Å–æ–≤ –≤ `NavigationService`, –æ–Ω –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Å—Ç–æ "–¥–≤–∏–≥–∞—Ç–µ–ª–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç" –∏ –Ω–∞—á–Ω–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –∑–∞ –∏–≥—Ä–æ–≤—É—é –º–µ—Ö–∞–Ω–∏–∫—É (–±—Ä–æ—Å–∫–∏ –∫—É–±–∏–∫–æ–≤), —á—Ç–æ –Ω–µ–≤–µ—Ä–Ω–æ.

### –†–µ—à–µ–Ω–∏–µ: ExplorationOrchestrator
–í–≤–æ–¥–∏—Ç—Å—è –Ω–æ–≤—ã–π —Å–ª–æ–π ‚Äî **ExplorationOrchestrator** (–∏–ª–∏ Facade). –û–Ω –≤—ã—Å—Ç—É–ø–∞–µ—Ç –≤ —Ä–æ–ª–∏ "–†–µ–≥—É–ª–∏—Ä–æ–≤—â–∏–∫–∞".
–ï–≥–æ –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–∏–Ω—è—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ (Intent) –∏ —Ä–µ—à–∏—Ç—å, —á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç, –¥–µ–ª–µ–≥–∏—Ä—É—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—å–Ω—ã–º —Å–µ—Ä–≤–∏—Å–∞–º.

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ü–æ—Ç–æ–∫ –î–∞–Ω–Ω—ã—Ö

–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –µ–¥–∏–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è –ª—é–±—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –º–∏—Ä–µ (–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ, –æ—Å–º–æ—Ç—Ä, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ).

### –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

```mermaid
graph TD
    User[User / Handler] -->|Intent: Move North| Orch[ExplorationOrchestrator]
    
    Orch -->|Check Chance| EncService[EncounterService]
    
    EncService -->|Result?| Decision{Decision}
    
    Decision -- Success (Peace) --> Nav[NavigationService]
    Nav -->|Move & Save| DB[(Database)]
    Nav -->|Return MapDTO| Orch
    
    Decision -- Fail (Combat/Event) --> Combat[CombatManager]
    Combat -->|Init Session| Redis[(Redis)]
    Combat -->|Return FightIntroDTO| Orch
    
    Orch -->|Response| UI[User Interface]
```

### –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞
1.  **User -> Handler:** –ò–≥—Ä–æ–∫ –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è.
2.  **Handler -> Orchestrator:** –í—ã–∑–æ–≤ `handle_move(direction)`.
3.  **Orchestrator -> EncounterService:** –ó–∞–ø—Ä–æ—Å: ¬´–ò–≥—Ä–æ–∫ —à–∞–≥–Ω—É–ª –≤ –∑–æ–Ω—É —Å Tier X, –µ—Å—Ç—å –ª–∏ –≤—Å—Ç—Ä–µ—á–∞?¬ª.
    *   *–í–∞–∂–Ω–æ:* –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ —Å—á–∏—Ç–∞–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏–∫—É —Å–∞–º.
4.  **EncounterService:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç (None, Combat, Ambush, Narrative).
5.  **–í–µ—Ç–≤–ª–µ–Ω–∏–µ:**
    *   **–í–∞—Ä–∏–∞–Ω—Ç –ê (–ü—É—Å—Ç–æ):** –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç `NavigationService.move()`. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–∞—Ä—Ç—É.
    *   **–í–∞—Ä–∏–∞–Ω—Ç –ë (–í—Å—Ç—Ä–µ—á–∞):** –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç `CombatManager.create_fight()`. –ü–µ—Ä–µ–≤–æ–¥–∏—Ç FSM –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—è. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–∫—Ä–∞–Ω –ø—Ä–µ–≤—å—é –±–æ—è.

---

## 3. –ö–ª—é—á–µ–≤—ã–µ –ê—Å–ø–µ–∫—Ç—ã –†–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 3.1 –†–æ–ª—å ExplorationOrchestrator
*   **–ü—Ä–∏–Ω–∏–º–∞–µ—Ç:** `user_id`, `action_type` (move, interact), `params`.
*   **–ö–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç:** –í—ã–∑—ã–≤–∞–µ—Ç `ThreatService` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, `EncounterService` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–¥–∞—á–∏, `NavigationService` –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –¥–≤–∏–∂–µ–Ω–∏—è.
*   **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç (DTO), –∫–æ—Ç–æ—Ä—ã–π –≥–æ–≤–æ—Ä–∏—Ç UI, —á—Ç–æ —Ä–∏—Å–æ–≤–∞—Ç—å (–ö–∞—Ä—Ç—É –∏–ª–∏ –≠–∫—Ä–∞–Ω –ë–æ—è).

### 3.2 –†–æ–ª—å EncounterService
*   **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ß–∏—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏ RNG.
*   **–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** `Threat Tier` –∑–æ–Ω—ã, —É–¥–∞—á–∞ –∏–≥—Ä–æ–∫–∞, –∞–∫—Ç–∏–≤–Ω—ã–µ –±–∞—Ñ—Ñ—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–°—Ç–µ–ª—Å").
*   **–õ–æ–≥–∏–∫–∞:**
    *   –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —à–∞–Ω—Å –≤—Å—Ç—Ä–µ—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15% –Ω–∞ —à–∞–≥).
    *   –ï—Å–ª–∏ —É—Å–ø–µ—Ö ‚Äî –≤—ã–±–∏—Ä–∞–µ—Ç —Ç–∏–ø –≤—Å—Ç—Ä–µ—á–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –ª—É—Ç–∞/–º–æ–±–æ–≤ (`spawn_config`).
*   **–í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:** –û–±—ä–µ–∫—Ç `Encounter` (—Ç–∏–ø, ID –º–æ–±–∞/—Å–æ–±—ã—Ç–∏—è) –∏–ª–∏ `None`.

---

## 4. –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ –¢–∏–ø—ã –í—Å—Ç—Ä–µ—á (Draft)
1.  **Combat (–ë–æ–π):** –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±–æ–π.
2.  **Ambush (–ó–∞—Å–∞–¥–∞):** –ë–æ–π, –≥–¥–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫ —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º (—à—Ç—Ä–∞—Ñ –∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ).
3.  **Narrative (–ù–∞—Ö–æ–¥–∫–∞):** –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ (—Å—É–Ω–¥—É–∫, —Ç—Ä—É–ø, –∞–ª—Ç–∞—Ä—å) —Å –≤—ã–±–æ—Ä–æ–º –¥–µ–π—Å—Ç–≤–∏–π.

---

## 5. –ú–µ—Ö–∞–Ω–∏–∫–∞ "–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ" (Detection) [Nice-to-Have]

> **–ò–¥–µ—è:** –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç—å —Ä–∞–Ω–¥–æ–º —ç–Ω–∫–∞—É–Ω—Ç–µ—Ä–æ–≤ –≤ –º–µ—Ö–∞–Ω–∏–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∏–∏ —á–µ—Ä–µ–∑ –Ω–∞–≤—ã–∫ "–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ".

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
1.  **–¢—Ä–∏–≥–≥–µ—Ä:** –ò–≥—Ä–æ–∫ "–≤—ã–±–∏–≤–∞–µ—Ç" —ç–Ω–∫–∞—É–Ω—Ç–µ—Ä –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏.
2.  **–ü—Ä–æ–≤–µ—Ä–∫–∞:** `EncounterService` —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç `Stealth` –º–æ–±–∞ –∏ `Detection` –∏–≥—Ä–æ–∫–∞.

### –°—Ü–µ–Ω–∞—Ä–∏–∏
*   **–ü—Ä–æ–≤–∞–ª (Low Skill) -> –°—Ç–∞—Ç—É—Å `AMBUSH`**
    *   **UI:** –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥ –≤ —ç–∫—Ä–∞–Ω –±–æ—è.
    *   **–≠—Ñ—Ñ–µ–∫—Ç:** –ò–≥—Ä–æ–∫ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –ø–µ—Ä–≤—ã–π —Ö–æ–¥ –∏–ª–∏ –ø–æ–ª—É—á–∞–µ—Ç —à—Ç—Ä–∞—Ñ –∫ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ.
    *   **–¢–µ–∫—Å—Ç:** "–í–Ω–µ–∑–∞–ø–Ω–æ –∏–∑ —Ç–µ–Ω–∏ –ø—Ä—ã–≥–∞–µ—Ç —Ç–≤–∞—Ä—å! –í—ã –∑–∞—Å—Ç–∏–≥–Ω—É—Ç—ã –≤—Ä–∞—Å–ø–ª–æ—Ö."

*   **–£—Å–ø–µ—Ö (High Skill) -> –°—Ç–∞—Ç—É—Å `DETECTED`**
    *   **UI:** –û—Å—Ç–∞–µ—Ç—Å—è —ç–∫—Ä–∞–Ω –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –Ω–æ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º.
    *   **–¢–µ–∫—Å—Ç:** "–í—ã —Å–ª—ã—à–∏—Ç–µ —à–æ—Ä–æ—Ö –≤–ø–µ—Ä–µ–¥–∏. –ö—Ç–æ-—Ç–æ –∂–¥–µ—Ç –∑–∞ —É–≥–ª–æ–º."
    *   **–í—ã–±–æ—Ä –∏–≥—Ä–æ–∫–∞:**
        *   `[üõ° –û–±–æ–π—Ç–∏]` (–ü–æ–ø—ã—Ç–∫–∞ –∏–∑–±–µ–∂–∞—Ç—å –±–æ—è, –ø—Ä–æ–≤–µ—Ä–∫–∞ Stealth).
        *   `[‚öîÔ∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å]` (–ë–æ–π —Å –±–æ–Ω—É—Å–æ–º –∫ –ø–µ—Ä–≤–æ–º—É —É–¥–∞—Ä—É).

---

## 6. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ EncounterEngine (–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è)

–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –Ω–∞ –¥–≤–∞ —ç—Ç–∞–ø–∞: "–§–∞–∫—Ç –≤—Å—Ç—Ä–µ—á–∏" –∏ "–£—Å–ª–æ–≤–∏—è –≤—Å—Ç—Ä–µ—á–∏".

### 6.1 –ú–µ—Ç–æ–¥ `try_spawn_encounter`
*   **–ó–∞–¥–∞—á–∞:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –ª–∏ –≤—Å—Ç—Ä–µ—á–∞ –≤ –ø—Ä–∏–Ω—Ü–∏–ø–µ.
*   **–í—Ö–æ–¥:** `loc_data` (—Ñ–ª–∞–≥–∏ –∑–æ–Ω—ã, Tier).
*   **–õ–æ–≥–∏–∫–∞:**
    1.  **Safe Zone Check:** –ï—Å–ª–∏ `flags['safe_zone'] == True` -> `return None`.
    2.  **Chance Calc:** –ë–µ—Ä–µ–º Tier (0-7). –ß–µ–º –≤—ã—à–µ, —Ç–µ–º –≤—ã—à–µ `base_chance`.
    3.  **RNG:** –ë—Ä–æ—Å–æ–∫ `random()`.
*   **–í—ã—Ö–æ–¥:** `EncounterID` (ID –º–æ–±–∞/–ø–∞–∫–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã —Å–ø–∞–≤–Ω–∞) –∏–ª–∏ `None`.

### 6.2 –ú–µ—Ç–æ–¥ `calculate_initiative`
*   **–ó–∞–¥–∞—á–∞:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫—Ç–æ –∫–æ–≥–æ –∑–∞–º–µ—Ç–∏–ª (—Å—Ç–∞—Ç—É—Å –≤—Å—Ç—Ä–µ—á–∏).
*   **–í—Ö–æ–¥:**
    *   `user_stats`: Perception, Stealth.
    *   `mob_data`: Perception, Stealth.
*   **–õ–æ–≥–∏–∫–∞:**
    *   **Check 1 (–ò–≥—Ä–æ–∫ –≤–∏–¥–∏—Ç?):** `User.Perception` vs `Mob.Stealth`.
    *   **Check 2 (–ú–æ–± –≤–∏–¥–∏—Ç?):** `Mob.Perception` vs `User.Stealth`.
*   **–í—ã—Ö–æ–¥ (EncounterState Enum):**
    1.  **AMBUSH:** –ú–æ–± —É–≤–∏–¥–µ–ª, –ò–≥—Ä–æ–∫ –Ω–µ—Ç. -> –ë–æ–π —Å—Ä–∞–∑—É, —Å—Ç–∞–Ω –∏–≥—Ä–æ–∫–∞.
    2.  **DETECTED:** –ò–≥—Ä–æ–∫ —É–≤–∏–¥–µ–ª, –ú–æ–± –Ω–µ—Ç. -> –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ (–ù–∞–ø–∞—Å—Ç—å/–û–±–æ–π—Ç–∏).
    3.  **NORMAL:** –û–±–∞ —É–≤–∏–¥–µ–ª–∏. -> –û–±—ã—á–Ω—ã–π –±–æ–π.
    4.  **PASSING:** –ù–∏–∫—Ç–æ –Ω–µ —É–≤–∏–¥–µ–ª. -> –ù–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç (—Ä–µ–¥–∫–∏–π –∫–µ–π—Å).
