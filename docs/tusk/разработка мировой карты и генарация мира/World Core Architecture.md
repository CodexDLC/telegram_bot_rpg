# Technical Design Doc #1: World Core Architecture (The Latent World)

Версия: 2.0 (Complete Concept)

Дата: 07.12.2025

Суть: Гибридная система хранения мира с механикой "Тумана Войны" на уровне бэкенда и процедурным открытием путей.

---

## 1. Философия и Масштаб (The Concept)

### 1.1 Топология: Сектора и Узлы

Мир — это не тайловая карта (где клетка = 1 метр). Это **Граф Локаций (Points of Interest)**.

- **Макро-уровень (Сектора):** Мир поделен на сетку **7x7 секторов** (A-G по вертикали, 1-7 по горизонтали).
    
    - _D4_ — Центральный сектор (Хаб).
        
- **Микро-уровень (Ноды):** Каждый сектор состоит из **15x15 клеток**.
    
    - **Всего:** 105x105 = **11,025 уникальных локаций**.
        
- **Смысл Клетки:** Одна координата `[x:15, y:15]` — это полноценная локация (например, _"Старая Ратуша"_ или _"Поляна с Волками"_). В ней происходит геймплей.
    

### 1.2 Принцип "Латентного Мира" (The Latent World)

Мир огромен, но изначально он "спит". Мы не генерируем контент для 11 тысяч клеток сразу.

- **Матрица (Postgres):** Знает о существовании **всех** 11,025 клеток. Но для большинства из них статус `is_active = False`. Это "Туман". Там есть заготовки (ID потенциальных рифтов), но нет путей.
    
- **Сцена (Redis):** Знает **ТОЛЬКО** о тех клетках, где `is_active = True`.
    
- **Правило Навигации:** Если клетки нет в Redis — игрок физически не может получить кнопку перехода туда.
    

---

## 2. База Данных (PostgreSQL) — "Матрица"

Хранит полную структуру мира. Используется для расчетов путей (Pathfinder) и хранения состояния.

### 2.1 Таблица `world_sectors` (Config)

Статичная конфигурация 49 регионов. Задается геймдизайнером.

|**Column**|**Type**|**Описание**|
|---|---|---|
|**id**|`String` (PK)|Код сектора (например, `"D4"`, `"A1"`).|
|**tier**|`Integer`|Уровень сложности мобов (0-5).|
|**biome_id**|`String`|ID биома (`"forest"`, `"ruins"`). Влияет на генерацию описаний.|
|**anchor_type**|`Enum`|Тип ключевой точки сектора (`HUB`, `RAID_ROOT`, `WILD`).|

### 2.2 Таблица `world_grid` (The Grid)

Физические клетки. Создаются скриптом `Seeder` один раз при вайпе.

|**Column**|**Type**|**Описание**|
|---|---|---|
|**x, y**|`Integer` (PK)|Глобальные координаты.|
|**sector_id**|`String` (FK)|Ссылка на сектор.|
|**is_active**|`Boolean`|**Главный тумблер.**<br><br>  <br><br>`True` = Локация доступна, грузится в Redis, игроки могут ходить.<br><br>  <br><br>`False` = Локация существует только математически. Туман.|
|**service_object_key**|`String`|**Хабы и Сервисы.**<br><br>  <br><br>`"svc_arena_main"` — при входе сюда переключаем FSM игрока в режим сервиса.<br><br>  <br><br>`NULL` — обычная локация (исследование/бой).|
|**flags**|`JSONB`|**Свойства и Латентность.** Хранит модификаторы и "семена".<br><br>  <br><br>Примеры:<br><br>  <br><br>`{"has_road": true}` — здесь есть дорога (бонус скорости).<br><br>  <br><br>`{"is_safe_zone": true}` — здесь нельзя атаковать.<br><br>  <br><br>`{"latent_rift_id": "rift_D3_15"}` — здесь _может_ открыться рифт по квесту.|
|**content**|`JSONB`|**Генерация.** `{ "title": "...", "desc": "...", "tags": [...] }`.<br><br>  <br><br>Заполняется LLM только в момент активации клетки.|

---

## 3. Redis (Runtime Cache) — "Активная Сцена"

Слой быстрого доступа. Сюда попадает **только то, куда можно наступить**.

**Ключ:** `world:node:{x}:{y}` (Hash)

### Поля Хеша:

1. **`meta` (JSON):** Технические флаги для логики.
    
    JSON
    
    ```
    {
      "is_safe": true,        // Из flags
      "service": "svc_arena", // Из service_object_key
      "tier": 1               // Из world_sectors
    }
    ```
    
2. **`view` (JSON):** То, что видит игрок.
    
    JSON
    
    ```
    {
      "title": "Разбитый Тракт",
      "desc": "Под ногами старый асфальт. (Бонус дороги)...",
      "time_mod": 0.5  // Коэффициент скорости (0.5 = в 2 раза быстрее)
    }
    ```
    
3. **`exits` (JSON):** Список доступных переходов.
    
    - _Важно:_ Генератор экситов смотрит на соседей в SQL. Кнопка создается, **только если сосед имеет `is_active=True`**.
        

---

## 4. Механики Мира (Game Logic)

### 4.1 Перемещение и Дороги

Дорога — это не тип тайла, а **модификатор** (`flags['has_road']`).

- **Без дороги:** Переход занимает **4 секунды**.
    
- **По дороге:** Переход занимает **2 секунды**.
    
- **Визуал:** Наличие флага добавляет в описание строку об удобном пути (генерируется LLM или шаблоном).
    

### 4.2 Алгоритм "Pathfinder" (Расширение Мира)

Как "неактивное" становится "активным". Это происходит, когда квест отправляет игрока вглубь неизведанного сектора.

1. **Триггер:** Квест требует посетить точку `[45:12]` (где лежит `latent_rift_id`). Сейчас она `is_active=False`.
    
2. **Поиск Якоря:** Система сканирует БД и находит ближайшую клетку с `is_active=True`. Это будет край Хаба или уже существующая дорога.
    
3. **Прокладка маршрута:** Алгоритм строит путь (линию) от Якоря к Цели.
    
4. **Терраформинг (Транзакция):**
    
    - Все клетки пути получают `is_active = True`.
        
    - Все клетки пути получают `flags['has_road'] = True` (мы буквально протаптываем тропу к цели).
        
    - Запускается генерация контента (LLM) для новых клеток согласно биому сектора.
        
5. **Обновление Кэша:**
    
    - Новые клетки загружаются в Redis.
        
    - **Важно:** Обновляется _одна_ старая клетка (Якорь), чтобы у неё появилась кнопка выхода в новую зону.