# ðŸ’¾ Persistence & Synchronization Layer (Async Write-Behind)

**Status:** ðŸŸ¢ Architecture V3 (Approved)
**Goal:** High Performance, Non-Blocking Gameplay, Data Integrity.

## 1. ÐšÐ¾Ð½Ñ†ÐµÐ¿Ñ†Ð¸Ñ (Philosophy)
ÐœÑ‹ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð¾Ñ‚ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ð³Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ("Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸, Ð¿Ð¾ÐºÐ° Ð·Ð°Ð¿Ð¸ÑˆÑƒ Ð² Ð±Ð°Ð·Ñƒ") Ðº Ð¿Ð°Ñ‚Ñ‚ÐµÑ€Ð½Ñƒ **Write-Behind** (ÐžÑ‚Ð»Ð¾Ð¶ÐµÐ½Ð½Ð°Ñ Ð·Ð°Ð¿Ð¸ÑÑŒ).

*   **Hot Path (Redis):** Ð“ÐµÐ¹Ð¼Ð¿Ð»ÐµÐ¹ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð·Ð´ÐµÑÑŒ. Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ Ð¼Ð³Ð½Ð¾Ð²ÐµÐ½Ð½Ð¾.
*   **Cold Path (PostgreSQL):** Ð”Ð¾Ð»Ð³Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ðµ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ. Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÑŽÑ‚ÑÑ ÑÑŽÐ´Ð° Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾ Ñ‡ÐµÑ€ÐµÐ· Ð¾Ñ‡ÐµÑ€ÐµÐ´ÑŒ Ð·Ð°Ð´Ð°Ñ‡ (ARQ).
*   **I/O Sandwich:** Ð”Ð¾Ð¼ÐµÐ½Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° Ð¾Ñ‚ Ð‘Ð”. ÐžÐ½Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ Redis DTO. Ð“Ñ€ÑÐ·Ð½Ð¾Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ð¾Ð¹ Ð¿Ð¾ Ð¿ÐµÑ€ÐµÐºÐ»Ð°Ð´Ñ‹Ð²Ð°Ð½Ð¸ÑŽ JSON â†’ SQL Ð·Ð°Ð½Ð¸Ð¼Ð°ÑŽÑ‚ÑÑ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Savers.

## 2. ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð° (The Pipeline)
Ð’ÐµÑÑŒ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ€Ð°Ð·Ð±Ð¸Ñ‚ Ð½Ð° 3 ÑÑ‚Ð°Ð¿Ð°:

### Ð­Ñ‚Ð°Ð¿ 1: Trigger (Gateway / Separator)
Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ñ†Ð¸Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ. ÐœÐ¾Ð¶ÐµÑ‚ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ ÑÐ²Ð½Ð¾ (ÐºÐ¾Ð½ÐµÑ† Ð±Ð¾Ñ) Ð¸Ð»Ð¸ Ð½ÐµÑÐ²Ð½Ð¾ (ÑÐ¼ÐµÐ½Ð° ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°).
*   **Action:** ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Redis.
*   **Signal:** `await arq.enqueue_job(...)`
*   **Response:** 200 OK (ÐœÐ³Ð½Ð¾Ð²ÐµÐ½Ð½Ð¾).

### Ð­Ñ‚Ð°Ð¿ 2: Transport (ARQ Worker)
Ð¤Ð¾Ð½Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‡Ñƒ.
*   **Role:** Infrastructure Wrapper.
*   **Responsibility:** Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐµÑÑÐ¸ÑŽ Ð‘Ð” (Transaction Scope), Ð²Ñ‹Ð·Ð²Ð°Ñ‚ÑŒ Ð½ÑƒÐ¶Ð½Ñ‹Ð¹ Saver.

### Ð­Ñ‚Ð°Ð¿ 3: Execution (Domain Savers)
Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ»Ð°ÑÑÑ‹, Ð·Ð½Ð°ÑŽÑ‰Ð¸Ðµ Ð±Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÑƒ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ Ð´Ð¾Ð¼ÐµÐ½Ð°.
*   **Role:** ETL (Extract from Redis -> Transform -> Load to DB).
*   **Constraint:** Ð Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ ÑƒÐ¶Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾Ð¹ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸.

## 3. ÐšÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹

### 3.1. SyncDispatcher (Interface)
Ð•Ð´Ð¸Ð½Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° Ð´Ð»Ñ ÐºÐ¾Ð´Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ "Ð·Ð°ÐºÐ°Ð·Ð°Ñ‚ÑŒ" ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ.
```python
await sync_dispatcher.dispatch(SyncScope.COMBAT_RESULT, char_id=...)
```

### 3.2. Registry of Savers (Workers)
ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð´Ð¾Ð¼ÐµÐ½ Ð¸Ð¼ÐµÐµÑ‚ ÑÐ²Ð¾Ð¹ ÐºÐ»Ð°ÑÑ-ÑÐµÐ¹Ð²ÐµÑ€. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ÑÑ Ð¾Ð´Ð½Ð¸ Ð¸ Ñ‚Ðµ Ð¶Ðµ ÐºÐ»Ð°ÑÑÑ‹ Ð´Ð»Ñ Ð¾Ð±Ð¾Ð¸Ñ… Ñ‚Ð¸Ð¿Ð¾Ð² Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ð¾Ð².

| Ð”Ð¾Ð¼ÐµÐ½ | Saver Class | Ð—Ð°Ð´Ð°Ñ‡Ð° |
| :--- | :--- | :--- |
| **Combat** | `CombatStateSaver` | Ð§Ð¸Ñ‚Ð°ÐµÑ‚ Ð¸Ñ‚Ð¾Ð³ Ð±Ð¾Ñ, Ð¿Ð¸ÑˆÐµÑ‚ history, Ð²Ñ‹Ð´Ð°ÐµÑ‚ XP/Loot, Ñ‡Ð¸ÑÑ‚Ð¸Ñ‚ ÑÐµÑÑÐ¸ÑŽ. |
| **Inventory** | `InventoryStateSaver` | Ð§Ð¸Ñ‚Ð°ÐµÑ‚ Ð´ÐµÐ»ÑŒÑ‚Ñƒ Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ, Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ items. |
| **Vitals** | `VitalsStateSaver` | Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ HP/Energy/Location (Snapshot). |
| **Cleanup** | `CleanupStateSaver` | "Ð£Ð±Ð¾Ñ€Ñ‰Ð¸Ðº": Ð¸Ñ‰ÐµÑ‚ Ð¿Ð¾Ñ‚ÐµÑ€ÑÐ½Ð½Ñ‹Ðµ ÑÐµÑÑÐ¸Ð¸ Ð¸ Ñ„Ð¾Ñ€ÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÑ‚ Ð¸Ñ…. |

### 3.3. The Worker Task
Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð°Ñ ARQ-Ð·Ð°Ð´Ð°Ñ‡Ð°.
```python
async def task_sync_state(ctx, scope: str, char_id: int):
    async with async_session_maker() as session:
        async with session.begin():
            saver = SAVER_REGISTRY[scope](session)
            await saver.save(char_id)
```

### 3.4. The Context Switch (Separator Pattern)
ÐœÐµÑ…Ð°Ð½Ð¸Ð·Ð¼, Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ð¹ Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¸ Ñ€ÐµÐ¶Ð¸Ð¼Ð¾Ð² Ð¸Ð³Ñ€Ñ‹. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ `ac:{char_id}` ÐºÐ°Ðº ÐºÐ°Ñ€Ñ‚Ñƒ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ¾Ð².

**Ð¢Ð¸Ð¿ Ð: Explicit Trigger (Self-Terminated)**
Ð¡ÐµÑ€Ð²Ð¸Ñ ÑÐ°Ð¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÑ‚ ÑÐ²Ð¾ÑŽ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ.
*   *ÐŸÑ€Ð¸Ð¼ÐµÑ€:* Ð‘Ð¾Ð¹ Ð·Ð°ÐºÐ¾Ð½Ñ‡Ð¸Ð»ÑÑ.
*   `CombatGateway` Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ `dispatcher.dispatch(COMBAT)`.

**Ð¢Ð¸Ð¿ Ð‘: Implicit Trigger (Preempted / Context Switch)**
Ð˜Ð³Ñ€Ð¾Ðº Ð¼ÐµÐ½ÑÐµÑ‚ Ñ€ÐµÐ¶Ð¸Ð¼ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¸Ð· "ÐŸÑƒÑ‚ÐµÑˆÐµÑÑ‚Ð²Ð¸Ñ" Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ "Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ").
1.  **Request:** Ð˜Ð³Ñ€Ð¾Ðº Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ÑŒ.
2.  **Check:** Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ `ac:{char_id}`.
3.  **Detect:** Ð’Ð¸Ð´Ð¸Ñ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ `scenario_session_id` (ÐŸÑƒÑ‚ÐµÑˆÐµÑÑ‚Ð²Ð¸Ðµ).
4.  **Action:**
    *   Ð’Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ `dispatcher.dispatch(SCENARIO)` (Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ Ð¿ÑƒÑ‚ÐµÑˆÐµÑÑ‚Ð²Ð¸Ñ).
    *   ÐžÑ‡Ð¸Ñ‰Ð°ÐµÑ‚ `scenario_session_id` Ð² Redis (Ð¸Ð»Ð¸ Ð¿Ð¾Ð¼ÐµÑ‡Ð°ÐµÑ‚ ÐºÐ°Ðº closing).
5.  **Start:** Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ ÑÐµÑÑÐ¸ÑŽ Ð˜Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ.

## 4. Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
```text
backend/domains/persistence/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ dispatcher.py           # SyncDispatcher
â”œâ”€â”€ worker_task.py          # ARQ Task
â”œâ”€â”€ protocols.py            # Protocol for Savers
â””â”€â”€ savers/                 # Logic Redis -> SQL
    â”œâ”€â”€ combat_saver.py
    â”œâ”€â”€ inventory_saver.py
    â”œâ”€â”€ vitals_saver.py
    â””â”€â”€ cleanup_saver.py
```
