# Архитектура Кэширования: Ядро и Сессии

## 1. Концепция

Мы разделяем данные на **Персистентное Ядро** (хранится в `ac:{char_id}`) и **Временные Сессии** (хранятся в отдельных ключах).

Ядро выступает "Диспетчерской вышкой", позволяя системе понимать, в каком контексте находится игрок, и корректно переключать эти контексты (Context Switch).

---

## 2. Структура Redis

### 2.1. Ядро (`ac:{char_id}`)
Хранит данные, которые всегда должны быть под рукой, и ссылки на активные сессии.

| Поле | Тип | Источник | Описание |
| :--- | :--- | :--- | :--- |
| **`state`** | String | `characters.game_stage` | Текущий игровой стейт (FSM). |
| **`location`** | JSON | `characters.location_id` | `{"current": "...", "prev": "..."}` |
| **`bio`** | JSON | `characters` | Имя, пол, дата создания. |
| **`stats`** | JSON | `character_stats` | Сила, Ловкость и т.д. |
| **`vitals`** | JSON | *Dynamic* | `{"hp": {"cur": 100, "max": 100}, ...}`. |
| **`combat_session_id`** | String | *Redis-only* | UUID активной сессии боя. |
| **`inventory_session_id`**| String | *Redis-only* | UUID активной сессии инвентаря. |
| **`scenario_session_id`** | String | *Redis-only* | UUID активной сессии сценария. |

### 2.2. Сессии (Session Keys)
Временные ключи, создаваемые профильными оркестраторами.

*   **`combat:session:{uuid}`**: Монстры, очередность ходов, логи.
*   **`inventory:session:{uuid}`**: Загруженный список предметов, фильтры.
*   **`scenario:session:{uuid}`**: Граф квеста, текущая нода, переменные.

---

## 3. Жизненный цикл (Lifecycle)

Управление жизненным циклом (Сохранение/Загрузка) делегировано:

1.  **Загрузка (Restore):** Выполняется при входе в игру (`LoginService`) или при восстановлении контекста.
2.  **Сохранение (Persist):** Выполняется через **Persistence Layer** (см. [Persistence_Synchronization_Layer.md](./Persistence_Synchronization_Layer.md)).
    *   Используется механизм **Write-Behind** (ARQ).
    *   Поддерживает **Context Switch** (автоматическое сохранение предыдущей сессии при смене режима).

---

## 4. Ссылки
*   [Persistence & Synchronization Layer](./Persistence_Synchronization_Layer.md) — Детальное описание механизма сохранения.
