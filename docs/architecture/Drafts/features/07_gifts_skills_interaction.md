# Gifts & Skills Interaction (RBC v3.1)

## 1. Overview
Этот документ описывает, как различные источники силы (Атрибуты, Навыки, Дары, Баффы) объединяются для формирования итоговых параметров боя (Урон, Защита, Шансы).

## 2. Проблема Типизации Урона
В нашей системе урон не имеет жесткого типа (Physical/Magical) на уровне источника.
*   У оружия есть просто `damage_value`.
*   Тип урона определяется **в момент калькуляции** на основе активных тегов и конвертеров.

**Пример:**
*   Меч дает `10 damage`.
*   Скилл "Мечник" дает `+5 damage`.
*   Дар "Огненный клинок" дает конвертацию `50% to Fire`.
*   **Итог:** Калькулятор видит `15 total`, делит на `7.5 Phys` и `7.5 Fire`.

## 3. Слои Модификаторов (Calculation Layers)

Расчет происходит в строгом порядке слоев.

### Layer 1: Base (База)
Источники: Оружие, Базовые статы монстра.
*   Значение: Число (Flat).
*   Пример: `WeaponDmg = 10`.

### Layer 2: Additive (Сложение)
Источники: Атрибуты (Str/Dex), Пассивные навыки (Skills).
*   Действие: `+` к Базе.
*   Пример: `StrBonus = +5`, `SkillBonus = +2`.
*   `Accumulated = 10 + 5 + 2 = 17`.

### Layer 3: Multiplicative (Умножение)
Источники: Дары (Gifts), Временные Баффы, Стойки.
*   Действие: `*` на результат Layer 2.
*   Пример: `RageBuff = *1.2`.
*   `Accumulated = 17 * 1.2 = 20.4`.

### Layer 4: Conversion & Typing (Типизация)
Источники: Дары (Elemental Gifts), Магические зачарования.
*   Действие: Присвоение тегов типа урона или разделение урона.
*   Пример: `FireGift` добавляет тег `damage_type: fire` или конвертирует часть урона.

## 4. Конфликты и Приоритеты
Если несколько источников пытаются изменить один параметр (например, тип урона):
1.  **Gifts (Дары)** имеют наивысший приоритет (они меняют саму суть персонажа).
2.  **Skills (Навыки)** имеют средний приоритет.
3.  **Items (Предметы)** имеют низший приоритет.

## 5. Пример Расчета (Draft)
**Input:**
*   Weapon: 10
*   Strength: +5
*   Skill "Sword Mastery": +10% Dmg (Multiplier)
*   Gift "Inferno": +5 Flat Fire Dmg

**Flow:**
1.  Base: 10
2.  Additive: 10 + 5 = 15
3.  Multiplicative: 15 * 1.10 = 16.5
4.  Flat Post-Mult (Gift): 16.5 + 5 (Fire) = 21.5 Total.

*Note:* Точная формула будет утверждена после плейтестов боевой системы.
