# 02. World Generation Pipeline

## 1. Концепция (High Concept)

Игровой мир генерируется процедурно с помощью скрипта `scripts/seed_world_gen.py`. Процесс является детерминированным и data-driven, что позволяет гибко настраивать результат через конфигурационные файлы.

**Ключевые цели:**
1.  **Структурированный хаос:** Мир должен быть разнообразным (за счет шума), но иметь ключевые, предсказуемые элементы (Хаб, стены, дороги).
2.  **Гибкость:** Все магические числа и логика должны быть вынесены в конфиги (`world_config.py`, `BIOME_DEFINITIONS`).
3.  **Эффективность:** Генерация должна быть быстрой и использовать массовые операции (bulk insert) для работы с БД.

---

## 2. Главный скрипт: `seed_world_gen.py`

Этот скрипт является единой точкой входа для создания мира с нуля. Он имеет несколько режимов работы:
*   `test`: Генерирует только структуру мира и Хаб. Быстрый запуск для проверки геометрии.
*   `full`: Полная генерация, включая контент в соседних с Хабом зонах.
*   `content_only`: Не пересоздает структуру мира, а только наполняет его контентом.

---

## 3. Этапы Генерации (Pipeline)

Процесс разделен на четкие шаги внутри класса `WorldGenerator`.

### Шаг 1: Создание Структуры (Regions & Zones)
*   **Действие:** Создается сетка Регионов (7x7) и Зон (3x3 в каждом регионе).
*   **Логика:**
    *   Центральный регион `D4` обрабатывается как особый случай (Хаб и руины).
    *   Для остальных регионов `biome_id` и `tier` зоны определяются на основе шума и удаленности от центра.
*   **Результат:** В БД созданы записи `WorldRegion` и `WorldZone`.

### Шаг 2: Генерация Матрицы в Памяти
*   **Действие:** Создается огромный словарь `world_matrix`, где ключ — это кортеж `(x, y)`, а значение — словарь с данными о тайле.
*   **Логика:**
    *   Для каждого тайла определяется биом (`_get_biome_noise`).
    *   Тип поверхности (`terrain_type`) выбирается **взвешенно** на основе `spawn_weight` из `BIOME_DEFINITIONS`. Это позволяет, например, делать болота более редкими в лесу.
*   **Результат:** Полная карта мира в виде словаря в оперативной памяти.

### Шаг 3: Построение Скелета Мира
*   **Действие:** На базовую матрицу накладываются ключевые структуры.
*   **Порядок:**
    1.  **Статические объекты:** Размещаются здания из `STATIC_LOCATIONS` (кузница, ратуша в Хабе).
    2.  **Стена:** Вокруг региона `D4` строится непроходимая стена с воротами.
    3.  **POI (Points of Interest):** В центре каждого региона размещается "древний руинный POI".
    4.  **Дороги:** Вызывается `_generate_roads_graph`.

### Шаг 4: Прокладка Дорог (`PathFinder`)
*   **Действие:** Соединение ключевых точек дорогами.
*   **Логика:**
    1.  **Расчет стоимости:** Для каждого тайла в матрице рассчитывается `travel_cost` на основе конфига. Дороги имеют низкую стоимость, горы и болота — высокую.
    2.  **Поиск путей:** `PathFinder` (реализация A*) находит кратчайшие пути между:
        *   Хабом и воротами в стене.
        *   Воротами и ближайшими POI.
        *   POI и соседними POI.
        *   POI и "якорями" на краях мира.
*   **Результат:** Тайлы, попавшие в путь, помечаются тегом `road` и получают соответствующий `terrain_type`.

### Шаг 5: Сохранение в БД
*   **Действие:** Данные из `world_matrix` сохраняются в таблицу `world_nodes` с помощью `bulk_upsert_nodes`.
*   **Оптимизация:** Данные отправляются в БД большими "чанками" (по 500 записей), что значительно быстрее, чем одиночные вставки.

### Шаг 6: Наполнение Контентом (`ZoneOrchestrator`)
*   **Действие:** После создания геометрии мира, запускается `ZoneOrchestrator`.
*   **Логика:**
    *   Оркестратор работает с "чанками" мира.
    *   Он вызывает `ContentGenerationService` для генерации описаний локаций (с помощью LLM).
    *   Он вызывает `ClanFactory` для спавна монстров в этих локациях.
*   **Результат:** Стартовые зоны вокруг Хаба становятся "живыми" — с описаниями и врагами.

---

## 4. Связанные Сервисы

*   **`ZoneOrchestrator`:** Сервис, отвечающий за "оживление" конкретного участка мира. Используется как на старте, так и во время игры, когда игрок заходит в новую зону.
*   **`ContentGenerationService`:** Генерирует текстовый контент (описания локаций) с помощью LLM.
*   **`PathFinder`:** Утилита для поиска путей на 2D-сетке с учетом весов.
*   **`ClanFactory`:** Создает и размещает группы монстров.
