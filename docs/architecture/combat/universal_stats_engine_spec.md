# Technical Spec: Universal Stats Engine (Waterfall Calculation)

**Тип:** Core Logic / Math Engine
**Роль:** Универсальный калькулятор характеристик, работающий на Text-Based Math Protocol.
**Применение:** Боевая система, Меню персонажа, Проверки в диалогах.

---

## 1. Аксиома Баланса v2.0 (Philosophy)

Мы разделяем источники силы на две категории с разной математикой.

### A. Внутренняя Сила (Internal Power) -> БАЗА
Это то, кем персонаж является. Его тело, опыт, знания.
*   **Источники:**
    *   Атрибуты (Strength, Agility...).
    *   Скиллы (Skills) и их перки.
    *   Дары (Gifts) и мутации.
*   **Математика:** Всегда **Сложение (`+`)**.
*   *Пример:* Скилл "Интуиция" дает `+5%` крита. Это база.

### B. Внешнее Усиление (External Power) -> МНОЖИТЕЛИ
Это то, что персонаж использует. Экипировка, магия, временные эффекты.
*   **Источники:**
    *   Предметы (Items) и Экипировка.
    *   Баффы/Дебаффы (Buffs).
    *   Абилки (Abilities).
*   **Математика:** Всегда **Умножение (`*`)**.
*   *Пример:* Кольцо дает `+10%` крита. Это превращается в множитель `*1.1`.
*   **Исключение:** Если предмет дает **Атрибут** (Силу), он добавляется (`+`), так как атрибуты — это фундамент.

---

## 2. Концепция: Text-Based Math Protocol
Мы отказываемся от сложной типизации модификаторов в коде. Все значения передаются как **строки-инструкции**.

*   `"15"` -> Базовое значение (Base).
*   `"+50"` -> Аддитивный бонус (Flat Add).
*   `"-10"` -> Штраф (Flat Sub).
*   `"*1.5"` -> Мультипликатор (Multiplier).
*   `"=100"` -> Жесткая установка (Override).

**Преимущество:** Zero-Transformation Pipeline. Если в БД хранить строки `"+50"`, то Ассемблер просто перекладывает JSON из БД в Redis без парсинга.

---

## 3. Алгоритм: Waterfall Calculation (Водопад)

Процесс расчета идет в три фазы, где данные "текут" сверху вниз.

### Фаза 1: Расчет Атрибутов (Primary Stats)
Берем блок `attributes` из `v:raw`.
*   **Вход:** `Strength: {base: "10", sources: {"buff": "+5"}}`
*   **Расчет:** `10 + 5 = 15`
*   **Выход:** `final_strength = 15`

### Фаза 2: Конвертация (Derivation Bridge)
Превращаем Атрибуты в Модификаторы, используя глобальные правила (`DERIVATION_RULES`).

*   **Правило:** `1 Strength = +1.5 Physical Damage`
*   **Действие:**
    1.  Берем `final_strength` (15).
    2.  Считаем бонус: `15 * 1.5 = 22.5`.
    3.  Создаем **Виртуальный Источник**: `"+22.5"`.
    4.  Впрыскиваем его в `modifiers.physical_damage_min`.

### Фаза 3: Расчет Модификаторов (Secondary Stats)
Берем блок `modifiers` (с уже впрыснутыми бонусами от атрибутов).
*   **Вход:**
    *   `derived:strength`: `"+22.5"` (из Фазы 2) -> Это БАЗА.
    *   `skill:sword_mastery`: `"+10"` -> Это БАЗА.
    *   `item:sword`: `"*1.1"` (Внешнее усиление).
    *   `buff:rage`: `"*1.2"` (Внешнее усиление).
*   **Расчет:** `(22.5 + 10) * 1.1 * 1.2 = 42.9`
*   **Выход:** `final_damage = 42.9`

---

## 4. Конфигурация Правил (Rules Config)

```python
DERIVATION_RULES = {
    # "Откуда": [{"Куда": "stat_name", "Множитель": float}]
    "strength": [
        {"target": "physical_damage_min", "factor": 1.5},
        {"target": "carry_weight", "factor": 5.0}
    ],
    "agility": [
        {"target": "crit_chance", "factor": 0.005}, # 1 Agi = +0.5% Crit
        {"target": "dodge_chance", "factor": 0.01}
    ],
    "intelligence": [
        {"target": "magical_damage_power", "factor": 2.0},
        {"target": "energy_max", "factor": 10.0}
    ]
}
```
