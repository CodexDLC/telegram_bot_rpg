# Combat Calculator Responsibility (RBC v2.0)

**File:** `apps/game_core/modules/combat/core/combat_calculator.py`
**Type:** Stateless Static Service (Pure Math Engine).

## 1. –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (Input Contract)
–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±—è–∑–∞–Ω –ø—Ä–∏–Ω—è—Ç—å –∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å:
*   **Stats Attacker:** (Dmg Min/Max, Hit Rate, Crit Chance, Pen...).
*   **Stats Defender:** (Armor, Evasion, Block Chance, Thorns...).
*   **Payload Zones:** –¢–æ—á–Ω—ã–µ –∑–æ–Ω—ã –∞—Ç–∞–∫–∏ –∏ –±–ª–æ–∫–∞ (—Å–ø–∏—Å–∫–∏).
*   **Flags (Context Modifiers):** –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç `AbilityService` (`force_miss`, `ignore_armor`, `always_crit`).

---

## 2. –û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ (What it DOES)

### –ê. –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –§–ª–∞–≥–æ–≤ (Priority 1)
–ü—Ä–µ–∂–¥–µ —á–µ–º —Å—á–∏—Ç–∞—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏–∫—É, –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—Ä–∏–∫–∞–∑—ã:
*   –ï—Å–ª–∏ —Ñ–ª–∞–≥ `force_miss` -> –í–µ—Ä–Ω—É—Ç—å 0 —É—Ä–æ–Ω–∞, –ª–æ–≥ "–ü—Ä–æ–º–∞—Ö".
*   –ï—Å–ª–∏ —Ñ–ª–∞–≥ `force_hit` -> –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–æ—á–Ω–æ—Å—Ç–∏.
*   –ï—Å–ª–∏ —Ñ–ª–∞–≥ `ignore_block` -> –°—á–∏—Ç–∞—Ç—å, —á—Ç–æ `block_zones` –ø—É—Å—Ç–æ–π.

### –ë. –†–∞—Å—á–µ—Ç –ö–æ–Ω—Ç–∞–∫—Ç–∞ (Resolution)
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –¥–æ—à–µ–ª –ª–∏ —É–¥–∞—Ä –¥–æ —Ç–µ–ª–∞.
*   **Accuracy Check:** HitRate vs Evasion (—Å —É—á–µ—Ç–æ–º –∫–∞–ø–æ–≤).
    *   *–†–µ–∑—É–ª—å—Ç–∞—Ç:* –§–ª–∞–≥ `is_dodged`.
*   **Zone Check:** –ü–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è –ª–∏ `attack_zones` –∏ `block_zones`.
    *   *–†–µ–∑—É–ª—å—Ç–∞—Ç:* –§–ª–∞–≥ `is_blocked`.
    *   *Note:* –ï—Å–ª–∏ `is_blocked` -> –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Å–Ω–∏–∂–µ–Ω–∏–µ —É—Ä–æ–Ω–∞ –∏–ª–∏ –ø–æ–ª–Ω—É—é –æ—Ç–º–µ–Ω—É (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–µ—Ö–∞–Ω–∏–∫–∏ —â–∏—Ç–∞).

### –í. –†–∞—Å—á–µ—Ç –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (Rolling)
–ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç –µ—Å—Ç—å, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ —É–¥–∞—Ä–∞.
*   **Crit Check:** CritChance vs AntiCrit.
    *   *–†–µ–∑—É–ª—å—Ç–∞—Ç:* –§–ª–∞–≥ `is_crit`.
*   **Counter Check:** (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∞–Ω—Å–∞ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∏.
    *   *–†–µ–∑—É–ª—å—Ç–∞—Ç:* –§–ª–∞–≥ `is_counter` (–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —É–≤–∏–¥–∏—Ç –µ–≥–æ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç –≤—Ç–æ—Ä–æ–π –∫—Ä—É–≥).

### –ì. –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –£—Ä–æ–Ω–∞ (Quantification)
–ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤ –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ.
1.  **Base Roll:** Random(Min, Max).
2.  **Multipliers:** `* SkillPower * CritMod * DamageMod`.
3.  **Mitigation:** `(Damage * (1 - Resist)) - FlatArmor`.
4.  **Clamping:** `Max(0, FinalDamage)`. (–£—Ä–æ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º).
5.  **Shield Split:** –ï—Å–ª–∏ —É —Ü–µ–ª–∏ –µ—Å—Ç—å HP-—â–∏—Ç (–±–∞—Ä—å–µ—Ä), –¥–µ–ª–∏—Ç —É—Ä–æ–Ω –Ω–∞ `shield_dmg` –∏ `hp_dmg`.

### –î. –†–∞—Å—á–µ—Ç –í—Ç–æ—Ä–∏—á–Ω—ã—Ö –†–µ—Å—É—Ä—Å–æ–≤
–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—á–∏—Ç–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–æ–ª–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è, –Ω–æ –Ω–µ –º–µ–Ω—è–µ—Ç –∏—Ö.
*   **Vampirism:** –°—á–∏—Ç–∞–µ—Ç `LifestealAmount` –æ—Ç –Ω–∞–Ω–µ—Å–µ–Ω–Ω–æ–≥–æ —É—Ä–æ–Ω–∞.
*   **Thorns:** –°—á–∏—Ç–∞–µ—Ç `ThornsDamage` –æ—Ç —Å—Ç–∞—Ç–æ–≤ –∑–∞—â–∏—Ç—ã.

---

## 3. –ó–∞–ø—Ä–µ—Ç—ã (What it DOES NOT)
*   ‚ùå **–ù–ï –º–µ–Ω—è–µ—Ç State:**
    *   –ù–∏–∫–∞–∫–∏—Ö `target.hp -= damage`.
    *   –ù–∏–∫–∞–∫–∏—Ö `source.en -= cost`.
    *   –≠—Ç–æ –¥–µ–ª–∞–µ—Ç `MechanicsService` (–∏–ª–∏ –∫–æ–¥ –≤ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–µ) –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞.
*   ‚ùå **–ù–ï –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–µ –∑–æ–Ω—ã:**
    *   –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –Ω–µ —Ä–µ—à–∞–µ—Ç, –∫—É–¥–∞ –ø—Ä–∏–ª–µ—Ç–∏—Ç –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞. –û–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–æ–Ω—ã —Ç–æ–ª—å–∫–æ –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç.
    *   –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–Ω–¥–æ–º–∞ –¥–ª—è –ò–ò –∏–ª–∏ –∫–æ–Ω—Ç—Ä—É–¥–∞—Ä–∞ ‚Äî –≤ –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–µ.
*   ‚ùå **–ù–ï –ª–µ–∑–µ—Ç –≤ –ë–∞–∑—É –î–∞–Ω–Ω—ã—Ö (Redis):**
    *   –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º–∏ —Å–ª–æ–≤–∞—Ä—è–º–∏/DTO.
*   ‚ùå **–ù–ï –≤—ã–∑—ã–≤–∞–µ—Ç –¥—Ä—É–≥–∏–µ —Å–µ—Ä–≤–∏—Å—ã:**
    *   –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä ‚Äî —ç—Ç–æ "–ª–∏—Å—Ç" –≤ –¥–µ—Ä–µ–≤–µ –≤—ã–∑–æ–≤–æ–≤. –û–Ω –Ω–∏–∫–æ–≥–æ –Ω–µ –¥–µ—Ä–≥–∞–µ—Ç.

---

## 4. –§–æ—Ä–º–∞—Ç –û—Ç–≤–µ—Ç–∞ (Output DTO)

```python
{
    # –ì–ª–∞–≤–Ω—ã–µ —Ü–∏—Ñ—Ä—ã –¥–ª—è MechanicsService
    "damage_final": 150,      # –ß–∏—Å—Ç—ã–π —É—Ä–æ–Ω –≤ HP (–ø–æ—Å–ª–µ –≤—ã—á–µ—Ç–∞ –±–∞—Ä—å–µ—Ä–∞)
    "shield_dmg": 50,         # –£—Ä–æ–Ω –≤ –º–∞–≥–∏—á–µ—Å–∫–∏–π –±–∞—Ä—å–µ—Ä
    
    # –†–µ—Å—É—Ä—Å—ã –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
    "lifesteal_amount": 15,   # –°–∫–æ–ª—å–∫–æ –≤—ã–ª–µ—á–∏—Ç—å –ê—Ç–∞–∫—É—é—â–µ–º—É
    "thorns_damage": 10,      # –°–∫–æ–ª—å–∫–æ –Ω–∞–Ω–µ—Å—Ç–∏ –ê—Ç–∞–∫—É—é—â–µ–º—É (–æ—Ç —à–∏–ø–æ–≤)
    
    # –§–ª–∞–≥–∏ –¥–ª—è –õ–æ–≥–∏–∫–∏ –∏ –ê–Ω–∏–º–∞—Ü–∏–π
    "is_crit": True,
    "is_blocked": False,
    "is_dodged": False,
    "is_miss": False,
    "is_counter": False,      # –°–∏–≥–Ω–∞–ª –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä—É: "–ó–∞–ø—É—Å—Ç–∏ Round 2"
    
    # –¢–æ–∫–µ–Ω—ã (–¥–ª—è –≤—ã–¥–∞—á–∏ –Ω–∞–≥—Ä–∞–¥/–Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —É–ª—å—Ç—ã)
    "tokens_atk": {"crit": 1, "hit": 1},
    "tokens_def": {},
    
    # –õ–æ–≥–∏ –∏ –í–∏–∑—É–∞–ª
    "logs": ["–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–¥–∞—Ä!", "–í–∞–º–ø–∏—Ä–∏–∑–º +15 HP"],
    "visual_bar": "[‚¨õüü•‚¨õ‚¨õ‚ñ´Ô∏è]" 
}
```