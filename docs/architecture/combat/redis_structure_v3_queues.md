# RBC Architecture: Redis Data Structure (v3.0 - RedisJSON Queues)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ö–æ–¥–æ–≤ (Moves), –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–ª—è Map-Reduce –ø–∞–π–ø–ª–∞–π–Ω–∞ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ—á–µ—Ä–µ–¥–µ–π –¥–µ–π—Å—Ç–≤–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **RedisJSON**.

## üéØ –ö–ª—é—á–µ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: RedisJSON
–ú—ã –æ—Ç–∫–∞–∑—ã–≤–∞–µ–º—Å—è –æ—Ç —Ç–∏–ø–∞ `HASH` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π —Ö–æ–¥–æ–≤ –≤ –ø–æ–ª—å–∑—É –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ —Ç–∏–ø–∞ `JSON` (–º–æ–¥—É–ª—å RedisJSON).
–≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** –æ–ø–µ—Ä–∞—Ü–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Lua-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∏–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (Distributed Locks), –ø–æ–ª–Ω–æ—Å—Ç—å—é —É—Å—Ç—Ä–∞–Ω—è—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏ (Race Condition).

---

## üìÇ –ê–∫—Ç–∏–≤–Ω—ã–µ –•–æ–¥—ã (moves)
**–¢–∏–ø:** `JSON` (ReJSON Document)
**–ö–ª—é—á:** `combat:rbc:{sid}:moves:{char_id}`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞—è–≤–æ–∫ ("–ø—É–ª—å") –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∞–∫—Ç–æ—Ä–∞.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–æ–∫—É–º–µ–Ω—Ç–∞
```json
{
  "instant": [
    // –û—á–µ—Ä–µ–¥—å –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (–ë–∞—Ñ—Ñ—ã, –ó–µ–ª—å—è, –¢–æ–≥–ª—ã)
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è Orchestrator'–æ–º –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å (High Priority)
    {
      "move_id": "uuid-v4",
      "strategy": "instant",
      "action_type": "use_item",
      "targets": [101],
      "payload": {"item_id": 55},
      "created_at": 1704000000
    }
  ],
  "exchange": [
    // –û—á–µ—Ä–µ–¥—å –±–æ–µ–≤—ã—Ö —Ä–∞–∑–º–µ–Ω–æ–≤ (–ê—Ç–∞–∫–∞, –ë–ª–æ–∫, –ö–∞—Å—Ç)
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ñ–∞–∑–µ Exchange Loop (Normal Priority)
    {
      "move_id": "uuid-v4",
      "strategy": "exchange",
      "action_type": "attack",
      "targets": [201, 202],
      "payload": {"attack_zones": ["head"]},
      "created_at": 1704000010
    }
  ]
}
```

---

## üîÑ –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã (Atomic Operations)

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ –±–æ–π)
–°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –∫–∞—Ä–∫–∞—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞.
*   **–ö–æ–º–∞–Ω–¥–∞:** `JSON.SET key $ '{"instant": [], "exchange": []}'`

### 2. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –•–æ–¥–∞ (TurnManager)
–ê—Ç–æ–º–∞—Ä–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω–µ—Ü —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –æ—á–µ—Ä–µ–¥–∏. –ù–µ —Ç—Ä–µ–±—É–µ—Ç —á—Ç–µ–Ω–∏—è –≤—Å–µ–≥–æ —Å–ø–∏—Å–∫–∞.
*   **–ö–æ–º–∞–Ω–¥–∞:** `JSON.ARRAPPEND key $.exchange {move_dto}`
*   *–†–µ–∑—É–ª—å—Ç–∞—Ç:* –ù–æ–≤–∞—è –¥–ª–∏–Ω–∞ –º–∞—Å—Å–∏–≤–∞.

### 3. –ß—Ç–µ–Ω–∏–µ –∏ –û–±—Ä–∞–±–æ—Ç–∫–∞ (Orchestrator/Supervisor)
–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ—á–µ—Ä–µ–¥–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
*   **–ö–æ–º–∞–Ω–¥–∞:** `JSON.GET key`
*   *–†–µ–∑—É–ª—å—Ç–∞—Ç:* –ü–æ–ª–Ω—ã–π JSON –æ–±—ä–µ–∫—Ç.

### 4. –û—á–∏—Å—Ç–∫–∞ / –£–¥–∞–ª–µ–Ω–∏–µ (Cleanup)
–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ —Ö–æ–¥—ã –≤–∑—è—Ç—ã –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É (–≤ Map-Reduce –ø–∞–π–ø–ª–∞–π–Ω), –∏—Ö –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–∑ –æ—á–µ—Ä–µ–¥–∏.

**–í–∞—Ä–∏–∞–Ω—Ç –ê: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ (Batch)**
–ï—Å–ª–∏ –º—ã –∑–∞–±—Ä–∞–ª–∏ –≤—Å–µ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
*   **–ö–æ–º–∞–Ω–¥–∞:** `JSON.SET key $.instant []`

**–í–∞—Ä–∏–∞–Ω—Ç –ë: –¢–æ—á–µ—á–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (Pop)**
–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–≤—ã–π):
*   **–ö–æ–º–∞–Ω–¥–∞:** `JSON.ARRPOP key $.exchange 0`

---

## üå≥ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –î–µ—Ä–µ–≤–∞ –î–∞–Ω–Ω—ã—Ö

```plaintext
combat:rbc:{uuid}
‚îî‚îÄ‚îÄ moves
    ‚îî‚îÄ‚îÄ {char_id_101} (JSON Document)
        ‚îú‚îÄ‚îÄ .instant (Array)
        ‚îÇ     ‚îî‚îÄ‚îÄ [ { "action": "potion", ... } ]
        ‚îÇ
        ‚îî‚îÄ‚îÄ .exchange (Array)
              ‚îú‚îÄ‚îÄ [0]: { "action": "fireball", "targets": [201, 202] }
              ‚îî‚îÄ‚îÄ [1]: { "action": "attack", "targets": [201] }
```

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ v3.0
1.  **Concurrency Safe:** `JSON.ARRAPPEND` –∞—Ç–æ–º–∞—Ä–µ–Ω. –î–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–æ–±–∞–≤—è—Ç –¥–≤–∞ —Ö–æ–¥–∞ –≤ –æ—á–µ—Ä–µ–¥—å, –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è.
2.  **Performance:** –ù–µ—Ç –æ–≤–µ—Ä—Ö–µ–¥–∞ –Ω–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é –≤—Å–µ–≥–æ —Å–ø–∏—Å–∫–∞ –≤ Python (–∫–∞–∫ –±—ã–ª–æ –±—ã —Å HASH). Redis —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π.
3.  **Simplicity:** –ö–æ–¥ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —á–∏—â–µ ‚Äî –∏—Å—á–µ–∑–∞—é—Ç —Å–ª–æ–∂–Ω—ã–µ Lua-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON-—Å—Ç—Ä–æ–∫.
