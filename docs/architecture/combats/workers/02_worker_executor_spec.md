# Worker Executor Specification (RBC v3.1)

## 1. Назначение
**Executor** — это "мозг" обработки очереди. Он берет пары действий (Exchange) и превращает их в задачи для вычислений.
В версии v3.1 его роль расширена: он не просто диспетчер, он **Арбитр Конфликтов** (Interference Arbiter).

---

## 2. Процесс Обработки (Execution Flow)

### Шаг 1: Получение Задачи
Executor забирает из Redis пару интентов: `Intent_A` и `Intent_B`.

### Шаг 2: Interference Pre-Check (НОВОЕ)
Перед тем как считать урон, Executor проверяет, не пытаются ли игроки "сломать" друг другу атаку (контроль, стан, сбитие).

**Алгоритм:**
1.  **Scan:** Executor смотрит на ключи приемов (`action_id`) в обоих интентах.
2.  **Lookup:** Проверяет в `FeintsLibrary` (облегченная версия), есть ли у этих приемов флаг `is_interference` (или `type: CONTROL`).
3.  **Conflict Resolution:**
    *   **Нет контроля:** Оба бьют как обычно. `Mods_A = {}`, `Mods_B = {}`.
    *   **Один контроль (А станит Б):**
        *   Проверка шанса (Roll).
        *   Успех -> `Mods_B = {"disable_attack": True}`.
        *   Провал -> `Mods_B = {}`.
    *   **Двойной контроль (Clash):**
        *   Оба кидают шансы.
        *   Если оба прошли -> Сравнение **Инициативы** (Speed).
        *   Победитель накладывает мод, проигравший получает.

### Шаг 3: Формирование Задач (Task Generation)
Executor создает две задачи для `Gatherer` (вычислительного ядра), внедряя полученные модификаторы.

*   **Task 1:** `Process(Actor_A, Intent_A, Target_B, ExternalMods=Mods_A)`
*   **Task 2:** `Process(Actor_B, Intent_B, Target_A, ExternalMods=Mods_B)`

> **Важно:** Если `Mods_B` содержит `disable_attack`, то Пайплайн Б будет "кастрирован" (без фазы калькуляции), но все равно запущен для обновления статусов.

### Шаг 4: Агрегация и Сохранение
После выполнения задач Executor собирает результаты, формирует логи боя и сохраняет обновленный стейт в Redis.

---

## 3. Обработка Ошибок
Если один из интентов невалиден (игрок умер до начала хода, но интент остался), Executor превращает его в `Skip Turn` и не проводит Pre-Check.
