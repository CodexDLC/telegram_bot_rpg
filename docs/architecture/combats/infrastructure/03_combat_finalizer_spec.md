# Specification: Combat Finalizer (The Rewarder)

**Роль:** Превращение сырых данных сессии в итоговый результат. Ответственен за «дофаминовый отклик» игрока и сохранность данных в SQL.

---

## 1. Фаза 1: Мгновенный расчет (Immediate View)
Выполняется Executor-ом в момент финального коммита (когда `active` становится `0`) или Gateway-ем при первом запросе результатов.

### Логика:
1.  **XP Math:** Берет `xp_buffer` из Redis (счетчики действий: криты, блоки, увороты).
2.  **Price Table:** Применяет веса к действиям (например, `crit: 15 XP`, `dodge: 10 XP`). Это простая арифметика, выполняемая мгновенно.
3.  **View Key:** Создает в Redis легкий JSON-ключ `combat:result:{sid}:view`.
    *   **Состав:** Кто победил, сколько опыта получил каждый участник, список наград.
    *   **Цель:** Немедленный показ экрана результатов игроку.

---

## 2. Фаза 2: Фильтрация данных (Persist Snapshot)
Создание компактного пакета данных для долгосрочного хранения.

### Что сохраняем (Ключ `:persist`):
*   **Analytics:** Детальная статистика разменов для истории боев.
*   **XP Delta:** Уже рассчитанные на Фазе 1 цифры опыта для каждого `char_id`.
*   **Final State:** Финальные ресурсы (если режим боя требует сохранения HP/EN после выхода).

### Что удаляем (Фильтрация):
*   ❌ Базовые статы (`:raw`) и кеш характеристик (`:cache`).
*   ❌ Временные эффекты (`:effects`) и системные логи.
*   ❌ Очереди ходов (`:moves`).

---

## 3. Фаза 3: Асинхронная запись (Finalizer Worker)
Вызывается через сигнал `arq.enqueue('job_save_battle_result', session_id)`.

### Обязанности воркера:
1.  **SQL Commit:**
    *   Записывает итоги в таблицу истории боев (`battle_results`).
    *   Атомарно обновляет навыки персонажей в SQL (`character_skills`), прибавляя рассчитанный опыт.
2.  **Cleanup:**
    *   После подтверждения записи в SQL удаляет все ключи `combat:rbc:{sid}:*` из Redis.
    *   Ключ `:view` может остаться с коротким TTL (5-10 мин) для тех, кто долго изучает экран результатов.
