# Context Assembler v2.0

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥ –∫ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏](../../../../README.md) | ‚¨ÖÔ∏è [–ù–∞–∑–∞–¥ –∫ Game Core Services](../README.md)

**–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ª—é–±–æ–≥–æ —Å–ª–æ—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.**

Context Assembler v2 ‚Äî —ç—Ç–æ —ç–≤–æ–ª—é—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–ª—è Combat System, —Ç–µ–ø–µ—Ä—å –æ–Ω –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π Data Reader, —Å–ø–æ—Å–æ–±–Ω—ã–π –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –ª—é–±—ã–µ –º–æ–¥—É–ª–∏ –∏–≥—Ä—ã: Status Screen, Inventory UI, Exploration Checks, Trade, Tutorial –∏ –¥—Ä—É–≥–∏–µ.

---

## üìö –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

### 1. [üß† Concepts (–ö–æ–Ω—Ü–µ–ø—Ü–∏—è)](./concepts/README.md)
–§–∏–ª–æ—Å–æ—Ñ–∏—è, —Ü–µ–ª–∏ –∏ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∫–∏ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Å–±–æ—Ä—â–∏–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
*   [Philosophy](./concepts/philosophy.md) - –ó–∞—á–µ–º –Ω—É–∂–µ–Ω v2 –∏ —á–µ–º –æ–Ω –ª—É—á—à–µ.
*   [Scope System](./concepts/scope_system.md) - –ì–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–±–ª–∞—Å—Ç–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.
*   [Data Flow](./concepts/data_flow.md) - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö.

### 2. [‚öôÔ∏è Specs (–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è)](./specs/README.md)
–î–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.
*   **[Data Structures](./specs/data_structures/README.md)** - DTO, Redis —Å—Ö–µ–º—ã.
*   **[Components](./specs/components/README.md)** - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤ (Orchestrator, Assemblers, Formatters).
*   **[Flows](./specs/flows/README.md)** - –î–∏–∞–≥—Ä–∞–º–º—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∏–º–µ—Ä—ã.

### 3. [üó∫Ô∏è Roadmap (–ü–ª–∞–Ω —Ä–∞–∑–≤–∏—Ç–∏—è)](./roadmap/README.md)
–ü–ª–∞–Ω—ã –ø–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é –∏ –º–∏–≥—Ä–∞—Ü–∏–∏.
*   [Migration Plan](./roadmap/migration_v1_to_v2.md)
*   [Known Issues](./roadmap/known_issues.md)

---

## üí° –§–∏–ª–æ—Å–æ—Ñ–∏—è v2

*   **–ë—ã–ª–æ (v1):** –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –±–æ—è. –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –í–°–Å (attributes, inventory, skills, vitals) bulk-–∑–∞–ø—Ä–æ—Å–∞–º–∏.
*   **–°—Ç–∞–ª–æ (v2):**
    *   –ì–∏–±–∫–∏–π –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä —Å —Å–∏—Å—Ç–µ–º–æ–π —Ñ–ª–∞–≥–æ–≤ **Scope**.
    *   –ó–∞–≥—Ä—É–∂–∞–µ—Ç **—Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –Ω—É–∂–Ω–æ** –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å—Ü–µ–Ω–∞—Ä–∏—é.
    *   –û–¥–∏–Ω —Ñ–ª–∞–≥ = –æ–¥–Ω–∞ —Ü–µ–ª—å (`combats`, `status`, `inventory`).
    *   –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î —á–µ—Ä–µ–∑ **conditional loading**.

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏

### 1. Scope System
–ï–¥–∏–Ω—ã–π —Ñ–ª–∞–≥, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç:
1.  –ö–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —á–∏—Ç–∞—Ç—å –∏–∑ –ë–î.
2.  –ö–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—Ç—å.
3.  –ö–∞–∫–æ–π Temp DTO —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å.

**–ü—Ä–∏–º–µ—Ä—ã:**
*   `scope="combats"` ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ—Ç –±–æ–µ–≤—ã–µ —Å—Ç–∞—Ç—ã + equipped items + skills + vitals.
*   `scope="status"` ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ attributes + vitals –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.
*   `scope="inventory"` ‚Üí –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤–µ—Å—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å + wallet –¥–ª—è UI –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è.

### 2. Temp DTO Hierarchy
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á:
*   **CombatTempContext** ‚Äî –ø–æ–ª–Ω—ã–π –±–æ–µ–≤–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (`math_model`, `loadout`, `vitals`).
*   **StatusTempContext** ‚Äî –¥–∞–Ω–Ω—ã–µ –¥–ª—è UI —Å—Ç–∞—Ç—É—Å–∞.
*   **InventoryTempContext** ‚Äî –¥–∞–Ω–Ω—ã–µ –¥–ª—è UI –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è.

–í—Å–µ –Ω–∞—Å–ª–µ–¥—É—é—Ç—Å—è –æ—Ç `BaseTempContext` –∏ –∏–º–µ—é—Ç –æ–±—â–∏–µ `core` –ø–æ–ª—è, –Ω–æ —Ä–∞–∑–Ω—ã–µ `computed` fields.

### 3. UUID Keys
–í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `temp:setup:{uuid}` –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤. –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å = –Ω–æ–≤—ã–π UUID = —Å–≤–µ–∂–∏–π —Å–Ω–∏–º–æ–∫ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤.

### 4. Strategy Pattern
–†–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Å—É—â–Ω–æ—Å—Ç–µ–π (Player, Monster, Pet) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ä–∞–∑–Ω—ã–º–∏ Assemblers:
*   **PlayerAssembler** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç —Å SQL (characters, attributes, inventory, skills).
*   **MonsterAssembler** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç —Å generated monsters.
*   **PetAssembler** ‚Äî –±—É–¥—É—â–µ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ.

---

## üöÄ Quick Start

### –ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è –±–æ—è
```python
request = ContextRequestDTO(
    player_ids=[101, 102],
    monster_ids=["uuid-mob-1"],
    scope="combats"
)

response = await context_assembler.get_entry_point(
    action="assemble",
    context=request.model_dump()
)

# response.player = {101: "temp:setup:uuid-1", 102: "temp:setup:uuid-2"}
# response.monster = {"uuid-mob-1": "temp:setup:uuid-3"}
```

### –ó–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
```python
request = ContextRequestDTO(
    player_ids=[101],
    scope="status"
)

response = await context_assembler.get_entry_point(
    action="assemble",
    context=request.model_dump()
)

# –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ: attributes, vitals, symbiote
# –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –∏ —Å–∫–∏–ª–ª—ã –ù–ï –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
```

---

## üìã Scope Reference

### `combats`
*   **–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –±–æ—é.
*   **–ó–∞–≥—Ä—É–∂–∞–µ—Ç:**
    *   attributes (`character_attributes`)
    *   inventory (`equipped` only)
    *   skills (`character_skill_progress`)
    *   vitals (redis accounts)
    *   symbiote (`character_symbiotes`)
*   **Temp DTO:** `CombatTempContext`
*   **Computed Fields:**
    *   `math_model` (v:raw —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±–æ—è)
    *   `loadout` (–ø–æ—è—Å, –∞–±–∏–ª–∫–∏, –æ—Ä—É–∂–∏–µ)
    *   `vitals` (HP, Energy)

### `status`
*   **–¶–µ–ª—å:** –≠–∫—Ä–∞–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.
*   **–ó–∞–≥—Ä—É–∂–∞–µ—Ç:**
    *   attributes
    *   vitals
    *   symbiote
*   **Temp DTO:** `StatusTempContext`
*   **Computed Fields:**
    *   `stats_display` (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—ã –¥–ª—è UI)
    *   `vitals_display` (HP/Energy bars)

### `inventory`
*   **–¶–µ–ª—å:** UI –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è/—Ç–æ—Ä–≥–æ–≤–ª–∏.
*   **–ó–∞–≥—Ä—É–∂–∞–µ—Ç:**
    *   inventory (`all` items)
    *   wallet (`resource_wallets`)
*   **Temp DTO:** `InventoryTempContext`
*   **Computed Fields:**
    *   `items_by_slot` (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–ª–æ—Ç–∞–º)
    *   `wallet_display` (–≤–∞–ª—é—Ç–∞, —Ä–µ—Å—É—Ä—Å—ã, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã)

---

## ‚öñÔ∏è –û—Ç–ª–∏—á–∏—è –æ—Ç v1

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | –ë—ã–ª–æ (v1) | –°—Ç–∞–ª–æ (v2) |
| :--- | :--- | :--- |
| **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö** | –í—Å–µ–≥–¥–∞ bulk –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö | Conditional loading —á–µ—Ä–µ–∑ Scope |
| **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ DTO** | –û–¥–∏–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π `TempContextSchema` | –ò–µ—Ä–∞—Ä—Ö–∏—è —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö Temp DTO |
| **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ** | –¢–æ–ª—å–∫–æ –¥–ª—è –±–æ—è | –î–ª—è –ª—é–±–æ–≥–æ —Å–ª–æ—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è |

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ v2:**
1.  **–ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î** (–Ω–µ —Ç—è–Ω–µ–º –ª–∏—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ).
2.  **–ë—ã—Å—Ç—Ä–µ–µ –æ—Ç–∫–ª–∏–∫** (–º–µ–Ω—å—à–µ –¥–∞–Ω–Ω—ã—Ö = –±—ã—Å—Ç—Ä–µ–µ –æ–±—Ä–∞–±–æ—Ç–∫–∞).
3.  **–ß–∏—â–µ –∫–æ–¥** (–∫–∞–∂–¥—ã–π scope = —Å–≤–æ—è –ª–æ–≥–∏–∫–∞).
4.  **–õ–µ–≥—á–µ —Ä–∞—Å—à–∏—Ä—è—Ç—å** (–Ω–æ–≤—ã–π scope = –Ω–æ–≤—ã–π use case).

---

## üèóÔ∏è Architecture Highlights

### Pattern: Strategy + Facade
*   **Orchestrator** = Facade (–µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞).
*   **Assemblers** = Strategies (—Ä–∞–∑–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤).

### Pattern: Query Plan Builder
*   Scope ‚Üí –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü.
*   –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤.
*   –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (`asyncio.gather`).

### Pattern: DTO Hierarchy
*   `BaseTempContext` (–æ–±—â–∏–µ –ø–æ–ª—è).
*   –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã (—Å–≤–æ–∏ computed fields).
*   Computed fields = –ø—Ä–æ–µ–∫—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–∏—Å—Ç–µ–º.

---

## üö¶ Status

**Current Version:** 2.0-alpha

**Implemented:**
*   ‚úÖ Orchestrator (facade)
*   ‚úÖ PlayerAssembler (strategy)
*   ‚úÖ MonsterAssembler (strategy)
*   ‚úÖ Scope System (combats, status, inventory)
*   ‚úÖ Basic Temp DTO hierarchy

**In Progress:**
*   üöß Formatters Layer (–æ—Ç–ª–æ–∂–µ–Ω–æ)
*   üöß PetAssembler (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
*   üöß Migration tools (v1 ‚Üí v2)

**Roadmap:**
*   Full migration from v1
*   Performance benchmarks
*   Advanced scopes (exploration, trade, tutorial)

---

## üîó Related Systems
*   **Combat System v3** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å (`combats` scope).
*   **Status Service** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `status` scope.
*   **Inventory Service** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `inventory` scope.
*   **Scenario System** ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `exploration` scope.

---

## ü§ù Contributing
–ü–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ scope:
1.  –û–ø–∏—à–∏ use case –≤ `concepts/scope_system.md`.
2.  –û–ø—Ä–µ–¥–µ–ª–∏ —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü –≤ **Query Plan Builder**.
3.  –°–æ–∑–¥–∞–π Temp DTO (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω –Ω–æ–≤—ã–π).
4.  –î–æ–±–∞–≤—å –ø—Ä–∏–º–µ—Ä –≤ `integration_examples.md`.
