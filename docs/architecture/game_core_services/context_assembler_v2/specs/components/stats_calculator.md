# Stats Waterfall Calculator

## üìã –û–±–∑–æ—Ä

`StatsWaterfallCalculator` ‚Äî —ç—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –º–æ–Ω—Å—Ç—Ä–æ–≤. –û–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω "Waterfall Calculation", –≥–¥–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç—Ç–∞–ø–æ–≤.

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `apps/game_core/system/calculators/stats_waterfall_calculator.py`

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
1.  **–ê–≥—Ä–µ–≥–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:** –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, –±–æ–Ω—É—Å–æ–≤ –æ—Ç —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏, –±–∞—Ñ—Ñ–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
2.  **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è (Bridge):** –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (–°–∏–ª–∞, –õ–æ–≤–∫–æ—Å—Ç—å) –≤–æ –≤—Ç–æ—Ä–∏—á–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (–£—Ä–æ–Ω, –ö—Ä–∏—Ç).
3.  **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—É–ª:** –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"+10"`, `"*1.1"`).
4.  **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±—ä—è—Å–Ω–µ–Ω–∏–π:** –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö —Ñ–æ—Ä–º—É–ª –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ UI (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –æ—Ç–∫—É–¥–∞ –≤–∑—è–ª–æ—Å—å —á–∏—Å–ª–æ).

---

## üåä –õ–æ–≥–∏–∫–∞ –†–∞—Å—á–µ—Ç–∞ (Waterfall Flow)

–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—á–µ—Ç–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä–µ—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∞–∑:

### –§–∞–∑–∞ 1: –†–∞—Å—á–µ—Ç –ê—Ç—Ä–∏–±—É—Ç–æ–≤ (Primary Stats)
–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (Strength, Agility, etc.).

*   **–í—Ö–æ–¥:** `v:raw` -> `attributes`
*   **–õ–æ–≥–∏–∫–∞:**
    *   –ë–µ—Ä–µ—Ç—Å—è `base` –∑–Ω–∞—á–µ–Ω–∏–µ.
    *   –°–æ–±–∏—Ä–∞—é—Ç—Å—è –≤—Å–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏–∑ `source` (–ø—Ä–µ–¥–º–µ—Ç—ã) –∏ `temp` (–±–∞—Ñ—Ñ—ã).
    *   –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ñ–æ—Ä–º—É–ª–∞: `(Base + Sum(Flats)) * Product(Multipliers)`.
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–ª–æ—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å –∞—Ç—Ä–∏–±—É—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{"strength": 15.0}`).

### –§–∞–∑–∞ 2: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è (Derivation Bridge)
–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –∞—Ç—Ä–∏–±—É—Ç—ã –≤–ª–∏—è—é—Ç –Ω–∞ –≤—Ç–æ—Ä–∏—á–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º –∏–≥—Ä—ã.

*   **–í—Ö–æ–¥:** –§–∏–Ω–∞–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑ –§–∞–∑—ã 1.
*   **–ü—Ä–∞–≤–∏–ª–∞:** –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ `MODIFIER_RULES` (–ª–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è).
    *   –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–≤–∏–ª–∞: `Strength -> Physical Damage * 2.0`.
*   **–õ–æ–≥–∏–∫–∞:**
    *   –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.
    *   –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –±–æ–Ω—É—Å: `Attribute Value * Factor`.
    *   –ë–æ–Ω—É—Å –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫–∞–∫ `Flat` –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫ —Ü–µ–ª–µ–≤–æ–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–µ.
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–ª–æ–≤–∞—Ä—å –±–æ–Ω—É—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{"physical_damage": ["+30.0"]}`).

### –§–∞–∑–∞ 3: –†–∞—Å—á–µ—Ç –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (Secondary Stats)
–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –±–æ–µ–≤—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (Damage, Crit, Evasion).

*   **–í—Ö–æ–¥:**
    *   `v:raw` -> `modifiers` (–ø—Ä—è–º—ã–µ –±–æ–Ω—É—Å—ã –æ—Ç —à–º–æ—Ç–∞).
    *   –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –§–∞–∑—ã 2 (–±–æ–Ω—É—Å—ã –æ—Ç —Å—Ç–∞—Ç–æ–≤).
*   **–õ–æ–≥–∏–∫–∞:**
    *   –û–±—ä–µ–¥–∏–Ω—è—é—Ç—Å—è —Å–ø–∏—Å–∫–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –∏–∑ `Derived` (–æ—Ç —Å—Ç–∞—Ç–æ–≤), `Source` (–æ—Ç —à–º–æ—Ç–∞) –∏ `Temp`.
    *   –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ–æ—Ä–º—É–ª–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–ª–æ—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤.

---

## üßÆ –ê–ª–≥–æ—Ä–∏—Ç–º –í—ã—á–∏—Å–ª–µ–Ω–∏—è (Pipeline Evaluation)

–ú–µ—Ç–æ–¥ `_evaluate_pipeline` –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É. –û–Ω –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –∏ –±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã:**
*   `+X` : –î–æ–±–∞–≤–∏—Ç—å X (Flat Add).
*   `-X` : –û—Ç–Ω—è—Ç—å X (Flat Sub).
*   `*X` : –£–º–Ω–æ–∂–∏—Ç—å –Ω–∞ X (Multiplier).
*   `=X` : –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ X (Override). –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.

**–ü–æ—Ä—è–¥–æ–∫ –æ–ø–µ—Ä–∞—Ü–∏–π:**
1.  **–°–±–æ—Ä Flats:** –í—Å–µ –ø–ª—é—Å—ã –∏ –º–∏–Ω—É—Å—ã —Å—É–º–º–∏—Ä—É—é—Ç—Å—è —Å –±–∞–∑–æ–π.
    *   –§–æ—Ä–º—É–ª–∞: `(Base + Flat1 + Flat2 - Flat3)`
2.  **–°–±–æ—Ä Multipliers:** –í—Å–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –ø–µ—Ä–µ–º–Ω–æ–∂–∞—é—Ç—Å—è.
    *   –§–æ—Ä–º—É–ª–∞: `... * Mult1 * Mult2`
3.  **–ò—Ç–æ–≥–æ–≤–∞—è —Ñ–æ—Ä–º—É–ª–∞:** `(Sum of Flats) * (Product of Multipliers)`

**–ü—Ä–∏–º–µ—Ä:**
*   Base: 10
*   Mods: `["+5", "*1.5", "+2"]`
*   –†–∞—Å—á–µ—Ç: `(10 + 5 + 2) * 1.5 = 17 * 1.5 = 25.5`

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `simpleeval` –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∏–Ω—ä–µ–∫—Ü–∏–π –∫–æ–¥–∞.

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–∞–Ω–Ω—ã—Ö

### –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (v:raw)
```json
{
  "attributes": {
    "strength": {
      "base": 10.0,
      "source": {"item:sword": "+5"},
      "temp": {"buff:rage": "*1.2"}
    }
  },
  "modifiers": {
    "crit_chance": {
      "base": 0.05,
      "source": {"item:ring": "+0.02"}
    }
  }
}
```

### –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
–ú–µ—Ç–æ–¥ `calculate_waterfall` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ –∏–∑ –¥–≤—É—Ö —Å–ª–æ–≤–∞—Ä–µ–π:

1.  **Cache Result (Values):**
    ```json
    {
      "strength": 18.0,
      "crit_chance": 0.07,
      "physical_damage": 36.0
    }
    ```

2.  **Explanation Result (Formulas):**
    ```json
    {
      "strength": "(10.0 + 5) * 1.2",
      "crit_chance": "(0.05 + 0.02)",
      "physical_damage": "(0 + 36.0)"
    }
    ```

---

## üõ† API

### `calculate_waterfall(raw_data: dict) -> tuple`
–û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.

### `evaluate_sources(sources: dict | list, base_value: float) -> tuple`
–ü—É–±–ª–∏—á–Ω—ã–π —Ö–µ–ª–ø–µ—Ä –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, HP –∏–ª–∏ XP).
*   –ü–æ–ª–µ–∑–µ–Ω –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è —á–∞—Å—Ç—å—é —Å—Ç–∞—Ç–æ–≤, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤.

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1.  **–õ–µ–Ω–∏–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:** –ü—Ä–∞–≤–∏–ª–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ (`MODIFIER_RULES`) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –∫–ª–∞—Å—Å—É –∏ –∫–µ—à–∏—Ä—É—é—Ç—Å—è –≤ `_SOURCE_TO_TARGET_RULES`.
2.  **–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ:** –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–∫—Ä—É–≥–ª—è—é—Ç—Å—è –¥–æ 4 –∑–Ω–∞–∫–æ–≤ –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π.
3.  **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** –ï—Å–ª–∏ —Ñ–æ—Ä–º—É–ª–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `0.0` –∏ –ø–∏—à–µ—Ç—Å—è –ª–æ–≥ –æ—à–∏–±–∫–∏, —á—Ç–æ–±—ã –Ω–µ –∫—Ä–∞—à–∏—Ç—å –±–æ–π.
