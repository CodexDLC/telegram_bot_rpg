# Scope System: The Core Mechanic

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥ –∫ Concepts](./README.md) | üè† [–ù–∞–∑–∞–¥ –∫ Context Assembler v2](../README.md)

**Scope System** ‚Äî —ç—Ç–æ –∫–ª—é—á–µ–≤–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞ Context Assembler v2. –û–¥–∏–Ω —Ñ–ª–∞–≥, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

---

## –ß—Ç–æ —Ç–∞–∫–æ–µ Scope?
**Scope** ‚Äî —ç—Ç–æ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ —Ç–æ–º, –¥–ª—è —á–µ–≥–æ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ.
–≠—Ç–æ –Ω–µ —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü. –≠—Ç–æ –Ω–µ —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π. –≠—Ç–æ **—Ü–µ–ª—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è**.

**–ü—Ä–∏–º–µ—Ä—ã —Ü–µ–ª–µ–π:**
*   –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –±–æ—é (`combats`)
*   –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (`status`)
*   –û—Ç–∫—Ä—ã—Ç–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è (`inventory`)
*   –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–≤—ã–∫–∞ –≤ –¥–∏–∞–ª–æ–≥–µ (`exploration`)
*   –û—Ü–µ–Ω–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ —Ç–æ—Ä–≥–æ–≤–ª–µ (`trade`)

Scope –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å: **"–ß—Ç–æ —Ç—ã —Å–æ–±–∏—Ä–∞–µ—à—å—Å—è –¥–µ–ª–∞—Ç—å —Å —ç—Ç–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏?"**

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç Scope?

### –¶–µ–ø–æ—á–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π
1.  **–ó–∞–∫–∞–∑—á–∏–∫** —É–∫–∞–∑—ã–≤–∞–µ—Ç `scope`
    *   ‚Üì
2.  **Query Plan Builder** —á–∏—Ç–∞–µ—Ç `scope`
    *   ‚Üì
3.  **Query Plan Builder** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
    *   ‚Üì
4.  **Assembler** –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ —ç—Ç–∏–º —Ç–∞–±–ª–∏—Ü–∞–º
    *   ‚Üì
5.  **Assembler** –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç Temp DTO –Ω–∞ –æ—Å–Ω–æ–≤–µ `scope`
    *   ‚Üì
6.  **Temp DTO** —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –Ω—É–∂–Ω—ã–µ computed fields
    *   ‚Üì
7.  **Assembler** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Redis **—Ç–æ–ª—å–∫–æ** computed fields (exclude core_*)

### –ö–ª—é—á–µ–≤–æ–π –ø—Ä–∏–Ω—Ü–∏–ø
**–û–¥–∏–Ω scope = –æ–¥–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞**
–ó–∞–∫–∞–∑—á–∏–∫—É –Ω–µ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å:
*   –ö–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —á–∏—Ç–∞—Ç—å
*   –í –∫–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ
*   –ö–∞–∫–∏–µ –¥–∂–æ–π–Ω—ã –¥–µ–ª–∞—Ç—å
*   –ö–∞–∫–æ–π DTO –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∫–∞–∑–∞—Ç—å: `scope="combats"`. –í—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî –∑–∞–±–æ—Ç–∞ —Å–∏—Å—Ç–µ–º—ã.

---

## Scope Reference (–ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫)

### `combats`
*   **–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±–æ–µ–≤–æ–π —Å–µ—Å—Å–∏–∏
*   **–ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
    *   `character_attributes` (–±–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç—ã)
    *   `inventory_items` WHERE location='equipped' (—Ç–æ–ª—å–∫–æ –Ω–∞–¥–µ—Ç–æ–µ)
    *   `character_skill_progress` (–≤—Å–µ –Ω–∞–≤—ã–∫–∏)
    *   `character_symbiotes` (—Å–∏–º–±–∏–æ—Ç –∏ –¥–∞—Ä)
    *   Redis: `accounts:vitals` (HP, Energy)
*   **Temp DTO:** `CombatTempContext`
*   **Computed Fields:**
    *   `math_model` ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ v:raw –¥–ª—è –±–æ–µ–≤–æ–≥–æ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
    *   `loadout` ‚Äî –ø–æ—è—Å, –∞–±–∏–ª–∫–∏, –æ—Ä—É–∂–∏–µ
    *   `vitals` ‚Äî HP/Energy –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –±–æ—è
*   **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
    ```python
    request = ContextRequestDTO(
        player_ids=[101, 102],
        monster_ids=["uuid-mob-1"],
        scope="combats"
    )
    ```
*   **–ö—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:**
    *   `CombatEntryOrchestrator` (—Å–æ–∑–¥–∞–Ω–∏–µ –±–æ—è)
    *   `CombatLifecycleService` (hot join –≤ –±–æ–π)

### `status`
*   **–¶–µ–ª—å:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ (Status Screen)
*   **–ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
    *   `character_attributes`
    *   `character_symbiotes`
    *   Redis: `accounts:vitals`
*   **Temp DTO:** `StatusTempContext`
*   **Computed Fields:**
    *   `stats_display` ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∞—Ç—ã –¥–ª—è UI (–°–∏–ª–∞: 15, –õ–æ–≤–∫–æ—Å—Ç—å: 12)
    *   `vitals_display` ‚Äî HP/Energy –±–∞—Ä—ã —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏
    *   `symbiote_info` ‚Äî –∏–º—è, –¥–∞—Ä, —Ä–∞–Ω–≥
*   **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
    ```python
    request = ContextRequestDTO(
        player_ids=[101],
        scope="status"
    )
    ```
*   **–ö—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:**
    *   `StatusService` (–ø–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞)
    *   `CharacterMenuHandler` (UI –º–µ–Ω—é –ø–µ—Ä—Å–æ–Ω–∞–∂–∞)
*   **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:**
    *   **–ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç** `inventory` –∏ `skills` ‚Äî —ç—Ç–æ —ç–∫–æ–Ω–æ–º–∏—Ç ~60% –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å `combats`.

### `inventory`
*   **–¶–µ–ª—å:** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏
*   **–ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
    *   `inventory_items` WHERE location IN ('inventory', 'equipped') (–≤–µ—Å—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å)
    *   `resource_wallets` (–∫–æ—à–µ–ª—ë–∫)
*   **Temp DTO:** `InventoryTempContext`
*   **Computed Fields:**
    *   `items_by_slot` ‚Äî –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Å–ª–æ—Ç–∞–º (head_armor, main_hand, ring_1)
    *   `items_by_type` ‚Äî –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º (weapon, armor, consumable)
    *   `wallet_display` ‚Äî –≤–∞–ª—é—Ç–∞, —Ä–µ—Å—É—Ä—Å—ã, –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
*   **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
    ```python
    request = ContextRequestDTO(
        player_ids=[101],
        scope="inventory"
    )
    ```
*   **–ö—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:**
    *   `InventoryService` (UI –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è)
    *   `TradeService` (–æ—Ü–µ–Ω–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤)
    *   `CraftingService` (–ø—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤)
*   **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:**
    *   **–ù–ï –∑–∞–≥—Ä—É–∂–∞–µ—Ç** `attributes` –∏ `skills` ‚Äî —Ñ–æ–∫—É—Å —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç–∞—Ö.

### `exploration` (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–≤—ã–∫–æ–≤ –∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –≤ –º–∏—Ä–µ (–¥–∏–∞–ª–æ–≥–∏, –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è)
*   **–ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
    *   `character_attributes`
    *   `character_skill_progress` (—Ç–æ–ª—å–∫–æ unlocked)
    *   Redis: `accounts:vitals` (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
*   **Temp DTO:** `ExplorationTempContext`
*   **Computed Fields:**
    *   `check_modifiers` ‚Äî –±–æ–Ω—É—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–æ–∫ (Perception +5, Luck +2)
    *   `available_actions` ‚Äî —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–≤—ã–∫–æ–≤
*   **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
    ```python
    request = ContextRequestDTO(
        player_ids=[101],
        scope="exploration"
    )
    ```
*   **–ö—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:**
    *   `ScenarioService` (–ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ –∫–≤–µ—Å—Ç–∞—Ö)
    *   `WorldService` (–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –æ–±—ä–µ–∫—Ç–∞–º–∏)
    *   `DialogueService` (—Å–∫–∏–ª–ª-—á–µ–∫–∏ –≤ –¥–∏–∞–ª–æ–≥–∞—Ö)
*   **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:**
    *   –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ (`is_unlocked=True`).

### `trade` (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
*   **–¶–µ–ª—å:** –¢–æ—Ä–≥–æ–≤–ª—è –∏ –æ–±–º–µ–Ω –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏
*   **–ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
    *   `character_attributes` (Charisma –¥–ª—è —Å–∫–∏–¥–æ–∫)
    *   `inventory_items` (–ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏)
    *   `resource_wallets` (–¥–µ–Ω—å–≥–∏)
*   **Temp DTO:** `TradeTempContext`
*   **Computed Fields:**
    *   `tradeable_items` ‚Äî —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –ø—Ä–æ–¥–∞—Ç—å
    *   `merchant_bonus` ‚Äî —Å–∫–∏–¥–∫–∞ –æ—Ç Charisma
    *   `wallet_balance` ‚Äî —Ç–µ–∫—É—â–∏–µ –¥–µ–Ω—å–≥–∏
*   **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
    ```python
    request = ContextRequestDTO(
        player_ids=[101],
        scope="trade"
    )
    ```
*   **–ö—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:**
    *   `TradeService` (—Ç–æ—Ä–≥–æ–≤–ª—è —Å NPC)
    *   `AuctionService` (–∞—É–∫—Ü–∏–æ–Ω –º–µ–∂–¥—É –∏–≥—Ä–æ–∫–∞–º–∏)
    *   `MerchantService` (–º–∞–≥–∞–∑–∏–Ω—ã)

### `tutorial` (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)
*   **–¶–µ–ª—å:** –û–±—É—á–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)
*   **–ó–∞–≥—Ä—É–∂–∞–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
    *   `character_attributes`
    *   Redis: `accounts:vitals`
*   **Temp DTO:** `TutorialTempContext`
*   **Computed Fields:**
    *   `simple_stats` ‚Äî —É–ø—Ä–æ—â—ë–Ω–Ω—ã–µ —Å—Ç–∞—Ç—ã (–±–µ–∑ –¥–µ—Ç–∞–ª–µ–π)
    *   `tutorial_progress` ‚Äî —Ñ–ª–∞–≥–∏ –æ–±—É—á–µ–Ω–∏—è
*   **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
    ```python
    request = ContextRequestDTO(
        player_ids=[101],
        scope="tutorial"
    )
    ```
*   **–ö—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:**
    *   `TutorialService` (–æ–Ω–±–æ—Ä–¥–∏–Ω–≥)
    *   `FirstQuestService` (–ø–µ—Ä–≤—ã–π –∫–≤–µ—Å—Ç)
*   **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:**
    *   –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤.

---

## –¢–∞–±–ª–∏—Ü–∞ –º–∞–ø–ø–∏–Ω–≥–∞ Scope ‚Üí Data Loaded (Input)

| Scope | Attributes | Inventory | Skills | Vitals | Symbiote | Wallet |
| :--- | :---: | :---: | :---: | :---: | :---: | :---: |
| **combats** | ‚úÖ Full | ‚úÖ Equipped | ‚úÖ All | ‚úÖ | ‚úÖ | ‚ùå |
| **status** | ‚úÖ Full | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚ùå |
| **inventory** | ‚ùå | ‚úÖ All | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| **exploration** | ‚úÖ Full | ‚ùå | ‚úÖ Unlocked | ‚úÖ | ‚ùå | ‚ùå |
| **trade** | ‚úÖ Partial (CHA) | ‚úÖ All | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |
| **tutorial** | ‚úÖ Simple | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå |

**–õ–µ–≥–µ–Ω–¥–∞:**
*   ‚úÖ Full ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –ø–æ–ª—è
*   ‚úÖ Partial ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ —á–∞—Å—Ç—å –ø–æ–ª–µ–π
*   ‚úÖ Equipped ‚Äî —Ç–æ–ª—å–∫–æ –Ω–∞–¥–µ—Ç—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
*   ‚úÖ Unlocked ‚Äî —Ç–æ–ª—å–∫–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞–≤—ã–∫–∏
*   ‚ùå ‚Äî –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º

---

## –¢–∞–±–ª–∏—Ü–∞ –º–∞–ø–ø–∏–Ω–≥–∞ Scope ‚Üí Output Projections (Redis)

| Scope | Projections (Computed Fields) |
| :--- | :--- |
| **combats** | `math_model`, `loadout`, `vitals`, `meta` |
| **status** | `stats_display`, `vitals_display`, `symbiote_info`, `meta` |
| **inventory** | `items_by_slot`, `items_by_type`, `wallet_display`, `meta` |
| **exploration** | `check_modifiers`, `available_actions`, `meta` |
| **trade** | `tradeable_items`, `merchant_bonus`, `wallet_balance`, `meta` |

**–í–∞–∂–Ω–æ:**
*   –í Redis –ø–æ–ø–∞–¥–∞—é—Ç **–¢–û–õ–¨–ö–û** —ç—Ç–∏ –ø–æ–ª—è.
*   –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (`core_attributes`, `core_inventory` –∏ —Ç.–¥.) **–ù–ï —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è**.

---

## –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π Scope?

### –®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª—å
–û—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã:
1.  –î–ª—è –∫–∞–∫–æ–≥–æ –º–æ–¥—É–ª—è –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ?
2.  –ö–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è?
3.  –ö–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω—ã?

### –®–∞–≥ 2: –°–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
–í—ã–±–µ—Ä–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä —Ç–∞–±–ª–∏—Ü, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫—Ä—ã–≤–∞–µ—Ç use case.
**–ü—Ä–∞–≤–∏–ª–æ:** –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è, –Ω—É–∂–Ω–∞ –ª–∏ —Ç–∞–±–ª–∏—Ü–∞ ‚Äî –Ω–µ –≤–∫–ª—é—á–∞–π. –õ—É—á—à–µ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Ç–æ–º, —á–µ–º –≥—Ä—É–∑–∏—Ç—å –ª–∏—à–Ω–µ–µ.

### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å –≤ Query Plan Builder
```python
# apps/game_core/system/context_assembler/logic/query_plan.py

QUERY_PLANS = {
    "combats": ["attributes", "inventory", "skills", "vitals", "symbiote"],
    "status": ["attributes", "vitals", "symbiote"],
    "inventory": ["inventory", "wallet"],
    "my_new_scope": ["attributes", "skills"],  # –ù–æ–≤—ã–π scope
}
```

### –®–∞–≥ 4: –†–µ—à–∏—Ç—å –ø—Ä–æ Temp DTO
–í–∞—Ä–∏–∞–Ω—Ç—ã:
1.  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π DTO (–µ—Å–ª–∏ –ø–æ–¥—Ö–æ–¥–∏—Ç)
2.  –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π DTO (–Ω–∞—Å–ª–µ–¥–Ω–∏–∫ `BaseTempContext`)

### –®–∞–≥ 5: –î–æ–±–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ scope ‚Üí DTO
```python
# apps/game_core/system/context_assembler/schemas/

def select_dto_class(scope: str):
    dto_map = {
        "combats": CombatTempContext,
        "status": StatusTempContext,
        "inventory": InventoryTempContext,
        "my_new_scope": MyNewTempContext,  # –ù–æ–≤—ã–π DTO
    }
    return dto_map.get(scope, BaseTempContext)
```

### –®–∞–≥ 6: –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
–î–æ–±–∞–≤—å –æ–ø–∏—Å–∞–Ω–∏–µ scope –≤ —ç—Ç–æ—Ç —Ñ–∞–π–ª (Scope Reference).

### –®–∞–≥ 7: –¢–µ—Å—Ç
–ù–∞–ø–∏—à–∏ integration test:
```python
async def test_my_new_scope():
    request = ContextRequestDTO(
        player_ids=[101],
        scope="my_new_scope"
    )
    response = await context_assembler.get_entry_point(
        action="assemble",
        context=request.model_dump()
    )
    
    assert response.player[101].startswith("temp:setup:")
    
    # –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    context = await redis.json().get(response.player[101])
    assert "core_attributes" in context
    assert "core_skills" in context
    assert "core_inventory" not in context  # –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å
```

---

## –ê–Ω—Ç–∏-–ø–∞—Ç—Ç–µ—Ä–Ω—ã

### ‚ùå –ù–µ —Å–æ–∑–¥–∞–≤–∞–π scope –¥–ª—è –æ–¥–Ω–æ–π —Ñ–∏—á–∏
**–ü–ª–æ—Ö–æ:**
```python
scope="open_chest"  # –°–ª–∏—à–∫–æ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ
scope="talk_to_npc_bob"  # –í–æ–æ–±—â–µ –Ω–µ scope
```
**–•–æ—Ä–æ—à–æ:**
```python
scope="exploration"  # –ü–æ–∫—Ä—ã–≤–∞–µ—Ç –º–Ω–æ–≥–æ use cases
```
Scope –¥–æ–ª–∂–µ–Ω –ø–æ–∫—Ä—ã–≤–∞—Ç—å **–∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π**, –∞ –Ω–µ –æ–¥–Ω–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.

### ‚ùå –ù–µ –¥—É–±–ª–∏—Ä—É–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ scope
–ï—Å–ª–∏ –µ—Å—Ç—å `scope=inventory`, –Ω–µ —Å–æ–∑–¥–∞–≤–∞–π `scope=crafting` —Å —Ç–µ–º–∏ –∂–µ —Ç–∞–±–ª–∏—Ü–∞–º–∏.
–ò—Å–ø–æ–ª—å–∑—É–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π scope –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –¥–µ—Ç–∞–ª–∏ –≤ —Å–≤–æ—ë–º —Å–µ—Ä–≤–∏—Å–µ.

### ‚ùå –ù–µ –¥–µ–ª–∞–π scope=full
–≠—Ç–æ –≤–æ–∑–≤—Ä–∞—Ç –∫ –ø—Ä–æ–±–ª–µ–º–∞–º v1. –ï—Å–ª–∏ —Ç–µ–±–µ –Ω—É–∂–Ω—ã –≤—Å–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Å–≤–æ–µ–≥–æ –º–æ–¥—É–ª—è.
–í–æ–∑–º–æ–∂–Ω–æ, —Ç–µ–±–µ –Ω—É–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ scope –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π.

---

## –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–ª—é—á–µ–π
–ï—Å–ª–∏ –¥–≤–∞ –º–æ–¥—É–ª—è –∑–∞–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π scope –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –ø–æ–¥—Ä—è–¥, –≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª—é—á (–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∏).

**–ü—Ä–∏–º–µ—Ä:**
```python
# –ó–∞–ø—Ä–æ—Å 1 (Status Screen)
response1 = await assembler.assemble(player_ids=[101], scope="status")
# –ü–æ–ª—É—á–∏–ª–∏: temp:setup:uuid-1

# –ó–∞–ø—Ä–æ—Å 2 (–¥—Ä—É–≥–æ–π —Ö—ç–Ω–¥–ª–µ—Ä, —Ç–æ—Ç –∂–µ scope)
# –ú–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ temp:setup:uuid-1 –∏ –Ω–µ –∏—Å—Ç—ë–∫ –ª–∏ TTL
# –ï—Å–ª–∏ –¥–∞ ‚Äî –≤–µ—Ä–Ω—É—Ç—å –µ–≥–æ, –Ω–µ –¥–µ–ª–∞—è –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î
```
*–≠—Ç–æ –±—É–¥—É—â–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (v2.1).*

### Partial Updates
–ï—Å–ª–∏ `scope=combats` —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∞ –ø–æ—Ç–æ–º –Ω—É–∂–µ–Ω `scope=status` (–ø–æ–¥–º–Ω–æ–∂–µ—Å—Ç–≤–æ), –º–æ–∂–Ω–æ –Ω–µ –¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, –∞ –ø—Ä–æ—Å—Ç–æ –≤–∑—è—Ç—å –Ω—É–∂–Ω—ã–µ –ø–æ–ª—è –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
–≠—Ç–æ —Ç—Ä–µ–±—É–µ—Ç logic –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è "scope A —Å–æ–¥–µ—Ä–∂–∏—Ç scope B".
*–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –≤ v2.2.*

---

## –ò—Ç–æ–≥
**Scope System** ‚Äî —ç—Ç–æ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ —Å–ª–æ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
–¢—ã –≥–æ–≤–æ—Ä–∏—à—å "—á—Ç–æ –Ω—É–∂–Ω–æ" (scope), —Å–∏—Å—Ç–µ–º–∞ —Ä–µ—à–∞–µ—Ç "–∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å" (Query Plan, DTO, Formatters).
–≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ —á–∏—â–µ, —Å–∏—Å—Ç–µ–º—É –≥–∏–±—á–µ, –∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã—à–µ.
**–û–¥–∏–Ω —Ñ–ª–∞–≥. –í—Å—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è. –ù–∏–∫–∞–∫–æ–π –º–∞–≥–∏–∏.**
