# Weapon Triggers (–¢—Ä–∏–≥–≥–µ—Ä—ã –æ—Ä—É–∂–∏—è)

## üìã –û–±–∑–æ—Ä

–¢—Ä–∏–≥–≥–µ—Ä—ã –æ—Ä—É–∂–∏—è ‚Äî —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö (–æ–±—ã—á–Ω–æ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —É–¥–∞—Ä–µ) –∏ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–∏–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –æ—Ä—É–∂–∏—è.

**–§–∏–ª–æ—Å–æ—Ñ–∏—è:**
–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–¥–∞—Ä —Å–∞–º –ø–æ —Å–µ–±–µ —è–≤–ª—è–µ—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–º.
*   **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫—Ä–∏—Ç:** –≠—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º "–£–º–Ω–æ–∂–µ–Ω–∏–µ —É—Ä–æ–Ω–∞" (–æ–±—ã—á–Ω–æ x2).
*   **–°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã:** –û—Ä—É–∂–∏–µ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç:
    *   –ó–∞–º–µ–Ω—è—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å —É—Ä–æ–Ω–∞ –Ω–∞ –¥—Ä—É–≥–æ–π —ç—Ñ—Ñ–µ–∫—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, Stun).
    *   –î–æ–±–∞–≤–ª—è—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É –º–Ω–æ–∂–∏—Ç–µ–ª—é.
    *   –ò–∑–º–µ–Ω—è—Ç—å —Å–∞–º –º–Ω–æ–∂–∏—Ç–µ–ª—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, x3 –≤–º–µ—Å—Ç–æ x2).

**–ö–ª—é—á–µ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ:**
–¢—Ä–∏–≥–≥–µ—Ä –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ —Å–æ–±—ã—Ç–∏–∏ `ON_CRIT`. –ï—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `crit_damage_boost = False`, —Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —É–º–Ω–æ–∂–µ–Ω–∏–µ —É—Ä–æ–Ω–∞ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –ø–æ–ª—å–∑—É —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞.

## ‚öôÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ DTO

```python
from pydantic import BaseModel
from typing import Any

class TriggerDTO(BaseModel):
    trigger_id: str             # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (–Ω–∞–ø—Ä–∏–º–µ—Ä, "sword_crit_bleed")
    weapon_class: str           # –ö–ª–∞—Å—Å –æ—Ä—É–∂–∏—è ("skill_swords", "skill_macing")
    
    event: str                  # –°–æ–±—ã—Ç–∏–µ: "ON_CRIT", "ON_HIT", "ON_DODGE"
    flag_name: str              # –ò–º—è —Ñ–ª–∞–≥–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ ("trigger_bleed")
    effect_id: str | None       # ID —ç—Ñ—Ñ–µ–∫—Ç–∞ –¥–ª—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è ("bleed") –∏–ª–∏ None
    
    # –ú—É—Ç–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏
    # –ü—Ä–∏–º–µ—Ä: {"crit_damage_boost": False}
    mutations: dict[str, Any] = {}
    
    description: str
```

### –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

#### 1. Heavy Strike (x3 Damage)
–¢—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ—Å—Ç–æ –¥–∞–µ—Ç –æ–≥—Ä–æ–º–Ω—ã–π —É—Ä–æ–Ω, –Ω–æ –Ω–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **Polearms** (–î—Ä–µ–≤–∫–æ–≤–æ–µ), —Ç–∞–∫ –∫–∞–∫ Axes —É–¥–∞–ª–µ–Ω—ã.

```python
heavy_crit_trigger = TriggerDTO(
    trigger_id="polearm_heavy_crit",
    weapon_class="skill_polearms",  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: skill_axes -> skill_polearms
    event="ON_CRIT",
    flag_name="trigger_heavy_crit",
    effect_id=None,
    mutations={
        "crit_damage_boost": True,   # –û—Å—Ç–∞–≤–ª—è–µ–º –±—É—Å—Ç —É—Ä–æ–Ω–∞
        "crit_multiplier": 3.0       # –ù–æ –º–µ–Ω—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª—å –Ω–∞ x3
    },
    description="–°–æ–∫—Ä—É—à–∏—Ç–µ–ª—å–Ω—ã–π —É–¥–∞—Ä –∞–ª–µ–±–∞—Ä–¥–æ–π, –Ω–∞–Ω–æ—Å—è—â–∏–π —Ç—Ä–æ–π–Ω–æ–π —É—Ä–æ–Ω."
)
```

#### 2. Bleed (No Bonus Damage)
–ö—Ä–∏—Ç –º–µ—á–æ–º –Ω–µ –Ω–∞–Ω–æ—Å–∏—Ç –¥–≤–æ–π–Ω–æ–π —É—Ä–æ–Ω, –Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–∏–ª—å–Ω–æ–µ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ.

```python
sword_trigger = TriggerDTO(
    trigger_id="sword_crit_bleed",
    weapon_class="skill_swords",
    event="ON_CRIT",
    flag_name="trigger_bleed",
    effect_id="bleed",
    mutations={"crit_damage_boost": False}, # –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π x2
    description="–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–¥–∞—Ä –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç –≥–ª—É–±–æ–∫–æ–µ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –±–æ–Ω—É—Å–∞ —É—Ä–æ–Ω–∞."
)
```

#### 3. Stun (No Bonus Damage)
–ö—Ä–∏—Ç –º–æ–ª–æ—Ç–æ–º –æ–≥–ª—É—à–∞–µ—Ç —Ü–µ–ª—å, –Ω–æ –Ω–µ –Ω–∞–Ω–æ—Å–∏—Ç –¥–≤–æ–π–Ω–æ–π —É—Ä–æ–Ω.

```python
mace_trigger = TriggerDTO(
    trigger_id="macing_crit_stun",
    weapon_class="skill_macing",
    event="ON_CRIT",
    flag_name="trigger_stun",
    effect_id="stun",
    mutations={"crit_damage_boost": False}, # –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π x2
    description="–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–¥–∞—Ä –æ–≥–ª—É—à–∞–µ—Ç —Ü–µ–ª—å, —Å–±–∏–≤–∞—è –¥—ã—Ö–∞–Ω–∏–µ."
)
```

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ–µ–≤—É—é —Å–∏—Å—Ç–µ–º—É

### 1. –ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞ (ContextBuilder)
–ü–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º —É–¥–∞—Ä–∞ —Å–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–æ–π —Ç—Ä–∏–≥–≥–µ—Ä —Å–≤—è–∑–∞–Ω —Å –æ—Ä—É–∂–∏–µ–º –∞—Ç–∞–∫—É—é—â–µ–≥–æ.

```python
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–≤—ã–∫ –æ—Ä—É–∂–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "skill_swords")
weapon_skill = actor.loadout.layout.get("main_hand") 

# –ò—â–µ–º —Ç—Ä–∏–≥–≥–µ—Ä
trigger = get_weapon_trigger(weapon_skill)
if trigger:
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞
    setattr(ctx.triggers, trigger.flag_name, True)
```

### 2. –†–µ–∑–æ–ª–≤–∏–Ω–≥ (CombatResolver)
–í –º–æ–º–µ–Ω—Ç –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, `is_crit == True`) –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º—É—Ç–∞—Ü–∏–∏.

```python
if result.is_crit:
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –ª–æ–≥–∏–∫—É —Ç—Ä–∏–≥–≥–µ—Ä–∞
    CombatResolver._resolve_triggers(ctx, result, "ON_CRIT")
    
    # –õ–æ–≥–∏–∫–∞ –≤–Ω—É—Ç—Ä–∏ _resolve_triggers:
    # –ï—Å–ª–∏ trigger.mutations["crit_damage_boost"] == False -> result.crit_mod = 1.0
    # –ï—Å–ª–∏ trigger.mutations["crit_multiplier"] == 3.0 -> result.crit_mod = 3.0
```

### 3. –ù–∞–ª–æ–∂–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (AbilityService / Post-Process)
–ü–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ —É—Ä–æ–Ω–∞, –µ—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–ª –∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å `effect_id`, –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç.

```python
if ctx.triggers.trigger_bleed and result.is_crit:
    apply_effect(target, "bleed")
```

## üì¶ Registry & Rules

### TRIGGER_RULES
–°–ª–æ–≤–∞—Ä—å –ø—Ä–∞–≤–∏–ª –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –º—É—Ç–∞—Ü–∏–π –≤–Ω—É—Ç—Ä–∏ —Ä–µ–∑–æ–ª–≤–µ—Ä–∞.

```python
TRIGGER_RULES = {
    "ON_CRIT": {
        "trigger_bleed": {
            "chance": 1.0,
            "mutations": {"crit_damage_boost": False}
        },
        "trigger_heavy_crit": {
            "chance": 1.0,
            "mutations": {"crit_damage_boost": True, "crit_multiplier": 3.0}
        }
    }
}
```

### Registry Access
```python
# apps/game_core/resources/game_data/triggers/__init__.py

TRIGGER_REGISTRY: dict[str, TriggerDTO] = {
    "sword_crit_bleed": sword_trigger,
    "polearm_heavy_crit": heavy_crit_trigger,
    # ...
}

def get_weapon_trigger(weapon_class: str) -> TriggerDTO | None:
    """–ü–æ–∏—Å–∫ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –ø–æ –∫–ª–∞—Å—Å—É –æ—Ä—É–∂–∏—è."""
    for trigger in TRIGGER_REGISTRY.values():
        if trigger.weapon_class == weapon_class:
            return trigger
    return None
```
