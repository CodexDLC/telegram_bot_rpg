# Design Document: Система быстрой проверки уникальности никнеймов

**Статус:** Draft (Architect Mode)  
**Компонент:** Account Domain / Identity Service  
**Технологии:** Redis (Bitset), Python (Hashlib/MurmurHash)

---

## 1. Цель (Problem Statement)
Снизить нагрузку на основную базу данных при массовых запросах на проверку доступности никнеймов (ввод в реальном времени, регистрации, веб-витрины).

---

## 2. Архитектурная концепция
Использование **Фильтра Блума** на базе Redis. Система дает два типа ответов:
1. **"Точно нет" (0):** Никнейма нет в базе. Запрос в БД не требуется.
2. **"Возможно да" (1):** Никнейм может быть занят. Требуется контрольная проверка в основной БД.

---

## 3. Схема данных (Redis)

* **Тип ключа:** String (используется как битовый массив через команды `GETBIT`/`SETBIT`).
* **Название ключа:** `accounts:nickname_filter`
* **Параметры:**
  * **Количество хеш-функций:** 3.
  * **Размер массива ($m$):** Рассчитывается из формулы $m \approx 10 \times n$ (где $n$ — ожидаемое кол-во игроков). Для 1 млн игроков — ~10 Мбит (1.25 МБ).

---

## 4. Алгоритм работы (Workflow)

### А. Проверка ника (Check)
1. Принимаем `input_nickname`.
2. Нормализуем (приводим к нижнему регистру: `user` == `User`).
3. Вычисляем 3 индекса (хеша) внутри размера $m$.
4. Выполняем `GETBIT` для каждого индекса в Redis.
5. **Результат:**
   * Если хотя бы один бит = 0 $\rightarrow$ Возвращаем **Status: Available**.
   * Если все биты = 1 $\rightarrow$ Выполняем `SELECT EXISTS` в БД.

### Б. Регистрация нового ника (Write)
1. Записываем юзера в основную БД.
2. При успешной записи вычисляем те же 3 индекса.
3. Выполняем `SETBIT key index 1` для каждого индекса в Redis.

### В. Инициализация (Cold Start / Recovery)
1. Если Redis пуст (ключ отсутствует):
   * Запуск фонового скрипта (Worker).
   * Чтение всех `nickname` из БД порциями (Cursors).
   * Заполнение битового массива в Redis (Pipeline).

---

## 5. Риски и ограничения

* **Ложноположительные срабатывания:** При заполнении фильтра более чем на 50%, частота «пустых» походов в БД вырастет.
  * *Решение:* периодический пересчет или увеличение размера $m$.
* **Удаление:** Обычный фильтр Блума не поддерживает удаление. Если игрок удален, его ник будет считаться "занятым" (потребует проверки в БД), пока массив не будет пересобран с нуля.
