# üß† Menu Session Service

‚¨ÖÔ∏è [Back to Game Menu](../README.md)

> **Layer:** Internal Service / Data Access
> **Responsibility:** –ß—Ç–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–∞ –∏–∑ Redis, –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (Regen) –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤.

## 1. Purpose
–°–µ—Ä–≤–∏—Å —Å–ª—É–∂–∏—Ç –ø—Ä–æ—Å–ª–æ–π–∫–æ–π –º–µ–∂–¥—É –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π –º–µ–Ω—é –∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º Redis (`AccountManager`).
–ï–≥–æ –∫–ª—é—á–µ–≤–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –æ–±–µ—Å–ø–µ—á–∏—Ç—å –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ **–∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** (–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º).

## 2. Dependencies
*   **AccountManager:** –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ Redis.
*   **Regen Utility:** `backend.services.utils.regen.calculate_regen` (–ß–∏—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞).
*   **Redis Key:** `ac:{char_id}` (Hash).

## 3. Methods

### 3.1. `get_player_context(char_id: int) -> MenuContextDTO`
–°–æ–±–∏—Ä–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é, —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–º —Ä–∞—Å—á–µ—Ç–æ–º —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

*   **Logic:**
    1.  **Fetch Data:** –í—ã–∑—ã–≤–∞–µ—Ç `AccountManager.get_account_data(char_id)`.
    2.  **Check Existence (Fail-safe):**
        *   –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã (`None`), –∑–Ω–∞—á–∏—Ç —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∞.
        *   **Action:** –ë—Ä–æ—Å–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `SessionExpiredException`.
        *   *Gateway –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç —ç—Ç–æ –∏ –≤–µ—Ä–Ω–µ—Ç –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç –≤ Lobby.*
    3.  **Lazy Regen:**
        *   –ò–∑–≤–ª–µ–∫–∞–µ—Ç `stats` –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞.
        *   –í—ã–∑—ã–≤–∞–µ—Ç —É—Ç–∏–ª–∏—Ç—É: `result = calculate_regen(stats)`.
        *   –ï—Å–ª–∏ `result["is_changed"]` is True:
            *   –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–∏–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ `stats` –æ–±—Ä–∞—Ç–Ω–æ –≤ Redis.
            *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç *–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ* —Å—Ç–∞—Ç—ã –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞.
    4.  **Extract Fields:** –ò–∑–≤–ª–µ–∫–∞–µ—Ç `hp`, `max_hp`, `energy`, `max_energy`, `state`, `location_id`, `name`.
    5.  **Return:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç DTO —Å *–∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏* –¥–∞–Ω–Ω—ã–º–∏.

### 3.2. `can_perform_action(char_id: int, target_action: str) -> bool`
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –º–æ–∂–Ω–æ –ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ (–ø–µ—Ä–µ—Ö–æ–¥), –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ **–∞–∫—Ç—É–∞–ª—å–Ω–æ–º** —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤ Redis.

*   **Input:**
    *   `char_id`: ID –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.
    *   `target_action`: –î–µ–π—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Ö–æ—á–µ—Ç —Å–æ–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "inventory", "status").

*   **Logic:**
    1.  **Fetch State:** –ß–∏—Ç–∞–µ—Ç –ø–æ–ª–µ `state` –∏–∑ –∫–ª—é—á–∞ `ac:{char_id}`.
        *   –ï—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç -> `False` (–∏–ª–∏ `SessionExpiredException`).
    2.  **Check Restrictions:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `current_state` –ø–æ —Ç–∞–±–ª–∏—Ü–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (`RESTRICTED_STATES`).
        *   –ü—Ä–∏–º–µ—Ä: –ï—Å–ª–∏ `state == "COMBAT"` –∏ `action == "inventory"`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`.
        *   –ü—Ä–∏–º–µ—Ä: –ï—Å–ª–∏ `state == "CUTSCENE"`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False` –¥–ª—è –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π.
    3.  **Result:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True`, –µ—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ, –∏–Ω–∞—á–µ `False`.

*   **Configuration (Example):**
    ```python
    RESTRICTED_STATES = {
        "COMBAT": {"inventory", "navigation", "map"}, # –ó–∞–ø—Ä–µ—â–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        "CUTSCENE": {"ALL"},
        "DEAD": {"inventory", "navigation"}
    }
    ```
