# ‚è≥ Arena Polling & Animation

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Handler](./Handler.md)

## ü§ñ AI CONTEXT
Polling ‚Äî –º–µ—Ö–∞–Ω–∏–∑–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –º–∞—Ç—á–∞. –ö–ª–∏–µ–Ω—Ç –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç backend –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥, –æ–±–Ω–æ–≤–ª—è—è UI —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π. –ò—Å–ø–æ–ª—å–∑—É–µ–º `UIAnimationService` –∫–∞–∫ –≤ Combat.

## üîÑ –û–±—â–∞—è —Å—Ö–µ–º–∞
1.  User –Ω–∞–∂–∏–º–∞–µ—Ç "–ù–∞–π—Ç–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞"
2.  `join_queue` ‚Üí Backend –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å
3.  –ó–∞–ø—É—Å–∫ polling loop
4.  [–ö–∞–∂–¥—ã–µ 3 —Å–µ–∫]
    *   `check_match` ‚Üí Backend –∏—â–µ—Ç –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
    *   –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    *   –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
5.  –í—ã—Ö–æ–¥ –∏–∑ loop –∫–æ–≥–¥–∞:
    *   –ú–∞—Ç—á –Ω–∞–π–¥–µ–Ω (`state=COMBAT`)
    *   –¢–∞–π–º–∞—É—Ç backend (Shadow —Å–æ–∑–¥–∞–Ω, `state=COMBAT`)
    *   –û—Ç–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    *   –¢–∞–π–º–∞—É—Ç –∫–ª–∏–µ–Ω—Ç–∞ (60 —Å–µ–∫)

## ‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Polling
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `CLIENT_TIMEOUT` | 60 —Å–µ–∫ | –ú–∞–∫—Å. –≤—Ä–µ–º—è polling –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ |
| `STEP_DELAY` | 3 —Å–µ–∫ | –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ |
| `BACKEND_TIMEOUT` | 45 —Å–µ–∫ | –í—Ä–µ–º—è –¥–æ Shadow –Ω–∞ backend |

> `CLIENT_TIMEOUT` > `BACKEND_TIMEOUT` —á—Ç–æ–±—ã backend —É—Å–ø–µ–ª —Å–æ–∑–¥–∞—Ç—å Shadow –¥–æ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞

## üì¶ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å UIAnimationService
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `game_client/telegram_bot/services/animation/animation_service.py`

**–ú–µ—Ç–æ–¥:** –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω –∏–∑ Combat –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –¥–ª—è Arena

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã:**
1.  –ü—Ä–∏–Ω–∏–º–∞–µ—Ç `check_func` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
2.  `check_func` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `(UnifiedViewDTO, is_waiting: bool)`
3.  –ï—Å–ª–∏ `is_waiting=True` ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç –∞–Ω–∏–º–∞—Ü–∏—é, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç, –∂–¥—ë—Ç delay
4.  –ï—Å–ª–∏ `is_waiting=False` ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π view, –≤—ã—Ö–æ–¥–∏—Ç

## üé¨ –ê–Ω–∏–º–∞—Ü–∏—è
**–§–æ—Ä–º–∞—Ç:** Progress bar
`‚è≥ –ü–æ–∏—Å–∫ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ [‚ñ†‚ñ†‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°]`

**–õ–æ–≥–∏–∫–∞:**
*   10 —Ñ—Ä–µ–π–º–æ–≤ –∞–Ω–∏–º–∞—Ü–∏–∏
*   –ö–∞–∂–¥—ã–π step –∑–∞–ø–æ–ª–Ω—è–µ—Ç +1 —Å–∏–º–≤–æ–ª
*   –ü–æ—Å–ª–µ 10 ‚Äî –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–Ω–∞—á–∞–ª–∞ (loop)

**Placeholder –≤ —Ç–µ–∫—Å—Ç–µ:**
*   Backend –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å `{ANIMATION}`
*   –ö–ª–∏–µ–Ω—Ç –∑–∞–º–µ–Ω—è–µ—Ç –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É –∞–Ω–∏–º–∞—Ü–∏–∏

## üîß Poller Function –≤ Orchestrator
**–ú–µ—Ç–æ–¥:** `get_search_poller(user_id, mode)`
**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** async —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è `UIAnimationService`

**–õ–æ–≥–∏–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏:**
| –í—ã–∑–æ–≤ | –î–µ–π—Å—Ç–≤–∏–µ |
| :--- | :--- |
| –ü–µ—Ä–≤—ã–π | `client.action("join_queue")` ‚Äî –≤—Å—Ç–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å |
| –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ | `client.action("check_match")` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ |

**–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ is_waiting:**
| response.header.current_state | is_waiting |
| :--- | :--- |
| `ARENA` | `True` (–ø—Ä–æ–¥–æ–ª–∂–∞–µ–º) |
| `COMBAT` | `False` (–º–∞—Ç—á –Ω–∞–π–¥–µ–Ω) |
| –î—Ä—É–≥–æ–π | `False` (–æ—à–∏–±–∫–∞, –≤—ã—Ö–æ–¥) |

## üö´ –û—Ç–º–µ–Ω–∞ Polling
**–°—Ü–µ–Ω–∞—Ä–∏–π:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–û—Ç–º–µ–Ω–∞" –≤–æ –≤—Ä–µ–º—è –ø–æ–∏—Å–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** Polling –∑–∞–ø—É—â–µ–Ω –≤ async loop

**–†–µ—à–µ–Ω–∏–µ:**
1.  –ö–Ω–æ–ø–∫–∞ "–û—Ç–º–µ–Ω–∞" –∏–º–µ–µ—Ç `action="cancel_queue"`
2.  Handler –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–π callback
3.  –ù—É–∂–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ polling

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:**
| –í–∞—Ä–∏–∞–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- |
| FSM Flag | –•—Ä–∞–Ω–∏—Ç—å —Ñ–ª–∞–≥ `arena_searching` –≤ state, –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ `check_func` |
| State Change | –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–µ–∫—É—â–∏–π state –≤ `check_func`, –µ—Å–ª–∏ –Ω–µ arena ‚Äî –≤—ã—Ö–æ–¥ |
| Cancellation Token | –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å `asyncio.Event` –¥–ª—è –æ—Ç–º–µ–Ω—ã |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** **State Change** ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º state –≤ `check_func`, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `is_waiting=False`

## üìä –°–æ—Å—Ç–æ—è–Ω–∏—è FSM –≤–æ –≤—Ä–µ–º—è Polling
| –ú–æ–º–µ–Ω—Ç | State | –§–ª–∞–≥ –≤ state_data |
| :--- | :--- | :--- |
| –î–æ –ø–æ–∏—Å–∫–∞ | `BotState.arena` | `arena_searching=False` |
| –í–æ –≤—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ | `BotState.arena` | `arena_searching=True` |
| –ú–∞—Ç—á –Ω–∞–π–¥–µ–Ω | `BotState.combat` | ‚Äî |
| –û—Ç–º–µ–Ω–∞ | `BotState.arena` | `arena_searching=False` |

## ‚ö†Ô∏è Edge Cases
| –°–ª—É—á–∞–π | –ü–æ–≤–µ–¥–µ–Ω–∏–µ |
| :--- | :--- |
| –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—à—ë–ª –∏–∑ –±–æ—Ç–∞ | Polling –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è, –Ω–æ `edit_message` —É–ø–∞–¥—ë—Ç ‚Äî –ª–æ–≤–∏–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ |
| –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ "–ù–∞–π—Ç–∏" | –ü—Ä–æ–≤–µ—Ä—è—Ç—å `arena_searching` –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º |
| Backend –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | Retry –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ—Å–ª–µ N –ø–æ–ø—ã—Ç–æ–∫ |
| –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ | `TelegramBadRequest` ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –≤—ã—Ö–æ–¥–∏–º –∏–∑ polling |