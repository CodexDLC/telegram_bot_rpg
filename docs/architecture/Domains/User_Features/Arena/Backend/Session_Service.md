# üîê Arena Session Service

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Roadmap](../Roadmap.md)

## ü§ñ AI CONTEXT
`ArenaSessionService` ‚Äî –¥–æ–º–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –º–µ–∂–¥—É `ArenaService` –∏ Redis Managers. –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ managers (`ArenaManager`, `AccountManager`). –°–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º/—á—Ç–µ–Ω–∏–µ–º.

## üèóÔ∏è –ú–µ—Å—Ç–æ –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
`ArenaService` (–±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, UI Payload)
    ‚Üì
`ArenaSessionService` (–∏–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è Redis)
    ‚îú‚îÄ‚îÄ `ArenaManager` (–æ—á–µ—Ä–µ–¥–∏, –∑–∞—è–≤–∫–∏)
    ‚îî‚îÄ‚îÄ `AccountManager` (–¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞, GS)

## üìç –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ
**–§–∞–π–ª:** `backend/domains/user_features/arena/services/arena_session_service.py`

## üéØ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
| –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- |
| –ò–Ω–∫–∞–ø—Å—É–ª—è—Ü–∏—è | –°–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ —Ä–∞–±–æ—Ç—ã —Å Redis –æ—Ç `ArenaService` |
| –ö–æ–º–ø–æ–∑–∏—Ü–∏—è | –û–±—ä–µ–¥–∏–Ω—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ Redis managers |
| –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö | –í–∞–ª–∏–¥–∞—Ü–∏—è, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º |
| –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π |

## üì¶ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
| Manager | –û—Ç–∫—É–¥–∞ | –î–ª—è —á–µ–≥–æ |
| :--- | :--- | :--- |
| `ArenaManager` | `backend/database/redis/manager/` | –û—á–µ—Ä–µ–¥–∏, –∑–∞—è–≤–∫–∏ |
| `AccountManager` | `backend/database/redis/manager/` | –î–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞, char_id ‚Üí GS |

## üìã –ú–µ—Ç–æ–¥—ã

### Queue Operations
| –ú–µ—Ç–æ–¥ | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `join_queue` | `char_id`, `mode` | –ü–æ–ª—É—á–∞–µ—Ç GS, –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å, —Å–æ–∑–¥–∞—ë—Ç request |
| `leave_queue` | `char_id`, `mode` | –£–¥–∞–ª—è–µ—Ç –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –∏ request |
| `get_queue_status` | `char_id` | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –∑–∞—è–≤–∫–∞ |

### Match Operations
| –ú–µ—Ç–æ–¥ | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `find_opponent` | `char_id`, `mode` | –ò—â–µ—Ç –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –ø–æ GS –¥–∏–∞–ø–∞–∑–æ–Ω—É |
| `check_timeout` | `char_id` | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è |
| `prepare_match` | `char_id`, `opponent_id`, `mode` | –û—á–∏—â–∞–µ—Ç –æ—á–µ—Ä–µ–¥–∏ –æ–±–æ–∏—Ö –∏–≥—Ä–æ–∫–æ–≤ |

### Data Operations
| –ú–µ—Ç–æ–¥ | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `get_gear_score` | `char_id` | –ü–æ–ª—É—á–∞–µ—Ç GS (TODO: stub –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 100) |
| `get_request_meta` | `char_id` | –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ (–≤—Ä–µ–º—è, GS, mode) |

## üîÑ –õ–æ–≥–∏–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç–æ–¥–æ–≤

### join_queue
1.  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–µ—Ç –ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –∑–∞—è–≤–∫–∏
2.  –ü–æ–ª—É—á–∏—Ç—å GS —á–µ—Ä–µ–∑ `get_gear_score()`
3.  `ArenaManager.add_to_queue()`
4.  `ArenaManager.create_request()`
5.  –í–µ—Ä–Ω—É—Ç—å GS

### find_opponent
1.  –ü–æ–ª—É—á–∏—Ç—å –º–æ–π GS –∏–∑ request
2.  –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω (¬±15%)
3.  `ArenaManager.get_candidates()`
4.  –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–µ–±—è
5.  –ê—Ç–æ–º–∞—Ä–Ω–æ –∑–∞–±—Ä–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ (`remove_from_queue`)
6.  –í–µ—Ä–Ω—É—Ç—å `opponent_id` –∏–ª–∏ `None`

### prepare_match
1.  –£–¥–∞–ª–∏—Ç—å –æ–±–æ–∏—Ö –∏–∑ –æ—á–µ—Ä–µ–¥–∏
2.  –£–¥–∞–ª–∏—Ç—å request –æ–±–æ–∏—Ö
3.  –í–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±–æ—è

## üîß –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
| –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `GS_RANGE_PERCENT` | 0.15 | –î–∏–∞–ø–∞–∑–æ–Ω ¬±15% |
| `REQUEST_TTL` | 300 | TTL –∑–∞—è–≤–∫–∏ (5 –º–∏–Ω) |
| `DEFAULT_GS` | 100 | –ó–∞–≥–ª—É—à–∫–∞ GS (TODO) |

## üìä –°–≤—è–∑—å ArenaService ‚Üí ArenaSessionService
| ArenaService –º–µ—Ç–æ–¥ | –í—ã–∑—ã–≤–∞–µ—Ç |
| :--- | :--- |
| `join_queue()` | `session_service.join_queue()` |
| `check_match()` | `session_service.find_opponent()`, `check_timeout()` |
| `cancel_queue()` | `session_service.leave_queue()` |
| `_create_battle()` | `session_service.prepare_match()` |

## ‚ö†Ô∏è –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
| –ê—Å–ø–µ–∫—Ç | ArenaService | ArenaSessionService |
| :--- | :--- | :--- |
| UI Payload | ‚úÖ –î–∞ | ‚ùå –ù–µ—Ç |
| Resources (—Ç–µ–∫—Å—Ç—ã) | ‚úÖ –î–∞ | ‚ùå –ù–µ—Ç |
| Redis –æ–ø–µ—Ä–∞—Ü–∏–∏ | ‚ùå –î–µ–ª–µ–≥–∏—Ä—É–µ—Ç | ‚úÖ –í—ã–ø–æ–ª–Ω—è–µ—Ç |
| –ë–∏–∑–Ω–µ—Å-—Ä–µ—à–µ–Ω–∏—è | ‚úÖ –î–∞ | ‚ùå –ù–µ—Ç |
| –†–∞–±–æ—Ç–∞–µ—Ç —Å | DTO | Raw data |