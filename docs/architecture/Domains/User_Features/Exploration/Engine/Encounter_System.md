# üé≤ Encounter System V2

## 1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è
–≠–Ω–∫–∞—É–Ω—Ç–µ—Ä ‚Äî —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ, –ø—Ä–µ—Ä—ã–≤–∞—é—â–µ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∏–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—â–µ–µ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ.

**–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç):**
1.  **Combat (–ë–æ–π):** –û—Å–Ω–æ–≤–Ω–æ–π —Ç–∏–ø. –ó–∞–≤–∏—Å–∏—Ç –æ—Ç Tier –ª–æ–∫–∞—Ü–∏–∏.
2.  **Merchant (–¢–æ—Ä–≥–æ–≤–µ—Ü):** –†–µ–¥–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ (–∑–∞–≥–ª—É—à–∫–∞).
3.  **Quest (–ö–≤–µ—Å—Ç):** –í—Å—Ç—Ä–µ—á–∞ —Å NPC (–∑–∞–≥–ª—É—à–∫–∞).
4.  **None:** –ù–∏—á–µ–≥–æ –Ω–µ —Å–ª—É—á–∏–ª–æ—Å—å.

## 2. –ê–ª–≥–æ—Ä–∏—Ç–º –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –¢—Ä–∏–≥–≥–µ—Ä (Trigger)
–ë–∞–∑–æ–≤—ã–π —à–∞–Ω—Å —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ –ª–æ–∫–∞—Ü–∏—é.
*   **Chance:** 45% (–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `ENCOUNTER_CHANCE`).
*   **Logic:** `random() < 0.45`.
*   –ï—Å–ª–∏ `False` -> –ò–≥—Ä–æ–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Å–≤–æ–±–æ–¥–Ω–æ.

### –≠—Ç–∞–ø 2: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ (Detection)
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫—Ç–æ –∫–æ–≥–æ –∑–∞–º–µ—Ç–∏–ª –ø–µ—Ä–≤—ã–º.
*   **Player Power:** `Scouting Level` (–∏–∑ AccountManager).
*   **Location Difficulty:** `Tier * 10`.
*   **Formula:** `Diff = PlayerPower - Difficulty + Random(-5, 5)`.

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
*   `Diff >= 0` -> **DETECTED** (–ò–≥—Ä–æ–∫ –∑–∞–º–µ—Ç–∏–ª —É–≥—Ä–æ–∑—É).
    *   UI: –ö–Ω–æ–ø–∫–∏ [–ù–∞–ø–∞—Å—Ç—å] [–û–±–æ–π—Ç–∏] [–ò–∑—É—á–∏—Ç—å].
*   `Diff < 0` -> **AMBUSH** (–ó–∞—Å–∞–¥–∞).
    *   UI: –ö–Ω–æ–ø–∫–∞ [–í –±–æ–π!] (–ù–µ—Ç –≤—ã–±–æ—Ä–∞).

### –≠—Ç–∞–ø 3: –°–±–æ—Ä–∫–∞ (Assembly)
–ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, —Å–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç.
*   **Budget:** `Tier * 30`.
*   **Monster Selection:** –í—ã–±–æ—Ä –º–æ–±–æ–≤ –∏–∑ –ø—É–ª–∞ (—á–µ—Ä–µ–∑ `Dispatcher` -> `MonsterAssembler`), –ø–æ–∫–∞ –±—é–¥–∂–µ—Ç –Ω–µ –∏—Å—á–µ—Ä–ø–∞–Ω.
*   **Bestiary Check:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–æ–±–∞—Ö (Low/Mid/High) –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–≤—ã–∫–∞ `Bestiary`.

## 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ë–æ–µ–º
–ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –≤—ã–±—Ä–∞–ª "–ù–∞–ø–∞—Å—Ç—å" –∏–ª–∏ –ø–æ–ø–∞–ª –≤ "–ó–∞—Å–∞–¥—É":
1.  `ExplorationService` –≤—ã–∑—ã–≤–∞–µ—Ç `CombatGateway.create_session()`.
2.  –ü–µ—Ä–µ–¥–∞–µ—Ç —Å–ø–∏—Å–æ–∫ `monster_id` –∏–∑ —ç–Ω–∫–∞—É–Ω—Ç–µ—Ä–∞.
3.  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É `EncounterDTO` —Å ID —Å–µ—Å—Å–∏–∏ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ç–µ–π—Ç.

## 4. –ê–≤—Ç–æ-–Ω–∞–≤–∏–≥–∞—Ü–∏—è
*   –ï—Å–ª–∏ **DETECTED**: –ê–≤—Ç–æ-–≤—ã–±–æ—Ä "–û–±–æ–π—Ç–∏" (–∏–≥—Ä–æ–∫ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø—É—Ç—å).
*   –ï—Å–ª–∏ **AMBUSH**: –û—Å—Ç–∞–Ω–æ–≤–∫–∞, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –±–æ–π.

## 5. DTO Contracts
–°–º. `common/schemas/exploration.py`.
*   `EncounterDTO`: –°–æ–¥–µ—Ä–∂–∏—Ç `status` (DETECTED/AMBUSH) –∏ —Å–ø–∏—Å–æ–∫ `enemies`.
*   `EnemyPreviewDTO`: –î–∞–Ω–Ω—ã–µ –æ –≤—Ä–∞–≥–µ (—Å–∫—Ä—ã—Ç—ã/–æ—Ç–∫—Ä—ã—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç Bestiary).
