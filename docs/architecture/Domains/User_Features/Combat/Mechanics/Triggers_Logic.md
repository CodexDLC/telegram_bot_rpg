# üß† Mechanic: Triggers & Rules (–¢—Ä–∏–≥–≥–µ—Ä—ã –∏ –ü—Ä–∞–≤–∏–ª–∞)

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Combat Mechanics](./README.md) | [üíæ –°—Ö–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö](../../../../../Core/RPG_Rules/Data_Schemas/Trigger_Schema.md)

---

## 1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è
–¢—Ä–∏–≥–≥–µ—Ä—ã –≤ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ ‚Äî —ç—Ç–æ **–ü—Ä–∞–≤–∏–ª–∞ (Rules)**, –∫–æ—Ç–æ—Ä—ã–µ –∏–∑–º–µ–Ω—è—é—Ç —Ö–æ–¥ –±–æ—è –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–±—ã—Ç–∏—è.
–û–Ω–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É (–í–∞–º–ø–∏—Ä–∏–∑–º, –°—Ç–∞–Ω, –ö–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞) –±–µ–∑ —Ö–∞—Ä–¥–∫–æ–¥–∞ –≤ –¥–≤–∏–∂–∫–µ.

### –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã:
1.  **Event-Driven:** –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —Å–æ–±—ã—Ç–∏—è–º (`ON_CRIT`, `ON_DODGE`, `ON_CHECK_CONTROL`).
2.  **Flag Activation:** –ü—Ä–∞–≤–∏–ª–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å–∞–º–∏ –ø–æ —Å–µ–±–µ. –ò—Ö –Ω—É–∂–Ω–æ **–≤–∫–ª—é—á–∏—Ç—å** (–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ –§–∏–Ω—Ç –∏–ª–∏ –ê–±–∏–ª–∫—É).
3.  **Mutation Based:** –†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –ø—Ä–∞–≤–∏–ª–∞ ‚Äî —ç—Ç–æ **–ú—É—Ç–∞—Ü–∏—è** –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –±–æ—è (–∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤, —Å—Ç–∞—Ç–æ–≤ –∏–ª–∏ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤).

---

## 2. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π –¶–∏–∫–ª (Lifecycle)

### –ü—Ä–∏–º–µ—Ä: –§–∏–Ω—Ç "Stunning Blow" (–û–≥–ª—É—à–∞—é—â–∏–π —É–¥–∞—Ä)

#### –®–∞–≥ 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (FeintConfig)
–§–∏–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç: "–Ø —Ö–æ—á—É –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ `stun_on_hit`".
```json
{
  "triggers": ["control.stun_on_hit"]
}
```

#### –®–∞–≥ 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (AbilityService -> Pre-Calc)
–°–µ—Ä–≤–∏—Å —á–∏—Ç–∞–µ—Ç –ø—É—Ç—å `control.stun_on_hit` –∏ —Å—Ç–∞–≤–∏—Ç —Ñ–ª–∞–≥ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ:
```python
ctx.triggers.control.stun_on_hit = True
```

#### –®–∞–≥ 3. –ë–æ–π (CombatResolver)
1.  **–≠—Ç–∞–ø Accuracy:** –ü–æ–ø–∞–¥–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ.
2.  **–≠—Ç–∞–ø Finalize (ON_CHECK_CONTROL):**
    *   –†–µ–∑–æ–ª–≤–µ—Ä —Å–º–æ—Ç—Ä–∏—Ç –≤ `ctx.triggers.control`.
    *   –í–∏–¥–∏—Ç `stun_on_hit = True`.
    *   –ò—â–µ—Ç –ø—Ä–∞–≤–∏–ª–æ —Å ID `stun_on_hit` –≤ —Å–ª–æ–≤–∞—Ä–µ `TRIGGER_RULES`.
    *   –ù–∞—Ö–æ–¥–∏—Ç: `{"event": "ON_CHECK_CONTROL", "chance": 0.5, "mutations": {"ability_flags.apply_stun": True}}`.
    *   –ö–∏–¥–∞–µ—Ç –∫—É–±–∏–∫ (50%).
    *   **–£—Å–ø–µ—Ö:** –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º—É—Ç–∞—Ü–∏—é `res.ability_flags.apply_stun = True`.

#### –®–∞–≥ 4. –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è (AbilityService -> Post-Calc)
–°–µ—Ä–≤–∏—Å –≤–∏–¥–∏—Ç —Ñ–ª–∞–≥ `apply_stun` –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç "Stun" –Ω–∞ —Ü–µ–ª—å.

---

## 3. –ö–∞—Ä—Ç–∞ –°–æ–±—ã—Ç–∏–π (Event Map)

| –°–æ–±—ã—Ç–∏–µ | –ö–æ–≥–¥–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç | –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª |
| :--- | :--- | :--- |
| **ON_ACCURACY_CHECK** | –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏ | `true_strike` (–ò–≥–Ω–æ—Ä —É–≤–æ—Ä–æ—Ç–∞) |
| **ON_MISS** | –ü–æ—Å–ª–µ –ø—Ä–æ–º–∞—Ö–∞ | `rage_on_miss` (–ë–æ–Ω—É—Å –∫ —É—Ä–æ–Ω—É) |
| **ON_CRIT** | –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º —É–¥–∞—Ä–µ | `bleed_on_crit`, `heavy_strike` |
| **ON_DODGE** | –ï—Å–ª–∏ –≤—Ä–∞–≥ —É–≤–µ—Ä–Ω—É–ª—Å—è | `counter_on_dodge` |
| **ON_PARRY** | –ï—Å–ª–∏ –≤—Ä–∞–≥ —Å–ø–∞—Ä–∏—Ä–æ–≤–∞–ª | `disarm_on_parry`, `counter_on_parry` |
| **ON_BLOCK** | –ï—Å–ª–∏ –≤—Ä–∞–≥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª | `bash_on_block` |
| **ON_CHECK_CONTROL** | –í –∫–æ–Ω—Ü–µ, –µ—Å–ª–∏ –∞—Ç–∞–∫–∞ —É—Å–ø–µ—à–Ω–∞ | `stun_on_hit`, `bleed_on_hit` |
