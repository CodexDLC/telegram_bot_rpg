# üé® Combat View Service (Data Formatting)

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Engine](../../README.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
–°–µ—Ä–≤–∏—Å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞. –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis (`BattleContext`) –≤ –∫—Ä–∞—Å–∏–≤—ã–µ DTO (`CombatDashboardDTO`).
–≠—Ç–æ **Backend Logic**, –æ—Ç–≤–µ—á–∞—é—â–∞—è –∑–∞ —Ç–æ, *—á—Ç–æ* —É–≤–∏–¥–∏—Ç –∏–≥—Ä–æ–∫, –Ω–æ –Ω–µ *–∫–∞–∫* —ç—Ç–æ –±—É–¥–µ—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–æ.

---

## üìä –§–æ—Ä–º–∏—Ä—É–µ–º—ã–µ DTO

### 1. CombatDashboardDTO
–ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –±–æ—è.
*   **Hero:** –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–µ—Ä–æ–µ (HP, Energy, Tokens, Effects, Feints).
*   **Target:** –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ü–µ–ª–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å).
*   **Allies/Enemies:** –°–ø–∏—Å–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
*   **Status:** –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –±–æ—è (active, waiting, finished).

### 2. ActorFullInfo (Hero/Target)
*   **Vitals:** HP, Energy (—Ç–µ–∫—É—â–µ–µ/–º–∞–∫—Å).
*   **Weapon Type:** –¢–∏–ø –æ—Ä—É–∂–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ä—É–∫–µ (–¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ê—Ç–∞–∫–∞").
*   **Tokens:** –°—É–º–º–∞—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ (—Å–≤–æ–±–æ–¥–Ω—ã–µ + –≤ —Ä—É–∫–µ).
*   **Feints:** –°–ª–æ–≤–∞—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∏–Ω—Ç–æ–≤ `{id: name}` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫.
*   **Effects:** –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.

### 3. CombatLogDTO
–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –±–æ—è (–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ).
*   –ü–∞–≥–∏–Ω–∞—Ü–∏—è.
*   –°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –ª–æ–≥–∞.

---

## üõ†Ô∏è –õ–æ–≥–∏–∫–∞
*   **Context Loading:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `CombatSessionService` –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–≥–∫–æ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–∞.
*   **Token Calculation:** –°—É–º–º–∏—Ä—É–µ—Ç —Ç–æ–∫–µ–Ω—ã –∏–∑ `state.tokens` –∏ `meta.feints.hand`.
*   **Feint Mapping:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `FeintService.get_hand_for_dashboard` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏–π —Ñ–∏–Ω—Ç–æ–≤.
*   **Formatting:** –û–∫—Ä—É–≥–ª—è–µ—Ç —á–∏—Å–ª–∞, —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç—ã.
