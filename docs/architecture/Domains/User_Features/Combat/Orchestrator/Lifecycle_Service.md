# ‚ôªÔ∏è Combat Lifecycle Service

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Orchestrator](../README.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
–°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –±–æ–µ–≤–æ–π —Å–µ—Å—Å–∏–∏ (RBC v3.0).
–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö –≤ Redis –∏ –æ—á–∏—Å—Ç–∫—É –ø–æ—Å–ª–µ –±–æ—è.

---

## ‚öôÔ∏è –ú–µ—Ç–æ–¥—ã

### 1. `create_battle(session_id, config)`
–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—è.
1.  **Load Templates:** –ó–∞–≥—Ä—É–∂–∞–µ—Ç `temp:setup` –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (MGET).
2.  **Assemble:**
    *   –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —à–∞–±–ª–æ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞.
    *   –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID –¥–ª—è –º–æ–Ω—Å—Ç—Ä–æ–≤ (`mob_1`, `mob_2`).
    *   –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É `SessionDataDTO`.
    *   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–∞—Ç—É—Å–æ–≤: `"statuses": {"abilities": [], "effects": []}`.
3.  **Persist:** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Redis (`combat:rbc:{sid}:...`).
4.  **Kickstart:** –ó–∞–ø—É—Å–∫–∞–µ—Ç `Chaos Relay` (–ø–µ—Ä–≤—ã–π —Ç–∏–∫ —Ç–∞–π–º–µ—Ä–∞).

### 2. `complete_session(session_id, results)`
–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–æ—è.
1.  **Cleanup:** –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∫–ª—é—á–∏ —Å–µ—Å—Å–∏–∏ –∏–∑ Redis.
2.  **Unlink:** –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ (—É–¥–∞–ª—è–µ—Ç `account:combat_session`).

---

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (Redis Init)
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–µ—Å—Å–∏–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∫–ª—é—á–∏:
*   `:meta` ‚Äî –°—Ç–∞—Ç—É—Å –±–æ—è, —Å–ø–∏—Å–∫–∏ –∫–æ–º–∞–Ω–¥.
*   `:actor:{id}:meta` ‚Äî HP, Energy, State.
*   `:actor:{id}:raw` ‚Äî –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å (Attributes, Modifiers).
*   `:actor:{id}:loadout` ‚Äî –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞ –∏ —Å–∫–∏–ª–ª—ã.
*   `:actor:{id}:statuses` ‚Äî –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã (JSON).
