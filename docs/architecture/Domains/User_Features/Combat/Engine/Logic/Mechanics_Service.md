# üîß Mechanics Service

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Logic](./README.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
**Location:** `apps/game_core/modules/combat/combat_engine/logic/mechanics_service.py`
**Status:** ‚ö†Ô∏è **Work In Progress**

–°–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ **–º—É—Ç–∞—Ü–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è** (State Mutation) —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–æ—è. –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –∏–∑–º–µ–Ω—è—Ç—å `HP`, `Energy`, `Tokens` –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ `XP Buffer`.

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç `StatsWaterfallCalculator` –¥–ª—è —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–µ—Å—É—Ä—Å–æ–≤, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 1. Resource Calculation (Unified Delta)
–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ (HP, EN, Tokens) –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω —Ä–∞—Å—á–µ—Ç–∞ **–¥–µ–ª—å—Ç—ã**.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1.  **–°–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (Sources):**
    *   –°–æ–±–∏—Ä–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ (`["-10", "+5", "*1.1"]`) –∏–∑ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤:
        *   **Interaction Result:** –£—Ä–æ–Ω, –õ–∞–π—Ñ—Å—Ç–∏–ª, –û—Ç—Ä–∞–∂–µ–Ω–∏–µ.
        *   **Active Effects:** DOT/HOT (`impact`).
        *   **Cost:** –°—Ç–æ–∏–º–æ—Å—Ç—å –∞–±–∏–ª–æ–∫/—Ñ–∏–Ω—Ç–æ–≤.
2.  **–†–∞—Å—á–µ—Ç –î–µ–ª—å—Ç—ã:**
    *   –í—ã–∑—ã–≤–∞–µ—Ç `StatsWaterfallCalculator.evaluate_sources(sources, base_value=0)`.
    *   –ü–æ–ª—É—á–∞–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `-55`).
3.  **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (Mutation):**
    *   `new_value = current_value + delta`
    *   **Clamping:** –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ª–∏–º–∏—Ç—ã (0 <= value <= max_value).
    *   –û–±–Ω–æ–≤–ª—è–µ—Ç `actor.meta`.

### 2. Effect Processing (Ticks)
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –≤–ª–∏—è–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (DOT/HOT) –≤ –Ω–∞—á–∞–ª–µ —Ö–æ–¥–∞ –∏–ª–∏ —Ñ–∞–∑—ã.

**–õ–æ–≥–∏–∫–∞:**
1.  –ò—Ç–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ `actor.statuses.effects`.
2.  –ß–∏—Ç–∞–µ—Ç –ø–æ–ª–µ `impact` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{"hp": -10}`).
3.  –î–æ–±–∞–≤–ª—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Å–ø–∏—Å–æ–∫ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Ä–µ—Å—É—Ä—Å–∞.
4.  *(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)* –£–º–µ–Ω—å—à–∞–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –¥–µ–ª–∞–µ—Ç AbilityService).

### 3. Apply Interaction Result
–ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ –±–æ—è (`InteractionResultDTO`) –∫ –∞–∫—Ç–æ—Ä–∞–º.

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
*   **Damage:** `target.hp` -= `result.damage_final`.
*   **Sustain (Lifesteal):** `source.hp` += `result.lifesteal`.
*   **Thorns:** `source.hp` -= `result.reflected_damage`.
*   **Tokens:** `source.tokens` += `result.tokens_awarded`.

–í—Å–µ —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤ –±–∞—Ç—á –∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.

### 4. XP Registration (Buffer)
–ú–µ—Ö–∞–Ω–∏–∫–∞ –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç –æ–ø—ã—Ç —Å—Ä–∞–∑—É, –∞ **—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è** –≤ –±—É—Ñ–µ—Ä (`xp_buffer`).

**–ü—Ä–∏–º–µ—Ä—ã —Å–æ–±—ã—Ç–∏–π:**
*   `hit_damage`: –ù–∞–Ω–µ—Å–µ–Ω–∏–µ —É—Ä–æ–Ω–∞.
*   `defense_dodge`: –£—Å–ø–µ—à–Ω—ã–π —É–≤–æ—Ä–æ—Ç.
*   `kill`: –£–±–∏–π—Å—Ç–≤–æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞.

### 5. Hand Management (Feint System)
–í –∫–æ–Ω—Ü–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ö–æ–¥–∞ (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ —Ñ–ª–∞–≥–æ–º `generate_feints`) –≤—ã–∑—ã–≤–∞–µ—Ç `FeintService` –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Ä—É–∫–∏.

*   **Method:** `FeintService.refill_hand(actor)`
*   **Logic:**
    1.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä —Ä—É–∫–∏.
    2.  –ï—Å–ª–∏ –º–µ–Ω—å—à–µ MAX, –≤—ã–±–∏—Ä–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∏–Ω—Ç—ã –∏–∑ –∞—Ä—Å–µ–Ω–∞–ª–∞ (–ø–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏).
    3.  –î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–Ω—Ç—ã –≤ —Ä—É–∫—É –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã.

---

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
*   **–í—Ö–æ–¥:** `InteractionResultDTO` (–æ—Ç –†–µ–∑–æ–ª–≤–µ—Ä–∞), `ActiveEffectDTO` (–æ—Ç –ê–±–∏–ª–æ–∫).
*   **Tools:** `StatsWaterfallCalculator` (–¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏).
*   **–í—ã—Ö–æ–¥:** –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã `ActorSnapshot` (Meta, Tokens, XP Buffer).
