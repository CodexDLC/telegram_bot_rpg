# üîß Mechanics Service

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Logic](./README.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
**Location:** `apps/game_core/modules/combat/combat_engine/logic/mechanics_service.py`
**Status:** ‚ö†Ô∏è **Work In Progress**

–°–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ **–º—É—Ç–∞—Ü–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è** (State Mutation) —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±–æ—è. –≠—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –∏–∑–º–µ–Ω—è—Ç—å `HP`, `Energy`, `Tokens` –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ `XP Buffer`.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### 1. Apply Interaction Result
–ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ (`InteractionResultDTO`) –∫ –∞–∫—Ç–æ—Ä–∞–º.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**
1.  **Damage Application:**
    *   `target.hp -= result.damage_final`
    *   –ï—Å–ª–∏ `hp <= 0` -> `target.is_dead = True`.
2.  **Sustain (Lifesteal):**
    *   `source.hp += result.lifesteal`
    *   –ù–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å `max_hp`.
3.  **Thorns (–û—Ç—Ä–∞–∂–µ–Ω–∏–µ):**
    *   `source.hp -= result.reflected_damage`.
4.  **Token Awards:**
    *   –ù–∞—á–∏—Å–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ `result.tokens_awarded_attacker` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `combo_point`, `parry_token`).

### 2. XP Registration (Buffer)
–ú–µ—Ö–∞–Ω–∏–∫–∞ –Ω–µ –Ω–∞—á–∏—Å–ª—è–µ—Ç –æ–ø—ã—Ç —Å—Ä–∞–∑—É, –∞ **—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è** –≤ –±—É—Ñ–µ—Ä (`xp_buffer`).
–≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–≥—Ä–∞–¥ (Reward Service) –º–æ–≥–ª–∞ –ø–æ–∑–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –æ–ø—ã—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≤–µ—Ç–æ–∫ –ø—Ä–æ–∫–∞—á–∫–∏ (Skills).

**–ü—Ä–∏–º–µ—Ä—ã —Å–æ–±—ã—Ç–∏–π:**
*   `hit_damage`: –ù–∞–Ω–µ—Å–µ–Ω–∏–µ —É—Ä–æ–Ω–∞.
*   `defense_dodge`: –£—Å–ø–µ—à–Ω—ã–π —É–≤–æ—Ä–æ—Ç.
*   `defense_parry`: –£—Å–ø–µ—à–Ω–æ–µ –ø–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ.
*   `kill`: –£–±–∏–π—Å—Ç–≤–æ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞.

### 3. Resource Management
–°–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –¥–µ–π—Å—Ç–≤–∏–π (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ `AbilityService`, –Ω–æ –ª–æ–≥–∏–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Ç—É—Ç).
*   `pay_cost(actor, hp, en, tokens)`: –ê—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ.

### 4. Hand Management (Feint System)
–í –∫–æ–Ω—Ü–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ö–æ–¥–∞ (–∏–ª–∏ —Ñ–∞–∑—ã) –º–µ—Ö–∞–Ω–∏–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç `FeintService` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä—É–∫–∏.
*   **Method:** `update_hand_state(actor)`
*   **Logic:**
    1.  –í—ã–∑—ã–≤–∞–µ—Ç `FeintService.calculate_pool(actor)` (–æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–º–∫–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ–∫–µ–Ω–æ–≤).
    2.  –í—ã–∑—ã–≤–∞–µ—Ç `FeintService.fill_hand(actor)` (–¥–æ–±–∏—Ä–∞–µ—Ç –∫–∞—Ä—Ç—ã –¥–æ –ª–∏–º–∏—Ç–∞).

---

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
*   **–í—Ö–æ–¥:** `InteractionResultDTO` (–æ—Ç –†–µ–∑–æ–ª–≤–µ—Ä–∞).
*   **–í—ã—Ö–æ–¥:** –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã `ActorSnapshot`.
