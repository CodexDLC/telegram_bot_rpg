# ðŸ§® Calculators & Math Engines

[â¬…ï¸ ÐÐ°Ð·Ð°Ð´: Engine](../README.md)

---

## 1. ðŸŒŠ Stats Waterfall Calculator
**Location:** `apps/game_core/system/calculators/stats_waterfall_calculator.py`
**Type:** Universal Math Engine.

Ð­Ñ‚Ð¾ **ÑƒÐ½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ñ‹Ð¹** Ð´Ð²Ð¸Ð¶Ð¾Ðº Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð»ÑŽÐ±Ñ‹Ñ… Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ñ… Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸Ðº Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÐºÐ¾Ð¼Ð°Ð½Ð´. ÐžÐ½ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð±Ð¾ÐµÐ²Ñ‹Ñ… ÑÑ‚Ð°Ñ‚Ð¾Ð², Ð½Ð¾ Ð¸ Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° HP, Energy, XP Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð².

### 1.1. Text-Based Math Protocol
ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÑÐ¾ ÑÑ‚Ñ€Ð¾ÐºÐ°Ð¼Ð¸-Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑÐ¼Ð¸, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¼Ð¾Ð´Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹ Ð² Ð‘Ð” Ð² Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ¾Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ð¾Ð¼ Ð²Ð¸Ð´Ðµ Ð±ÐµÐ· ÑÐ»Ð¾Ð¶Ð½Ð¾Ð³Ð¾ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð°.

| ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ | ÐŸÑ€Ð¸Ð¼ÐµÑ€ | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ |
| :--- | :--- | :--- |
| `+` | `"+10"` | ÐÐ´Ð´Ð¸Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð±Ð¾Ð½ÑƒÑ (Flat Add). |
| `-` | `"-5"` | Ð¨Ñ‚Ñ€Ð°Ñ„ (Flat Sub). |
| `*` | `"*1.5"` | ÐœÑƒÐ»ÑŒÑ‚Ð¸Ð¿Ð»Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ (Multiplier). |
| `=` | `"=100"` | ÐŸÐµÑ€ÐµÐ¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ (Override). Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÑ‚ Ð²ÑÐµ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ðµ ÑÐ»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð¸ ÑƒÐ¼Ð½Ð¾Ð¶ÐµÐ½Ð¸Ñ. |
| `None` | `"15"` | Ð‘Ð°Ð·Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ (Ñ‚Ñ€Ð°ÐºÑ‚ÑƒÐµÑ‚ÑÑ ÐºÐ°Ðº `+15`). |

### 1.2. ÐÐ»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ "Ð’Ð¾Ð´Ð¾Ð¿Ð°Ð´" (Waterfall Flow)
Ð Ð°ÑÑ‡ÐµÑ‚ Ð¿Ñ€Ð¾Ð¸ÑÑ…Ð¾Ð´Ð¸Ñ‚ Ð² Ñ‚Ñ€Ð¸ ÑÑ‚Ð°Ð¿Ð°, Ð³Ð´Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÑ‚ÐµÐºÐ°ÑŽÑ‚ ÑÐ²ÐµÑ€Ñ…Ñƒ Ð²Ð½Ð¸Ð·.

#### Phase 1: Attributes (ÐŸÐµÑ€Ð²Ð¸Ñ‡Ð½Ñ‹Ðµ)
Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ðµ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹ (Strength, Agility Ð¸ Ñ‚.Ð´.).
*   **Input:** `Base` + `Source` (Race, Traits) + `Temp` (Buffs).
*   **Logic:** Ð¡ÑƒÐ¼Ð¼Ð¸Ñ€ÑƒÐµÑ‚ Ð²ÑÐµ Ð¿Ð»Ð¾ÑÐºÐ¸Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ, Ð·Ð°Ñ‚ÐµÐ¼ ÑƒÐ¼Ð½Ð¾Ð¶Ð°ÐµÑ‚ Ð½Ð° Ð¼ÑƒÐ»ÑŒÑ‚Ð¸Ð¿Ð»Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹.

#### Phase 2: Derivation Bridge (ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ñ)
ÐŸÑ€ÐµÐ²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÐÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹ Ð² Ð‘Ð¾Ð½ÑƒÑÑ‹ Ð´Ð»Ñ Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‡Ð½Ñ‹Ñ… ÑÑ‚Ð°Ñ‚Ð¾Ð².
*   **Rules:** Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ `MODIFIER_RULES` (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, `1 Strength = +1.5 Physical Damage`).
*   **Output:** Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¼Ð¾Ð´Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹ `Derived`.

#### Phase 3: Modifiers (Ð’Ñ‚Ð¾Ñ€Ð¸Ñ‡Ð½Ñ‹Ðµ)
Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÑ‚ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸ (Damage, Crit, HP).
*   **Input:** `Derived` (Ð¸Ð· Ð¤Ð°Ð·Ñ‹ 2) + `Source` (Items) + `Temp` (Buffs).
*   **Logic:** `(Sum(Derived) + Sum(Source) + Sum(Temp)) * Product(Multipliers)`.

---

## 2. âš™ï¸ Stats Engine (Combat Wrapper)
**Location:** `apps/game_core/modules/combat/combat_engine/logic/stats_engine.py`
**Type:** Combat Specific Manager.

Ð­Ñ‚Ð¾ Ð¾Ð±ÐµÑ€Ñ‚ÐºÐ° Ð½Ð°Ð´ `WaterfallCalculator` ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ð´Ð»Ñ Ð±Ð¾ÐµÐ²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹.
ÐžÑ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð·Ð°:
1.  **State Management:** Ð¥Ñ€Ð°Ð½Ð¸Ñ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð² `ActorStats`.
2.  **Caching:** Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ `dirty_stats` Ð´Ð»Ñ Ð»ÐµÐ½Ð¸Ð²Ð¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÑÑ‡ÐµÑ‚Ð°.
3.  **Assembly:** ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÑÐµÑ‚ Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð¾Ð´Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ñ‹ (`CombatModifiersDTO`) Ð¸ ÑÑ‚Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÐºÐ¸Ð»Ð»Ñ‹ (`CombatSkillsDTO`).

### ÐœÐµÑ…Ð°Ð½Ð¸Ð·Ð¼ Dirty Flags
Ð§Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿ÐµÑ€ÐµÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ñ‹ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‚Ð¸Ðº, Engine Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ñ„Ð»Ð°Ð³ `actor.dirty_stats`.
*   Ð•ÑÐ»Ð¸ Ñ„Ð»Ð°Ð³ Ð¿ÑƒÑÑ‚ -> Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ `actor.stats`.
*   Ð•ÑÐ»Ð¸ Ñ„Ð»Ð°Ð³ ÐµÑÑ‚ÑŒ -> Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ `WaterfallCalculator` Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÑ‚ ÐºÑÑˆ.

---

## 3. ðŸŽ² Math Core (Utilities)
**Location:** `apps/game_core/modules/combat/combat_engine/logic/math_core.py`
**Type:** Static Utility Class.

ÐÐ°Ð±Ð¾Ñ€ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ñ… Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹ Ð´Ð»Ñ RNG Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº.

### ÐœÐµÑ‚Ð¾Ð´Ñ‹
*   **`check_chance(chance: float) -> bool`**
    *   ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ (0.0 - 1.0).
    *   Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ `random.random()`.
*   **`random_range(min_val, max_val) -> float`**
    *   Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾ Ð² Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ.
*   **`clamp(val, min_val, max_val)`**
    *   ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ.

---

## 4. ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð Ð°ÑÑ‡ÐµÑ‚Ð° (Trace)

**Ð—Ð°Ð´Ð°Ñ‡Ð°:** ÐŸÐ¾ÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ `physical_damage`.

1.  **Phase 1 (Strength):**
    *   Base: 10
    *   Buff: `"+5"`
    *   Result: `15`
2.  **Phase 2 (Bridge):**
    *   Rule: `Strength * 2.0 -> physical_damage`
    *   Derived: `15 * 2.0 = +30`
3.  **Phase 3 (Damage):**
    *   Derived: `"+30"`
    *   Weapon: `"+10"`
    *   Buff (Rage): `"*1.5"`
    *   Formula: `(30 + 10) * 1.5`
    *   Result: `60`
