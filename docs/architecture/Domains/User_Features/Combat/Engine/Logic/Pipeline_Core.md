# ‚öôÔ∏è Combat Pipeline Core

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Engine](../README.md)

---

## üéØ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è
**Combat Pipeline** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ **–æ–¥–Ω–æ–≥–æ –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è** (Interaction).
–û–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å: *"–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç, –µ—Å–ª–∏ –ê–∫—Ç–æ—Ä –ê —É–¥–∞—Ä–∏—Ç –ê–∫—Ç–æ—Ä–∞ –ë –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å–∫–∏–ª–ª–æ–º/–ø—Ä–µ–¥–º–µ—Ç–æ–º?"*

*   **Atomic:** –ü–∞–π–ø–ª–∞–π–Ω –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ "—Å–µ—Ä–∏–∏ —É–¥–∞—Ä–æ–≤" –∏–ª–∏ "–¥–≤–∞ –º–µ—á–∞". –≠—Ç–æ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ (`Executor`).
*   **Stateless:** –ü–∞–π–ø–ª–∞–π–Ω –Ω–µ —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ `Context`.
*   **Deterministic:** –ü—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Stats + RNG Seed) —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤.

---

## üîÑ Data Flow (–ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

```mermaid
graph TD
    Executor["Executor Service"] -->|1. Move & Stats| CB["Context Builder"]
    CB -->|2. PipelineContext| CP["Combat Pipeline"]
    
    subgraph Combat Pipeline
        CP -->|Phase 1| Pre["Pre-Calculation\n(Ability Service)"]
        Pre -->|Mods & Flags| Res["Resolver\n(Math Engine)"]
        Res -->|Result DTO| Post["Post-Calculation\n(Ability Service)"]
        Post -->|Effects| Mech["Mechanics Service\n(Apply State)"]
    end
    
    Mech -->|Result & Updated Actors| Executor
```

---

## 1. üèóÔ∏è Context Builder
**Role:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ "–ø—É–ª—å—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è" –±–æ–µ–º.
–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ñ–ª–∞–≥–∏ –∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ –µ–¥–∏–Ω—ã–π `PipelineContextDTO`.

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:
1.  **Intent (Move):** –°—Ç—Ä–∞—Ç–µ–≥–∏—è (`item`, `skill`, `attack`).
2.  **Source (Actor):** –ü–∞—Å—Å–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏, —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞ (—á–µ—Ä–µ–∑ `ActorStats`).
3.  **External Mods:** –í–Ω–µ—à–Ω–∏–µ —É—Å–ª–æ–≤–∏—è –æ—Ç `Executor` (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—à—Ç—Ä–∞—Ñ –∑–∞ –≤—Ç–æ—Ä—É—é —Ä—É–∫—É").

### –õ–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∫–∏:
*   –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∞—Ç–∞–∫–∏ (Physical, Magic).
*   –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã –æ—Ä—É–∂–∏—è/—Å–∫–∏–ª–ª–∞ (–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ `ctx.triggers`).
*   –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `force_crit` –æ—Ç —Ñ–∏–Ω—Ç–∞).

---

## 2. üßÆ Combat Resolver (Math Engine)
**Role:** –ß–∏—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –°—Ç–∞—Ç—ã –∏ –ö–æ–Ω—Ç–µ–∫—Å—Ç -> –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç.
–†–∞–±–æ—Ç–∞–µ—Ç –ø–æ—à–∞–≥–æ–≤–æ. –ö–∞–∂–¥—ã–π —à–∞–≥ –º–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–≤–æ—Ä–æ—Ç).

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ (Resolution Steps)

#### Step 1: Accuracy (–¢–æ—á–Ω–æ—Å—Ç—å)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è.
*   **Formula:** `Base Accuracy * Multiplier`.
*   **Check:** `RNG(0..1) < Final Accuracy`.
*   **Outcome:** –ï—Å–ª–∏ –ø—Ä–æ–≤–∞–ª -> `is_miss=True`, –≤—ã—Ö–æ–¥.

#### Step 2: Crit Check (–ö—Ä–∏—Ç)
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞—Ä–∞.
*   **Formula:** `(Crit Chance * Skill Bonus) - Crit Anti-Chance`.
*   **Outcome:** –ï—Å–ª–∏ —É—Å–ø–µ—Ö -> `is_crit=True`.
*   **Trigger:** –í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ `ON_CRIT`.

#### Step 3: Evasion (–£–∫–ª–æ–Ω–µ–Ω–∏–µ)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –ª–æ–≤–∫–æ—Å—Ç—å—é.
*   **Formula:** `(Dodge Chance - Anti-Dodge)`.
*   **Modifiers:**
    *   `evasion_halved`: –®–∞–Ω—Å / 2.
    *   `ignore_evasion_cap`: –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞–ø —É–≤–æ—Ä–æ—Ç–∞.
*   **Outcome:** –ï—Å–ª–∏ —É—Å–ø–µ—Ö -> `is_dodged=True`, —É—Ä–æ–Ω = 0, –≤—ã—Ö–æ–¥.
*   **Counter:** –í–æ–∑–º–æ–∂–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∏ (`check_counter_attack`).

#### Step 4: Parry (–ü–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ä—É–∂–∏–µ–º.
*   **Formula:** `Parry Chance`.
*   **Outcome:** –ï—Å–ª–∏ —É—Å–ø–µ—Ö -> `is_parried=True`.
*   **Effect:** –û–±—ã—á–Ω–æ –ø–æ–ª–Ω—ã–π –±–ª–æ–∫ —É—Ä–æ–Ω–∞, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —á–∞—Å—Ç–∏—á–Ω—ã–º (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ–ª–∞–≥–æ–≤).

#### Step 5: Block (–ë–ª–æ–∫ —â–∏—Ç–æ–º)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã —â–∏—Ç–æ–º.
*   **Formula:** `Block Chance`.
*   **Outcome:** –ï—Å–ª–∏ —É—Å–ø–µ—Ö -> `is_blocked=True`.

#### Step 6: Damage Calculation (–£—Ä–æ–Ω)
–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ü–∏—Ñ—Ä.
1.  **Base:** `Random(Min, Max)`.
2.  **Crit:** –ï—Å–ª–∏ `is_crit` -> –£–º–Ω–æ–∂–µ–Ω–∏–µ –Ω–∞ `Crit Multiplier` (x1.5 –∏–ª–∏ x3.0 –¥–ª—è –º–∞–≥–∏–∏).
3.  **Mitigation (Physical):**
    *   `Mitigated % = Armor % - Penetration %`.
    *   `Final = Damage * (1 - Mitigated) - Flat Armor`.
4.  **Mitigation (Elemental):**
    *   `Mitigated % = Resistance % - Magic Penetration %`.
5.  **Pure Damage:** –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –∑–∞—â–∏—Ç—É.

---

## 3. üî´ Trigger System Integration
–†–µ–∑–æ–ª–≤–µ—Ä –Ω–µ —Ö—Ä–∞–Ω–∏—Ç –ª–æ–≥–∏–∫—É —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤, –∞ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `GameData` (—á–µ—Ä–µ–∑ `TRIGGER_RULES`).

**–¢–æ—á–∫–∏ –≤—ã–∑–æ–≤–∞ (Hooks):**
*   `ON_HIT` / `ON_MISS`
*   `ON_CRIT`
*   `ON_DODGE` / `ON_PARRY` / `ON_BLOCK`

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
1.  –í —Ç–æ—á–∫–µ —Ö—É–∫–∞ –†–µ–∑–æ–ª–≤–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç `_resolve_triggers(ctx, step="ON_CRIT")`.
2.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∫–∞–∫–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∞–∫—Ç–∏–≤–Ω—ã –≤ `ctx.triggers`.
3.  –ï—Å–ª–∏ —Ç—Ä–∏–≥–≥–µ—Ä –∞–∫—Ç–∏–≤–µ–Ω –∏ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É —à–∞–Ω—Å–∞ -> –ü—Ä–∏–º–µ–Ω—è–µ—Ç **–ú—É—Ç–∞—Ü–∏–∏**.

**–ú—É—Ç–∞—Ü–∏–∏ (Mutations):**
*   –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤ (`ctx.flags.force.hit = True`).
*   –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤ (`ctx.mods.damage_mult = 2.0`).
*   –ó–∞—è–≤–∫–∞ –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç (`result.ability_flags.apply_bleed = True`).

---

## 4. ‚öîÔ∏è Counter Attacks
–†–µ–∑–æ–ª–≤–µ—Ä –º–æ–∂–µ—Ç –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫—É.
*   **–£—Å–ª–æ–≤–∏–µ:** –£—Å–ø–µ—à–Ω—ã–π –£–≤–æ—Ä–æ—Ç –∏–ª–∏ –ü–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ.
*   **–ü—Ä–æ–≤–µ—Ä–∫–∞:** `Counter Chance` (–∏–∑ —Å—Ç–∞—Ç–æ–≤ –∑–∞—â–∏—Ç–Ω–∏–∫–∞).
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –í `InteractionResult` —Å—Ç–∞–≤–∏—Ç—Å—è —Ñ–ª–∞–≥ `is_counter=True`.
*   **–û–±—Ä–∞–±–æ—Ç–∫–∞:** `Executor`, —É–≤–∏–¥–µ–≤ —ç—Ç–æ—Ç —Ñ–ª–∞–≥, —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –Ω–∞ –∞—Ç–∞–∫—É (Defender -> Attacker).
