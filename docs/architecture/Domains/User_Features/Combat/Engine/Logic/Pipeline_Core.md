# ‚öôÔ∏è Combat Pipeline Core

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Engine](../README.md)

---

## üéØ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è
**Combat Pipeline** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ **–æ–¥–Ω–æ–≥–æ –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è** (Interaction).
–û–Ω –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å: *"–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç, –µ—Å–ª–∏ –ê–∫—Ç–æ—Ä –ê —É–¥–∞—Ä–∏—Ç –ê–∫—Ç–æ—Ä–∞ –ë –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Å–∫–∏–ª–ª–æ–º/–ø—Ä–µ–¥–º–µ—Ç–æ–º?"*

*   **Atomic:** –ü–∞–π–ø–ª–∞–π–Ω –Ω–µ –∑–Ω–∞–µ—Ç –ø—Ä–æ "—Å–µ—Ä–∏–∏ —É–¥–∞—Ä–æ–≤" –∏–ª–∏ "–¥–≤–∞ –º–µ—á–∞". –≠—Ç–æ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ (`Executor`).
*   **Stateless:** –ü–∞–π–ø–ª–∞–π–Ω –Ω–µ —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤—ã–∑–æ–≤–∞–º–∏. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ `Context`.
*   **Deterministic:** –ü—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Stats + RNG Seed) —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ–≥–¥–∞ –æ–¥–∏–Ω–∞–∫–æ–≤.

---

## üîÑ Data Flow (–ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

```mermaid
graph TD
    Executor["Executor Service"] -->|1. Move & Stats| CB["Context Builder"]
    CB -->|2. PipelineContext| CP["Combat Pipeline"]
    
    subgraph Combat Pipeline
        CP -->|Phase 1| Pre["Pre-Calculation\n(Ability Service)"]
        Pre -->|Mods & Flags| Res["Resolver\n(Math Engine)"]
        Res -->|Result DTO| Post["Post-Calculation\n(Ability Service)"]
        Post -->|Effects| Mech["Mechanics Service\n(Apply State)"]
    end
    
    Mech -->|Result & Updated Actors| Executor
```

---

## 1. üèóÔ∏è Context Builder
**Role:** –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ "–ø—É–ª—å—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è" –±–æ–µ–º.
–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ñ–ª–∞–≥–∏ –∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ –µ–¥–∏–Ω—ã–π `PipelineContextDTO`.

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:
1.  **Intent (Move):** –°—Ç—Ä–∞—Ç–µ–≥–∏—è (`item`, `skill`, `attack`).
2.  **Source (Actor):** –ü–∞—Å—Å–∏–≤–Ω—ã–µ –Ω–∞–≤—ã–∫–∏, —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞ (—á–µ—Ä–µ–∑ `ActorStats`).
3.  **External Mods:** –í–Ω–µ—à–Ω–∏–µ —É—Å–ª–æ–≤–∏—è –æ—Ç `Executor` (–Ω–∞–ø—Ä–∏–º–µ—Ä, "—à—Ç—Ä–∞—Ñ –∑–∞ –≤—Ç–æ—Ä—É—é —Ä—É–∫—É").

### –õ–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∫–∏:
*   –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –∞—Ç–∞–∫–∏ (Physical, Magic).
*   –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã –æ—Ä—É–∂–∏—è/—Å–∫–∏–ª–ª–∞ (–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ `ctx.triggers`).
*   –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `force.crit` –æ—Ç —Ñ–∏–Ω—Ç–∞).

---

## 2. üßÆ Combat Resolver (Math Engine)
**Role:** –ß–∏—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –°—Ç–∞—Ç—ã –∏ –ö–æ–Ω—Ç–µ–∫—Å—Ç -> –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –†–µ–∑—É–ª—å—Ç–∞—Ç.
–†–∞–±–æ—Ç–∞–µ—Ç –ø–æ—à–∞–≥–æ–≤–æ. –ö–∞–∂–¥—ã–π —à–∞–≥ –º–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–≤–æ—Ä–æ—Ç).

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ (Resolution Steps)

#### Step 1: Accuracy (–¢–æ—á–Ω–æ—Å—Ç—å)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è.
*   **Event:** `ON_ACCURACY_CHECK` / `ON_MISS`.
*   **Formula:** `Base Accuracy * Multiplier`.
*   **Outcome:** –ï—Å–ª–∏ –ø—Ä–æ–≤–∞–ª -> `is_miss=True`, –≤—ã—Ö–æ–¥.

#### Step 2: Crit Check (–ö—Ä–∏—Ç)
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞—Ä–∞.
*   **Event:** `ON_CRIT` / `ON_CRIT_FAIL`.
*   **Formula:** `(Crit Chance * Skill Bonus), capped at Crit Cap`.
*   **Outcome:** –ï—Å–ª–∏ —É—Å–ø–µ—Ö -> `is_crit=True`, –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä—ã –æ—Ä—É–∂–∏—è.
*   **Note:** –ö—Ä–∏—Ç —Å–∞–º –ø–æ —Å–µ–±–µ –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Ä–æ–Ω - –æ–Ω –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ, –æ–≥–ª—É—à–µ–Ω–∏–µ, –±–æ–Ω—É—Å–Ω—ã–π —É—Ä–æ–Ω –æ—Ç –æ—Ä—É–∂–∏—è).

#### Step 3: Evasion (–£–∫–ª–æ–Ω–µ–Ω–∏–µ)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –ª–æ–≤–∫–æ—Å—Ç—å—é.
*   **Event:** `ON_DODGE` / `ON_DODGE_FAIL`.
*   **Formula:** `(Dodge Chance - Anti-Dodge)`.
*   **Outcome:** –ï—Å–ª–∏ —É—Å–ø–µ—Ö -> `is_dodged=True`, —Å—Ç–∞–≤–∏—Ç —Ñ–ª–∞–≥ `state.check_counter=True`, –≤—ã—Ö–æ–¥.

#### Step 4: Parry (–ü–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã –æ—Ä—É–∂–∏–µ–º.
*   **Event:** `ON_PARRY` / `ON_PARRY_FAIL`.
*   **Formula:** `Parry Chance`.
*   **Outcome:** –ï—Å–ª–∏ —É—Å–ø–µ—Ö -> `is_parried=True`, —Å—Ç–∞–≤–∏—Ç —Ñ–ª–∞–≥ `state.check_counter=True` (–µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ), –≤—ã—Ö–æ–¥.

#### Step 5: Block (–ë–ª–æ–∫ —â–∏—Ç–æ–º)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞—â–∏—Ç—ã —â–∏—Ç–æ–º.
*   **Event:** `ON_BLOCK` / `ON_BLOCK_FAIL`.
*   **Formula:** `Block Chance`.
*   **Outcome:** –ï—Å–ª–∏ —É—Å–ø–µ—Ö -> `is_blocked=True`.

#### Step 6: Counter Check (–ö–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∏ (–µ—Å–ª–∏ –±—ã–ª —Å–∏–≥–Ω–∞–ª –æ—Ç –∑–∞—â–∏—Ç—ã).
*   **Condition:** `state.check_counter == True`.
*   **Formula:** `Counter Chance` (+ –±–æ–Ω—É—Å—ã).
*   **Outcome:** –ï—Å–ª–∏ —É—Å–ø–µ—Ö -> `is_counter=True`, `chain_events.trigger_counter=True`.

#### Step 7: Damage Calculation (–£—Ä–æ–Ω)
–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ü–∏—Ñ—Ä.
*   **Event:** `ON_DAMAGE`.
*   **Logic:** Base -> Crit Mult -> Mitigation -> Final.

#### Step 8: Finalize (Control Check)
–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–æ–∂–µ–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –∫–æ–Ω—Ç—Ä–æ–ª—è.
*   **Event:** `ON_CHECK_CONTROL`.
*   **Logic:** –ï—Å–ª–∏ –∞—Ç–∞–∫–∞ —É—Å–ø–µ—à–Ω–∞ (`is_hit`), –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã —Ç–∏–ø–∞ `stun_on_hit`.

---

## 3. üî´ Trigger System Integration
–†–µ–∑–æ–ª–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É –ø—Ä–∞–≤–∏–ª `TRIGGER_RULES`.

**–ú–µ—Ö–∞–Ω–∏–∑–º:**
1.  –í —Ç–æ—á–∫–µ —Ö—É–∫–∞ –†–µ–∑–æ–ª–≤–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç `_resolve_triggers(ctx, step="ON_CRIT")`.
2.  –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω—É–∂–Ω—É—é —Å–µ–∫—Ü–∏—é –≤ `ctx.triggers` (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ctx.triggers.crit`).
3.  –ù–∞—Ö–æ–¥–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–ª–∞–≥–∏ (True).
4.  –ò—â–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –ø–æ ID –≤ `TRIGGER_RULES`.
5.  –ï—Å–ª–∏ –ø—Ä–∞–≤–∏–ª–æ –∞–∫—Ç–∏–≤–Ω–æ –∏ –ø—Ä–æ—à–ª–æ –ø—Ä–æ–≤–µ—Ä–∫—É —à–∞–Ω—Å–∞ -> –ü—Ä–∏–º–µ–Ω—è–µ—Ç **–ú—É—Ç–∞—Ü–∏–∏**.

**–ú—É—Ç–∞—Ü–∏–∏ (Mutations):**
*   –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–ª–∞–≥–æ–≤ (`ctx.flags.force.hit = True`).
*   –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤ (`ctx.mods.damage_mult = 2.0`).
*   –ó–∞—è–≤–∫–∞ –Ω–∞ —ç—Ñ—Ñ–µ–∫—Ç (`result.ability_flags.apply_bleed = True`).

---

## 4. ‚öîÔ∏è Counter Attacks
–ö–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞ —Ç–µ–ø–µ—Ä—å –≤—ã–Ω–µ—Å–µ–Ω–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç—Ç–∞–ø `_step_counter_check`.
*   **–°–∏–≥–Ω–∞–ª:** –≠—Ç–∞–ø—ã –∑–∞—â–∏—Ç—ã (Dodge/Parry) —Å—Ç–∞–≤—è—Ç —Ñ–ª–∞–≥ `state.check_counter`.
*   **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:** –î–ª—è –ø–∞—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –Ω—É–∂–µ–Ω –ø–µ—Ä–∫ –∏–ª–∏ —Ñ–ª–∞–≥ `state.allow_counter_on_parry`.
*   **–ë–æ–Ω—É—Å:** –§–ª–∞–≥ `formula.counter_chance_boost` –¥–∞–µ—Ç +20%.
