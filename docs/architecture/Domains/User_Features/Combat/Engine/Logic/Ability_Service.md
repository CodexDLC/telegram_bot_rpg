# ‚ú® Ability Service

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Logic](./README.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
**Location:** `apps/game_core/modules/combat/combat_engine/logic/ability_service.py`

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –¥–≤–∏–∂–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—è–º–∏ (Skills) –∏ —Ñ–∏–Ω—Ç–∞–º–∏ (Feints).
–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–≤—è–∑—å –º–µ–∂–¥—É **–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π** (GameData) –∏ **–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ–º** (Pipeline).

---

## ‚öôÔ∏è –≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 1. Pre-Process (–î–æ —Ä–∞—Å—á–µ—Ç–∞)
–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º `CombatResolver`.

1.  **Control Check:**
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ñ–ª–∞–≥–æ–≤ `is_stun`, `is_sleep`.
    *   –ï—Å–ª–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –∞–∫—Ç–∏–≤–µ–Ω -> –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –ø–∞–π–ø–ª–∞–π–Ω (`is_interrupted=True`).
2.  **Validation (Feint Check):**
    *   –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ ‚Äî —Ñ–∏–Ω—Ç, –≤—ã–∑—ã–≤–∞–µ—Ç `FeintService.validate_card(actor, action_id)`.
    *   –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ä—É–∫–µ -> –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
3.  **Cost Check & Payment:**
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ —É –∞–∫—Ç–æ—Ä–∞ HP/Energy/Tokens.
    *   –°–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã.
4.  **Config Loading:**
    *   –ó–∞–≥—Ä—É–∂–∞–µ—Ç `AbilityConfig` –∏–ª–∏ `FeintConfig` –∏–∑ `GameData`.
5.  **Context Mutation:**
    *   –í–Ω–µ–¥—Ä—è–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞ –≤ `PipelineContext`.
    *   *–ü—Ä–∏–º–µ—Ä:* `raw_mutations` (–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±–æ–Ω—É—Å –∫ —Å—Ç–∞—Ç–∞–º), `pipeline_mutations` (—Ñ–ª–∞–≥–∏ `force_crit`).

### 2. Post-Process (–ü–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞)
–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è `InteractionResult`.

1.  **Resolver Hooks:**
    *   –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç `result.ability_flags` (—Ñ–ª–∞–≥–∏, –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –≤ –†–µ–∑–æ–ª–≤–µ—Ä–µ).
    *   *–ü—Ä–∏–º–µ—Ä:* –ï—Å–ª–∏ `apply_bleed=True`, —Å–æ–∑–¥–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è.
2.  **Guaranteed Effects:**
    *   –ü—Ä–∏–º–µ–Ω—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –≤—Å–µ–≥–¥–∞ (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ø–æ–ø–∞–¥–∞–Ω–∏—è), –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ–ø–∏—Å–∞–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ.

---

## üß© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≠—Ñ—Ñ–µ–∫—Ç–∞–º–∏
–°–µ—Ä–≤–∏—Å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ `ActiveAbilityDTO`.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞:**
*   `uid`: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID.
*   `source_id`: –ö—Ç–æ –Ω–∞–ª–æ–∂–∏–ª.
*   `duration`: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–≤ —Ä–∞–∑–º–µ–Ω–∞—Ö).
*   `payload`: –î–∞–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ (—Å–∏–ª–∞ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è, —É—Ä–æ–Ω —è–¥–∞).

**–¢–∏–ø—ã —ç—Ñ—Ñ–µ–∫—Ç–æ–≤:**
*   **Buff/Debuff:** –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç —Å—Ç–∞—Ç—ã (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ `StatsEngine`).
*   **DoT/HoT:** –ù–∞–Ω–æ—Å—è—Ç —É—Ä–æ–Ω/–ª–µ—á–∞—Ç (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ —Ö–æ–¥–∞).
*   **Control:** –ë–ª–æ–∫–∏—Ä—É—é—Ç –¥–µ–π—Å—Ç–≤–∏—è.
