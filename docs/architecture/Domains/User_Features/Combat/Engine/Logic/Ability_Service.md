# Ability Service

**Class:** `AbilityService`
**Path:** `apps.game_core.modules.combat.combat_engine.logic.ability_service`
**Type:** Stateless Logic Service (Static Methods)

## üéØ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å
–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (Abilities) –∏ —Ç–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–µ–º–æ–≤ (Feints).
–û—Ä–∫–µ—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º (Pre-Calc) –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞ (Post-Calc).
–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç "—á–∏—Å—Ç–æ—Ç—É" —Ä–∞—Å—á–µ—Ç–æ–≤, —É–ø—Ä–∞–≤–ª—è—è –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º—É—Ç–∞—Ü–∏—è–º–∏ —Å—Ç–∞—Ç–æ–≤, –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.

---

## ‚öôÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–°–µ—Ä–≤–∏—Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è –≤ `CombatPipeline` –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–≤–∞ —ç—Ç–∞–ø–∞.

### 1. Pre-Process (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞)
**–¶–µ–ª—å:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `PipelineContextDTO` –∏ `ActorSnapshot` (RAW) –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–≤–∏–∂–∫–∞ (`CombatResolver`).

**–õ–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
1.  **Cleanup Expired Effects (–û—á–∏—Å—Ç–∫–∞ –°—Ç–∞—Ä–æ–≥–æ):**
    *   –ò—Ç–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ `statuses.effects`.
    *   –£–¥–∞–ª—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å—Ç–µ–∫–ª–∏ –≤ **–ø—Ä–æ—à–ª–æ–º** —Ö–æ–¥—É (`expire_at < current_exchange`).
    *   –û—á–∏—â–∞–µ—Ç –∏—Ö –º—É—Ç–∞—Ü–∏–∏ –∏–∑ `actor.raw`.
2.  **Status Check (Source & Target):**
    *   –ò—Ç–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ –∞–∫—Ç–∏–≤–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–∞–º (`ActiveEffectDTO`).
    *   –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–ª–∞–≥–∏ –∏–∑ `ControlInstructionDTO` –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –°—Ç–∞–Ω -> `can_act: False`).
    *   *(–í –±—É–¥—É—â–µ–º)* –ú–æ–∂–µ—Ç –ø—Ä–∏–º–µ–Ω—è—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Å–∏–ª—ã —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (`effect_power`) –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç.
3.  **Routing & Config:**
    *   –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è (Ability –∏–ª–∏ Feint) –∏–∑ `move.payload`.
    *   –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ [GameData](../../../../Core/RPG_Rules/Data_Schemas/README.md) (O(1)).
4.  **Cost Check:**
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ (HP, EN, Tokens).
    *   –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ç—Ä–∞—Ç—ã –≤ `ctx.result.resource_changes`.
5.  **DTO Creation & Mutations:**
    *   **ActiveAbilityDTO:** –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π DTO –≤ `statuses.abilities` (`expire_at = current_exchange`).
    *   **Raw Mutations:** –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–æ–≤ (–Ω–∞ 1 —Ö–æ–¥) –∫ `actor.raw`.
    *   **Tracking:** –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∫–ª—é—á–∏ –≤ `modified_keys` –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ—á–∏—Å—Ç–∫–∏.
6.  **Pipeline Configuration:**
    *   –ü—Ä–∏–º–µ–Ω—è–µ—Ç –ü—Ä–µ—Å–µ—Ç—ã (–Ω–∞–ø—Ä. `MAGIC_ATTACK`) –∏ –§–ª–∞–≥–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞.
    *   –í–∑–≤–æ–¥–∏—Ç –¢—Ä–∏–≥–≥–µ—Ä—ã (`ctx.triggers`).
    *   –§–æ—Ä–º–∏—Ä—É–µ—Ç `payload` —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∞–º (—Å–º. –Ω–∏–∂–µ).

### 2. Post-Process (–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è)
**–¶–µ–ª—å:** –ü—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–∞—Å—á–µ—Ç–∞ –∏ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

**–õ–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
1.  **Cleanup Temp Abilities & Collect Effects (–°–±–æ—Ä):**
    *   –ù–∞—Ö–æ–¥–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ `ActiveAbilityDTO` (–∏—Å—Ç–µ–∫—à–∏–µ –≤ **—ç—Ç–æ–º** —Ö–æ–¥—É).
    *   –£–¥–∞–ª—è–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏ –∏–∑ `actor.raw`.
    *   –ß–∏—Ç–∞–µ—Ç `payload` –∏–∑ DTO –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏—è (`is_hit`, `is_crit`...).
    *   –î–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∞–º –≤ –æ—á–µ—Ä–µ–¥—å `ctx.result.applied_effects`.
2.  **Execute Effects (–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ):**
    *   –ò—Ç–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ –æ—á–µ—Ä–µ–¥–∏ `applied_effects` (–∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ñ—Ñ–µ–∫—Ç—ã –æ—Ç –ê–±–∏–ª–∫–∏ –∏ –æ—Ç –¢—Ä–∏–≥–≥–µ—Ä–æ–≤ –†–µ–∑–æ–ª–≤–µ—Ä–∞).
    *   **Instant Actions:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (Heal, Cleanse).
    *   **Effect Creation:** –í—ã–∑—ã–≤–∞–µ—Ç `EffectFactory.create_effect` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è `ActiveEffectDTO`.
        *   –ü–µ—Ä–µ–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç (`damage_final` –∫–∞–∫ `damage_ref`) –¥–ª—è —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Bleed).
    *   **Application:** –ü—Ä–∏–º–µ–Ω—è–µ—Ç –º—É—Ç–∞—Ü–∏–∏ —ç—Ñ—Ñ–µ–∫—Ç–∞ –∫ `actor.raw` –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç DTO –≤ `statuses.effects`.

---

## üì¶ Data Flow & Structures

### ActiveAbilityDTO (Temporary Usage)
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ "–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–µ–π—Å—Ç–≤–∏—è" –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É Pre –∏ Post —ç—Ç–∞–ø–∞–º–∏.

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- |
| `uid` | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–µ–π—Å—Ç–≤–∏—è (UUID). |
| `expire_at_exchange` | –¢–µ–∫—É—â–∏–π –Ω–æ–º–µ—Ä —Ä–∞–∑–º–µ–Ω–∞ (—É–¥–∞–ª—è–µ—Ç—Å—è —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ Post-Calc). |
| `modified_keys` | –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π –≤ `actor.raw`, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã (–¥–ª—è –æ—Ç–∫–∞—Ç–∞). |
| `payload` | –°–ª–æ–≤–∞—Ä—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è Post-Calc (—ç—Ñ—Ñ–µ–∫—Ç—ã). |

### Payload Structure
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ `payload` –ø–æ–∑–≤–æ–ª—è–µ—Ç –≥–∏–±–∫–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —É—Å–ª–æ–≤–∏—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.

```json
{
  "effects": {
    "is_hit": [ 
      { "id": "burn", "params": { "duration": 3, "power": 1.5 } } 
    ],
    "is_crit": [ 
      { "id": "deep_burn", "params": { "duration": 5 } } 
    ]
  }
}
```

---

## üõ†Ô∏è Methods

### Public API
*   `pre_process(ctx, move, source, target)`: –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º.
*   `post_process(ctx, source, target, move)`: –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ—Å–ª–µ —Ä–∞—Å—á–µ—Ç–∞.

### Internal Logic (Static)
*   `_cleanup_expired_effects_pre_calc`: –£–¥–∞–ª—è–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç—ã, –∏—Å—Ç–µ–∫—à–∏–µ –≤ –ø—Ä–æ—à–ª–æ–º —Ö–æ–¥—É.
*   `_apply_status_effects`: –ü—Ä–æ–µ—Ü–∏—Ä—É–µ—Ç `ControlInstructionDTO` (–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤) –Ω–∞ `PipelineContextDTO`.
*   `_process_action_logic`: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ê–±–∏–ª–æ–∫ –∏ –§–∏–Ω—Ç–æ–≤.
*   `_process_temp_abilities_post_calc`: –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∞–±–∏–ª–æ–∫ –∏ –ø–µ—Ä–µ–Ω–æ—Å —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤ –æ—á–µ—Ä–µ–¥—å.
*   `_apply_queued_effects`: –§–∏–∑–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ —á–µ—Ä–µ–∑ `EffectFactory`.
*   `_apply_raw_mutations`: –•–µ–ª–ø–µ—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–ø–∏—Å–∏ –≤ `actor.raw`.
