# üíæ Combat Data Service

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Engine](./README.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
**Location:** `apps/game_core/modules/combat/combat_engine/combat_data_service.py`

**CombatDataService** ‚Äî —ç—Ç–æ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –∞–¥–∞–ø—Ç–µ—Ä –¥–∞–Ω–Ω—ã—Ö (Data Mapper).
–û–Ω —Å–≤—è–∑—ã–≤–∞–µ—Ç –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π `CombatManager` (Redis) —Å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π –¥–≤–∏–∂–∫–∞ (`Executor`, `Collector`).

**–ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞:** –ü—Ä–µ–≤—Ä–∞—â–∞—Ç—å —Å—ã—Ä—ã–µ JSON/Hash –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis –≤ –±–æ–≥–∞—Ç—ã–µ –¥–æ–º–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã (`BattleContext`, `ActorSnapshot`) –∏ –æ–±—Ä–∞—Ç–Ω–æ.

---

## ‚öôÔ∏è –†–æ–ª–∏ –∏ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

### 1. –î–ª—è –ö–æ–ª–ª–µ–∫—Ç–æ—Ä–∞ (Lightweight Access)
–ö–æ–ª–ª–µ–∫—Ç–æ—Ä—É –Ω–µ –Ω—É–∂–µ–Ω –≤–µ—Å—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—è. –ï–º—É –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ –∏ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –ø–∞—Ä—ã.

*   **`get_battle_meta(session_id)`**
    *   –ó–∞–≥—Ä—É–∂–∞–µ—Ç `:meta` (—Å—Ç–∞—Ç—É—Å, —à–∞–≥, —Å–ø–∏—Å–∫–∏ –∫–æ–º–∞–Ω–¥).
    *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `BattleMeta`.
*   **`get_intent_moves(session_id, char_ids)`**
    *   –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞–º–µ—Ä–µ–Ω–∏—è (`:moves`) –¥–ª—è —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤.
    *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –∫—Ç–æ —É–∂–µ –ø–æ—Ö–æ–¥–∏–ª.
*   **`push_actions_to_queue`**
    *   –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä—ã (`CombatAction`) –≤ –æ—á–µ—Ä–µ–¥—å `q:actions`.

### 2. –î–ª—è –≠–∫–∑–µ–∫—É—Ç–æ—Ä–∞ (Heavyweight Access)
–≠–∫–∑–µ–∫—É—Ç–æ—Ä—É –Ω—É–∂–µ–Ω **–ø–æ–ª–Ω—ã–π** –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤.

*   **`load_battle_context(session_id)`**
    *   –ó–∞–≥—Ä—É–∂–∞–µ—Ç **–í–°–ï** –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ (Meta, Actors, Moves).
    *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `CombatManager.load_full_context_data` (Batch Load).
    *   –°–æ–±–∏—Ä–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã `ActorSnapshot` (–ø–∞—Ä—Å–∏—Ç JSON, –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç Raw –∏ State).
    *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `BattleContext`.
*   **`commit_session(ctx)`**
    *   –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ Redis.
    *   –°–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç `ActorSnapshot` –æ–±—Ä–∞—Ç–Ω–æ –≤ JSON.
    *   –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ª–æ–≥–∏ –±–æ—è.
    *   –û—á–∏—â–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á.

---

## üîÑ Data Mapping (–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ)

### –ß—Ç–µ–Ω–∏–µ (Redis -> Domain)
1.  **Raw Data:** –ü–æ–ª—É—á–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å `{state: {...}, raw: {...}, meta: {...}}` –∏–∑ Redis.
2.  **Assembly:**
    *   –°–æ–∑–¥–∞–µ—Ç `ActorMetaDTO` (–æ–±—ä–µ–¥–∏–Ω—è—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ `meta` –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –∏–∑ `state`).
    *   –°–æ–∑–¥–∞–µ—Ç `ActorRawDTO` (Attributes, Modifiers).
    *   –°–æ–∑–¥–∞–µ—Ç `ActorLoadoutDTO`.
3.  **Result:** –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `ActorSnapshot`.

### –ó–∞–ø–∏—Å—å (Domain -> Redis)
1.  **Extraction:** –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–∑ `ActorSnapshot` —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
    *   `state` (HP, En, Tokens).
    *   `active_abilities` (—Å–ø–∏—Å–æ–∫ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤).
    *   `xp_buffer` (–Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –æ–ø—ã—Ç).
2.  **Commit:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ `CombatManager` –¥–ª—è –∑–∞–ø–∏—Å–∏ —á–µ—Ä–µ–∑ `JSON.MERGE` –∏–ª–∏ `JSON.SET`.

---

## üîó –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
*   **Uses:** `CombatManager` (Infrastructure Layer).
*   **Used By:** `CombatCollector`, `CombatExecutor`.
*   **Returns:** `BattleContext`, `BattleMeta`.
