# üé¥ –°–∏—Å—Ç–µ–º–∞ "–†—É–∫–∏" —Ñ–∏–Ω—Ç–æ–≤

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ "—Ä—É–∫–∏" —Ñ–∏–Ω—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∏–Ω—Ç–æ–≤ –∏–≥—Ä–æ–∫—É –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –¥–∞—à–±–æ—Ä–¥–∞.

### –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ "—Ä—É–∫–∞"?
- –ò–≥—Ä–æ–∫ –∂–º–µ—Ç "–û–±–Ω–æ–≤–∏—Ç—å" ‚Üí –¥–µ—Ä–≥–∞–µ—Ç –¥–∞—à–±–æ—Ä–¥
- –ë–µ–∑ —Ä—É–∫–∏ ‚Üí –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏–ª–µ—Ç–∞–ª–∏ –±—ã –ù–û–í–´–ï —Å–ª—É—á–∞–π–Ω—ã–µ —Ñ–∏–Ω—Ç—ã
- –° —Ä—É–∫–æ–π ‚Üí **—Å—Ç–∞–±–∏–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä** —Ñ–∏–Ω—Ç–æ–≤, –ø–æ–∫–∞ –∏–≥—Ä–æ–∫ –Ω–µ –≤—ã–±–µ—Ä–µ—Ç

---

## üîÑ –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

### 1. –ù–∞—á–∞–ª–æ –±–æ—è

–í—Å–µ –∞–∫—Ç–æ—Ä—ã:

tokens = 0
feints.hand = {}
feints.arsenal = [...] (–∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)

### 2. –ü–æ—Å–ª–µ exchange (–æ–±–º–µ–Ω–∞ —É–¥–∞—Ä–∞–º–∏)

MechanicService:

–ù–∞—á–∏—Å–ª—è–µ—Ç —Ç–æ–∫–µ–Ω—ã
–í—ã–∑—ã–≤–∞–µ—Ç FeintService.refill_hand()
‚Üí –ü–æ–ø–æ–ª–Ω—è–µ—Ç —Ä—É–∫—É –¥–æ MAX_HAND_SIZE
‚Üí –í—Ä–µ–º–µ–Ω–Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã

### 3. GET dashboard

Viewer:

–í—ã–∑—ã–≤–∞–µ—Ç FeintService.get_hand_for_dashboard()
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –°–¢–ê–ë–ò–õ–¨–ù–´–ô –Ω–∞–±–æ—Ä —Ñ–∏–Ω—Ç–æ–≤

### 4. –ò–≥—Ä–æ–∫ –≤—ã–±—Ä–∞–ª —Ñ–∏–Ω—Ç

TurnManager:

–í–∞–ª–∏–¥–∏—Ä—É–µ—Ç: FeintService.validate_feint_choice()
–£–±–∏—Ä–∞–µ—Ç –∏–∑ —Ä—É–∫–∏: FeintService.remove_from_hand()
–¢–æ–∫–µ–Ω—ã —É–∂–µ —Å–ø–∏—Å–∞–Ω—ã (–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ —Ä—É–∫—É)

### 5. –ï—Å–ª–∏ –∞—Ç–∞–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å

CombatResolver:

–¶–µ–ª—å —É–∂–µ –º–µ—Ä—Ç–≤–∞?
‚Üí FeintService.return_to_hand()

---

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Redis

### combat_actor:{actor_id}
```json
{
  "tokens": {
    "hit": 5,
    "crit": 2,
    "block": 3,
    "parry": 1,
    "dodge": 2,
    "tempo": 4
  },
  
  "feints": {
    "arsenal": [
      "true_strike",
      "sand_throw",
      "cleave",
      "riposte"
    ],
    "hand": {
      "true_strike": {"hit": 2},
      "sand_throw": {"tempo": 3}
    }
  }
}
```

–ü–æ–ª—è:

arsenal ‚Äî –≤–µ—Å—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –∞—Ä—Å–µ–Ω–∞–ª –∞–∫—Ç–æ—Ä–∞ (—Å—Ç–∞—Ç–∏—á–Ω—ã–π)
hand ‚Äî —Ç–µ–∫—É—â–∏–µ —Ñ–∏–Ω—Ç—ã –≤ —Ä—É–∫–µ (–∫–ª—é—á —Ñ–∏–Ω—Ç–∞ + –µ–≥–æ —Ü–µ–Ω–∞)

## ‚öôÔ∏è –ê–ª–≥–æ—Ä–∏—Ç–º –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è —Ä—É–∫–∏
MAX_HAND_SIZE = 3  # –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞, –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ actor.hand_size

```python
def refill_hand(actor: CombatActorDTO):
    """
    –ü–æ–ø–æ–ª–Ω—è–µ—Ç —Ä—É–∫—É –¥–æ MAX_HAND_SIZE —Ñ–∏–Ω—Ç–æ–≤.
    –í—Ä–µ–º–µ–Ω–Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã –∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∏–Ω—Ç—ã.
    """
    
    # 1. –°–æ–±–∏—Ä–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∏–Ω—Ç—ã (–ø–æ —Ç–æ–∫–µ–Ω–∞–º)
    available_pool = []
    for feint_id in actor.feints.arsenal:
        feint_config = get_feint_config(feint_id)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ö–≤–∞—Ç–∞–µ—Ç –ª–∏ —Ç–æ–∫–µ–Ω–æ–≤
        if can_afford(actor.tokens, feint_config.cost):
            available_pool.append(feint_id)
    
    # 2. –§–∏–ª—å—Ç—Ä—É–µ–º –¥—É–±–ª–∏ (–∏—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –≤ —Ä—É–∫–µ)
    available_pool = [f for f in available_pool if f not in actor.feints.hand]
    
    # 3. –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ –¥–æ MAX_HAND_SIZE
    while len(actor.feints.hand) < MAX_HAND_SIZE and available_pool:
        feint_id = random.choice(available_pool)
        feint_config = get_feint_config(feint_id)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ä—É–∫—É
        actor.feints.hand[feint_id] = feint_config.cost.tactics
        
        # –í—Ä–µ–º–µ–Ω–Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã
        deduct_tokens(actor.tokens, feint_config.cost.tactics)
        
        # –£–±–∏—Ä–∞–µ–º –∏–∑ –ø—É–ª–∞
        available_pool.remove(feint_id)
```

## üéØ –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
1. –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤
available_pool –ø—É—Å—Ç–æ–π ‚Üí —Ä—É–∫—É –Ω–µ –ø–æ–ø–æ–ª–Ω—è–µ–º
–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä–æ–∫—É —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—É—é –∞—Ç–∞–∫—É

2. –î–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∏–Ω—Ç–æ–≤ –º–µ–Ω—å—à–µ MAX_HAND_SIZE
–ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ (1-2 —Ñ–∏–Ω—Ç–∞)
–ü—É—Å—Ç—ã–µ —Å–ª–æ—Ç—ã –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º

3. –ê—Ç–∞–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å (—Ü–µ–ª—å –º–µ—Ä—Ç–≤–∞)
–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–Ω—Ç –≤ —Ä—É–∫—É
–í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–∫–µ–Ω—ã (–≤—Ä–µ–º–µ–Ω–Ω–æ —Å–ø–∏—Å–∞–Ω–Ω—ã–µ)

4. –ê–∫—Ç–æ—Ä —É–º–µ—Ä
–ù–ï –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–∫–µ–Ω—ã/—Ñ–∏–Ω—Ç—ã
–ï—Å–ª–∏ –≤–æ—Å–∫—Ä–µ—Å—è—Ç ‚Üí —Å–æ–±–∏—Ä–∞–µ—Ç –∑–∞–Ω–æ–≤–æ
–ú–µ–∂–¥—É –±–æ—è–º–∏ —Ç–æ–∫–µ–Ω—ã –ù–ï —Ö—Ä–∞–Ω—è—Ç—Å—è

5. Insta-skill
–§–ª–∞–≥ –æ—Ç–∫–ª—é—á–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ñ–∏–Ω—Ç–æ–≤
–ö–∞–∫ —Å –¥–æ—Ç–∞–º–∏

## ü§ñ –ú–æ–Ω—Å—Ç—Ä—ã
–ú–æ–Ω—Å—Ç—Ä—ã = —Ç–µ –∂–µ –∞–∫—Ç–æ—Ä—ã
–¢–æ–∂–µ –∫–æ–ø—è—Ç —Ç–æ–∫–µ–Ω—ã –∏ –ø–æ–ª—É—á–∞—é—Ç —Ñ–∏–Ω—Ç—ã
–ü—É–ª —Ñ–∏–Ω—Ç–æ–≤ –º–µ–Ω—å—à–µ (3-5 –Ω–∞ –∫–ª–∞–Ω)
AI Worker —Ä–µ—à–∞–µ—Ç —á—Ç–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
MechanicService
```python
def process_mechanic(context: BattleContext):
    # ... –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ ...
    
    # –ü–æ–ø–æ–ª–Ω—è–µ–º —Ä—É–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–æ—Ä–∞
    for actor in context.actors:
        FeintService.refill_hand(actor)
```

TurnManager
```python
def validate_intent(intent: IntentDTO):
    if intent.feint_key:
        if not FeintService.validate_feint_choice(actor, intent.feint_key):
            raise InvalidFeintError()
        
        FeintService.remove_from_hand(actor, intent.feint_key)
```

Viewer
```python
def build_dashboard(actor: CombatActorDTO):
    hand = FeintService.get_hand_for_dashboard(actor)
    # hand = {"true_strike": "–í–µ—Ä–Ω—ã–π —É–¥–∞—Ä", "sand_throw": "–ë—Ä–æ—Å–æ–∫ –ø–µ—Å–∫–∞"}
```

## üìä –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã
–†–∞—É–Ω–¥ 1:
  tokens: {hit: 0, crit: 0, ...}
  hand: {}
  UI: [–ü—Ä–æ—Å—Ç–∞—è –∞—Ç–∞–∫–∞]

Exchange 1 ‚Üí +3 hit, +1 crit
  MechanicService.refill_hand()
  available_pool: [true_strike, cleave] (–ø–æ —Ç–æ–∫–µ–Ω–∞–º)
  hand: {true_strike: {hit: 2}}
  tokens: {hit: 1, crit: 1} (–≤—Ä–µ–º–µ–Ω–Ω–æ —Å–ø–∏—Å–∞–Ω–æ 2 hit)
  UI: [–ü—Ä–æ—Å—Ç–∞—è –∞—Ç–∞–∫–∞] [–í–µ—Ä–Ω—ã–π —É–¥–∞—Ä]

–ò–≥—Ä–æ–∫ –≤—ã–±—Ä–∞–ª true_strike:
  TurnManager.remove_from_hand()
  hand: {}
  tokens: {hit: 1, crit: 1} (—É–∂–µ —Å–ø–∏—Å–∞–Ω–æ)

Exchange 2 ‚Üí +2 hit, +1 crit
  tokens: {hit: 3, crit: 2}
  MechanicService.refill_hand()
  hand: {cleave: {hit: 2, crit: 1}}
  tokens: {hit: 1, crit: 1}
  UI: [–ü—Ä–æ—Å—Ç–∞—è –∞—Ç–∞–∫–∞] [–†–∞—Å—Å–µ—á–µ–Ω–∏–µ]

## ‚úÖ TODO: –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è
- [ ] –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä —Ä—É–∫–∏ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è/–ø–µ—Ä–∫–æ–≤)
- [ ] –ê–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è abilities
- [ ] –û—Ç–¥–µ–ª—å–Ω—ã–µ –ø—É–ª—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ñ–∏–Ω—Ç–æ–≤