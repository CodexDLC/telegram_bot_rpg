# ‚ö° Combat Executor

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Processors](./README.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
**Location:** `apps/game_core/modules/combat/combat_engine/processors/executor.py`

**Executor** ‚Äî —ç—Ç–æ "–¥–∏—Ä–∏–∂–µ—Ä" –±–æ–µ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞. –û–Ω –ø–æ–ª—É—á–∞–µ—Ç –∑–∞–¥–∞—á—É –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ (`CombatAction`) –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –µ—ë –≤ —Å–µ—Ä–∏—é –≤—ã–∑–æ–≤–æ–≤ –ü–∞–π–ø–ª–∞–π–Ω–∞.
–û–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏—é **"–í—Å—ë –≤ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ"**: –≤–µ—Å—å –∫–∞—Å–∫–∞–¥ —É–¥–∞—Ä–æ–≤ (–∞—Ç–∞–∫–∞, –≤—Ç–æ—Ä–∞—è —Ä—É–∫–∞, –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∞) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `process_batch`, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å —Ä–∞–∑–º–µ–Ω–∞.

---

## üèóÔ∏è Class Structure (API)

### Public Methods

#### `process_batch(ctx: BattleContext, actions: list[CombatActionDTO]) -> list[str]`
–ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞–∫–µ—Ç –¥–µ–π—Å—Ç–≤–∏–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ.
*   **ctx:** –ö–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—è (–∏–∑–º–µ–Ω—è–µ—Ç—Å—è in-place).
*   **actions:** –°–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
*   **Returns:** –°–ø–∏—Å–æ–∫ ID —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (`move_id`).

---

### Private Methods (Internal Logic)

#### `_process_single_action(ctx, action) -> None`
–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—è –∏ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫.
*   –ï—Å–ª–∏ `exchange` -> `_handle_exchange`.
*   –ï—Å–ª–∏ `instant/item` -> `_handle_unidirectional`.

#### `_handle_exchange(ctx, action) -> None`
**Core Logic.** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥—É—ç–ª—å (—Ä–∞–∑–º–µ–Ω —É–¥–∞—Ä–∞–º–∏).
*   –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ü–∏–∫–ª **Waves (–í–æ–ª–Ω)**.
*   –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã (Chain Reactions) –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ Pipeline.
*   –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ (`step_counter`, `exchange_counter`).

#### `_handle_unidirectional(ctx, action) -> None`
–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (—Ö–∏–ª, –±–∞—Ñ—Ñ, AOE).
*   –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º—É–ª—å—Ç–∏-—Ç–∞—Ä–≥–µ—Ç (—Å–ø–∏—Å–æ–∫ `target_ids`).
*   **–ù–µ** –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ç —Å—á–µ—Ç—á–∏–∫–∏ –±–æ—è.

#### `_create_task(source, target, move, mods=None)`
–•–µ–ª–ø–µ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ Pipeline.
*   –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—ã–∑–æ–≤ `pipeline.calculate`.
*   –ü—Ä–æ–∫–∏–¥—ã–≤–∞–µ—Ç `exchange_count` –∏ –≤–Ω–µ—à–Ω–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (`mods`).

---

## üîÑ Executor Flow (Processing Loop)

```mermaid
graph TD
    Start[Action] --> Type{Type?}
    
    Type -->|Unidirectional| Uni[Loop Targets]
    Uni -->|Parallel| PipeUni[Pipeline Calc]
    
    Type -->|Exchange| Ex[Init Waves]
    Ex --> Wave1[Wave 1: Main Attacks]
    Wave1 -->|Parallel| PipeEx[Pipeline Calc]
    PipeEx --> Result[Result Analysis]
    
    Result -->|Trigger: Offhand| Wave2[Add to Next Wave]
    Result -->|Trigger: Counter| Wave2
    
    Wave2 -->|Loop| PipeEx
    
    PipeEx -->|No More Triggers| Final[Finalize]
    Final -->|Increment Counters| Done
```

---

## ‚öôÔ∏è –ê–ª–≥–æ—Ä–∏—Ç–º –†–∞–±–æ—Ç—ã

### 1. Exchange Mode (–†–∞–∑–º–µ–Ω)
–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—É—ç–ª–∏ –º–µ–∂–¥—É –¥–≤—É–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ (A –∏ B). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º **Waves (–í–æ–ª–Ω)** –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ø–Ω—ã—Ö —Ä–µ–∞–∫—Ü–∏–π.

#### Wave 1: Initial Clash
*   –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ **A -> B** (Main Hand).
*   –ï—Å–ª–∏ –µ—Å—Ç—å `partner_move`, —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ **B -> A** (Main Hand).
*   –ó–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —á–µ—Ä–µ–∑ `asyncio.gather`.

#### Wave 2+: Chain Reactions
Executor –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–µ—Ä–≤–æ–π –≤–æ–ª–Ω—ã –Ω–∞ –Ω–∞–ª–∏—á–∏–µ **–¢—Ä–∏–≥–≥–µ—Ä–æ–≤** (–≤ `InteractionResultDTO.chain_events`):
1.  **Off-Hand Attack:** –ï—Å–ª–∏ Pipeline —Ä–µ—à–∏–ª, —á—Ç–æ –Ω—É–∂–Ω–æ —É–¥–∞—Ä–∏—Ç—å –≤—Ç–æ—Ä–æ–π —Ä—É–∫–æ–π -> –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ `A -> B (Off Hand)`.
2.  **Counter-Attack:** –ï—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª —Ç—Ä–∏–≥–≥–µ—Ä –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —É–∫–ª–æ–Ω–µ–Ω–∏—è) -> –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–¥–∞—á–∞ `B -> A (Counter)`.
3.  **Extra Strike:** –ï—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª –ø–µ—Ä–∫ –Ω–∞ –¥–≤–æ–π–Ω–æ–π —É–¥–∞—Ä.

–¶–∏–∫–ª –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (—Å –ª–∏–º–∏—Ç–æ–º `MAX_WAVES = 3` –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è).

#### Finalization
*   –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è —Å—á–µ—Ç—á–∏–∫–∏ `exchange_counter` (–¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤) –∏ `step_counter` (–≥–ª–æ–±–∞–ª—å–Ω—ã–π).
*   –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ–Ω–∞.

### 2. Unidirectional Mode (–û–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ)
–î–ª—è –¥–µ–π—Å—Ç–≤–∏–π —Ç–∏–ø–∞ `item`, `instant` –∏–ª–∏ `cast`.
*   Executor –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π (`target_ids`).
*   –°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É –¥–ª—è **–∫–∞–∂–¥–æ–π** —Ü–µ–ª–∏ (AOE).
*   –í—ã–ø–æ–ª–Ω—è–µ—Ç –∏—Ö –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
*   **–í–∞–∂–Ω–æ:** –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ —Å—á–µ—Ç—á–∏–∫–∏ (`exchange_counter`) **–Ω–µ** –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É—é—Ç—Å—è.

---

## üìä Data Flow
1.  **Input:** `BattleContext` (Mutable) + `CombatActionDTO`.
2.  **Process:** –ú—É—Ç–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ Pipeline (HP, Tokens).
3.  **Output:** –°–ø–∏—Å–æ–∫ ID –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π (`processed_ids`).
