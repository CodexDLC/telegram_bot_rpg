# üì• Combat Collector

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Processors](./README.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
**Location:** `apps/game_core/modules/combat/combat_engine/processors/collector.py`

**Collector** ‚Äî —ç—Ç–æ —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–±–∏—Ä–∞–µ—Ç –∑–∞—è–≤–∫–∏ –æ—Ç –∏–≥—Ä–æ–∫–æ–≤ (`CombatMove`) –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏–∑ –Ω–∏—Ö –ø–∞–∫–µ—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ (`CombatAction`).
–û–Ω —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É **—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏** –≤ –ø–æ—à–∞–≥–æ–≤–æ–º –±–æ—é (RBC).

---

## üîÑ Collector Flow (Matchmaking)
–ü—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∞ –∑–∞—è–≤–æ–∫ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä.

```mermaid
graph TD
    Trigger[Signal / Timer] --> Task(CollectorTask)
    Task -->|Load Meta & Moves| Coll[CombatCollector]
    Coll -->|Check AI| AI{AI Missing?}
    AI -->|Yes| DispatchAI[Dispatch AI Task]
    Coll -->|Harvest Instant| Queue[Actions Queue]
    Coll -->|Match Exchange| Queue
    Coll -->|Check Timeout| Timeout{Timeout?}
    Timeout -->|Yes| Force[Create Force Action]
    Force --> Queue
    Queue -->|Batch > 0| Exec[Dispatch Executor]
```

---

## ‚öôÔ∏è –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

### 1. Immediate Mode (–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è)
–î–ª—è –¥–µ–π—Å—Ç–≤–∏–π —Ç–∏–ø–∞ `item` (–≤—ã–ø–∏—Ç—å –∑–µ–ª—å–µ) –∏–ª–∏ `instant` (–±—ã—Å—Ç—Ä—ã–π —Å–∫–∏–ª–ª).
*   **Trigger:** –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏.
*   **Action:** –°—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á—É –¥–ª—è Executor'–∞.
*   **Queue:** –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å.

### 2. Exchange Mode (–†–∞–∑–º–µ–Ω —É–¥–∞—Ä–∞–º–∏)
–î–ª—è –¥–µ–π—Å—Ç–≤–∏–π —Ç–∏–ø–∞ `attack` (–æ—Å–Ω–æ–≤–Ω–æ–π –±–æ–π).
*   **Logic:** –ñ–¥–µ—Ç, –ø–æ–∫–∞ **–æ–±–∞** —É—á–∞—Å—Ç–Ω–∏–∫–∞ (–ê—Ç–∞–∫—É—é—â–∏–π –∏ –¶–µ–ª—å) —Å–¥–µ–ª–∞—é—Ç —Ö–æ–¥.
*   **Timeout:** –ï—Å–ª–∏ –≤—Ç–æ—Ä–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –≤ —Ç–µ—á–µ–Ω–∏–µ N —Å–µ–∫—É–Ω–¥ -> –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–ø—É—Å–∫ —Ö–æ–¥–∞ (AFK).
*   **Pairing:** –ù–∞—Ö–æ–¥–∏—Ç –ø–∞—Ä—É –∑–∞—è–≤–æ–∫ (Move A -> B –∏ Move B -> A) –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∏—Ö –≤ –æ–¥–∏–Ω `CombatAction(exchange)`.

---

## üîÑ ARQ Integration
Collector —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å (–∏–ª–∏ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É –∏–∑ ARQ).
*   –°–ª—É—à–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å `arq:combat_collector`.
*   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∞–π–º–∞—É—Ç—ã ("–ö—Ç–æ –Ω–µ –ø–æ—Ö–æ–¥–∏–ª?").
*   –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è AI (–µ—Å–ª–∏ –±–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ—Ö–æ–¥–∏—Ç—å).
