# üë∑ Combat Workers (ARQ Tasks)

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Engine](../README.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
**Location:** `apps/game_core/modules/combat/combat_engine/workers/tasks/`

–≠—Ç–æ—Ç —Å–ª–æ–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** –ª–æ–≥–∏–∫–∏ –¥–≤–∏–∂–∫–∞.
–ó–∞–¥–∞—á–∏ (Tasks) –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `arq` (Redis Queue) –∏ —É–ø—Ä–∞–≤–ª—è—é—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–æ–≤ (`Executor`, `Collector`).

---

## 1. ‚ö° Executor Task
**File:** `executor_task.py`
**Queue:** `q:actions` (—á–∏—Ç–∞–µ—Ç –∏–∑ Redis List, –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É)

–ì–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ –ø–æ —Ä–∞—Å—á–µ—Ç—É –±–æ—è. –†–µ–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω **Safe Execution** —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –≥–æ–Ω–æ–∫ (Race Conditions).

### –ê–ª–≥–æ—Ä–∏—Ç–º (Lifecycle)
1.  **Load Context:** –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—è (`BattleContext`) —á–µ—Ä–µ–∑ `DataService`.
2.  **Lock Acquisition:**
    *   –ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å **Busy Lock** (`combat:rbc:{sid}:sys:busy`).
    *   –ï—Å–ª–∏ –∑–∞–Ω—è—Ç–æ -> –≤—ã—Ö–æ–¥ (–¥—Ä—É–≥–æ–π –≤–æ—Ä–∫–µ—Ä —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç).
3.  **Fetch Actions:** –ß–∏—Ç–∞–µ—Ç –ø–∞—á–∫—É –¥–µ–π—Å—Ç–≤–∏–π (`LPOP`) –∏–∑ –æ—á–µ—Ä–µ–¥–∏ `q:actions`.
4.  **Process:** –ü–µ—Ä–µ–¥–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –≤ `CombatExecutor` –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.
5.  **Zombie Check (Critical):**
    *   –ü–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–ª–∞–¥–µ–µ—Ç –ª–∏ –æ–Ω –≤—Å–µ –µ—â–µ –ª–æ–∫–æ–º.
    *   –ï—Å–ª–∏ –ª–æ–∫ –∏—Å—Ç–µ–∫ (–≤–æ—Ä–∫–µ—Ä –∑–∞–≤–∏—Å) -> **Abort** (–Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç, —á—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ).
6.  **Commit:** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Redis.
7.  **Release & Signal:** –°–Ω–∏–º–∞–µ—Ç –ª–æ–∫ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `heartbeat` –∫–æ–ª–ª–µ–∫—Ç–æ—Ä—É.

---

## 2. üì• Collector Task
**File:** `collector_task.py`
**Queue:** `arq:combat_collector`

–ó–∞–¥–∞—á–∞-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä. –†–µ–∞–≥–∏—Ä—É–µ—Ç –Ω–∞ —Å–∏–≥–Ω–∞–ª—ã (`CollectorSignalDTO`).

### –¢–∏–ø—ã –°–∏–≥–Ω–∞–ª–æ–≤
*   **`check_immediate`:** –ü—Ä–∏—à–ª–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–∑–µ–ª—å–µ). –ó–∞–ø—É—Å–∫–∞–µ—Ç Executor.
*   **`check_timeout`:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–π–º–µ—Ä–æ–≤ (AFK). –ï—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ -> Force Skip.
*   **`heartbeat`:** –°–∏–≥–Ω–∞–ª –æ—Ç Executor'–∞ "–Ø –∑–∞–∫–æ–Ω—á–∏–ª". –ö–æ–ª–ª–µ–∫—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –µ—â–µ –∑–∞–¥–∞—á–∏.

---

## 3. ü§ñ AI Turn Task
**File:** `ai_turn_task.py`
**Queue:** `arq:combat_ai`

–ó–∞–¥–∞—á–∞ –¥–ª—è —Ö–æ–¥–∞ NPC/–ú–æ–±–æ–≤.

```mermaid
graph TD
    Task(AiTurnTask) -->|Load Context| Agent[GhostAgent]
    Agent -->|Analyze Tokens| Logic[Decision Logic]
    Logic -->|Select Action| Intent[Intent]
    Intent -->|Register Batch| TM[TurnManager]
    TM -->|Push| Redis[(Redis: Moves)]
```

*   **Trigger:** –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ö–æ–ª–ª–µ–∫—Ç–æ—Ä–æ–º, –∫–æ–≥–¥–∞ –Ω–∞—Å—Ç—É–ø–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –±–æ—Ç–∞.
*   **Logic:**
    1.  –ó–∞–≥—Ä—É–∂–∞–µ—Ç `AIProcessor`.
    2.  –í—ã–±–∏—Ä–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ (Attack/Heal).
    3.  –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ö–æ–¥ —á–µ—Ä–µ–∑ `CombatManager` (–∫–∞–∫ –æ–±—ã—á–Ω—ã–π –∏–≥—Ä–æ–∫).

---

## 4. üåÄ Chaos Task
**File:** `chaos_task.py`
**Queue:** `arq:default`

–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.
*   **Cleanup:** –£–¥–∞–ª—è–µ—Ç "–º–µ—Ä—Ç–≤—ã–µ" —Å–µ—Å—Å–∏–∏ (–≥–¥–µ –≤—Å–µ –≤—ã—à–ª–∏).
*   **Stuck Check:** –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∑–∞–≤–∏—Å—à–∏–µ –ª–æ–∫–∏.
*   **Resend:** –ü–µ—Ä–µ–æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.
