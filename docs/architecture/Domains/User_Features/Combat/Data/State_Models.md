# üíæ State Models (Session & Actor)

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Data](../README.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç **–°–æ—Å—Ç–æ—è–Ω–∏–µ (State)** –±–æ–µ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.
–≠—Ç–æ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å) –∏–ª–∏ –≤ –ø–∞–º—è—Ç–∏ –í–æ—Ä–∫–µ—Ä–∞ (BattleContext) –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ö–æ–¥–∞.

**–ò—Å—Ç–æ—á–Ω–∏–∫–∏:**
*   `apps/game_core/modules/combat/dto/combat_session_dto.py`
*   `apps/game_core/modules/combat/dto/combat_actor_dto.py`

---

## 1. üåç Session Layer (–ö–æ–Ω—Ç–µ–∫—Å—Ç –ë–æ—è)

### 1.1. `BattleContext` (In-Memory Root)
–ö–æ—Ä–Ω–µ–≤–æ–π –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è `ContextLoader`'–æ–º –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ —Å–µ—Ä–≤–∏—Å—ã.
–°–æ–¥–µ—Ä–∂–∏—Ç **–≤—Å–µ** –¥–∞–Ω–Ω—ã–µ, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Ç–∞–∫—Ç–∞ –±–æ—è.

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `session_id` | `str` | UUID —Å–µ—Å—Å–∏–∏. |
| `meta` | `BattleMeta` | –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. |
| `actors` | `dict[str, ActorSnapshot]` | –°–ª–æ–≤–∞—Ä—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∫–ª—é—á: `char_id` –∫–∞–∫ —Å—Ç—Ä–æ–∫–∞). |
| `moves_cache` | `dict` | –ö—ç—à –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º—É–≤–æ–≤ (—á—Ç–æ–±—ã –Ω–µ —Ö–æ–¥–∏—Ç—å –≤ Redis –¥–≤–∞–∂–¥—ã). |
| `targets` | `dict[str, list[int]]` | –ö—ç—à —Ü–µ–ª–µ–π (–∫—Ç–æ –∫–æ–≥–æ –±—å–µ—Ç). |
| `pending_logs` | `list[dict]` | –õ–æ–≥–∏, –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –∑–∞ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, –Ω–æ –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ. |
| `pending_target_returns` | `list[dict]` | –û—á–µ—Ä–µ–¥—å –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ü–µ–ª–µ–π –≤ —Å–ø–∏—Å–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. |

### 1.2. `BattleMeta` (Redis: `:meta`)
–õ–µ–≥–∫–æ–≤–µ—Å–Ω—ã–µ –º–µ—Ç–∞-–¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏. –î–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —á—Ç–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞).

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `active` | `int` | –°—Ç–∞—Ç—É—Å –±–æ—è (1 - –∞–∫—Ç–∏–≤–µ–Ω, 0 - –∑–∞–≤–µ—Ä—à–µ–Ω). |
| `step_counter` | `int` | –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —Ö–æ–¥–æ–≤/—Å–æ–±—ã—Ç–∏–π. |
| `active_actors_count` | `int` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–∏–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. |
| `teams` | `dict[str, list]` | –°–ø–∏—Å–∫–∏ ID —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º (`red`, `blue`). |
| `winner` | `str \| None` | ID –ø–æ–±–µ–¥–∏–≤—à–µ–π –∫–æ–º–∞–Ω–¥—ã. |
| `dead_actors` | `list` | –°–ø–∏—Å–æ–∫ ID –ø–æ–≥–∏–±—à–∏—Ö. |
| `battle_type` | `str` | –¢–∏–ø –±–æ—è (PVE, PVP). |
| `location_id` | `str` | –ì–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –±–æ–π. |

### 1.3. `CombatInitContextDTO`
DTO –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–æ–≤–æ–π —Å–µ—Å—Å–∏–∏ (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ `CombatInitService`).

*   **`mode`**: –†–µ–∂–∏–º –±–æ—è (`standard`, `duel`, `raid`).
*   **`teams`**: –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ `CombatTeamDTO`.

#### `CombatTeamDTO`
*   `players`: `list[int]` (ID –∏–≥—Ä–æ–∫–æ–≤).
*   `pets`: `list[int]` (ID –ø–∏—Ç–æ–º—Ü–µ–≤).
*   `monsters`: `list[str]` (ID —à–∞–±–ª–æ–Ω–æ–≤ –º–æ–Ω—Å—Ç—Ä–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä `goblin_warrior`).

---

## 2. üë§ Actor Layer (–£—á–∞—Å—Ç–Ω–∏–∫ –ë–æ—è)

–ê–∫—Ç–æ—Ä ‚Äî —ç—Ç–æ —Å–æ—Å—Ç–∞–≤–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å. –í –∫–æ–¥–µ –æ–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å–æ–º `ActorSnapshot`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–ª—é—á–µ–π Redis.

### 2.1. `ActorSnapshot` (Aggregator)
–ü–æ–ª–Ω—ã–π —Å–ª–µ–ø–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞.

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| **`meta`** | `ActorMetaDTO` | "–ì–æ—Ä—è—á–∏–µ" –¥–∞–Ω–Ω—ã–µ (HP, Energy, Status). |
| **`raw`** | `ActorRawDTO` | "–•–æ–ª–æ–¥–Ω—ã–µ" –¥–∞–Ω–Ω—ã–µ (–ê—Ç—Ä–∏–±—É—Ç—ã, –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç—ã). |
| **`loadout`** | `ActorLoadoutDTO` | –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è. |
| **`stats`** | `ActorStats` | **–†–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–µ** —Å—Ç–∞—Ç—ã (In-Memory only). |
| `skills` | `dict` | –£—Ä–æ–≤–Ω–∏ —Å–∫–∏–ª–ª–æ–≤. |
| **`statuses`** | `ActorStatusesDTO` | –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π (Abilities + Effects). |
| `xp_buffer` | `dict` | –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π –æ–ø—ã—Ç –∑–∞ –±–æ–π. |

### 2.2. `ActorMetaDTO` (State)
–ò–∑–º–µ–Ω—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ, –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–π —Ö–æ–¥.

*   **Identity:** `id`, `name`, `type` (player/monster), `team`, `is_ai`.
*   **Vitals:**
    *   `hp` / `max_hp`: –ó–¥–æ—Ä–æ–≤—å–µ.
    *   `en` / `max_en`: –≠–Ω–µ—Ä–≥–∏—è.
*   **Status:**
    *   `is_dead`: –§–ª–∞–≥ —Å–º–µ—Ä—Ç–∏.
    *   `tactics`: –û—á–∫–∏ —Ç–∞–∫—Ç–∏–∫–∏ (–Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ–º—ã–π —Ä–µ—Å—É—Ä—Å).
    *   `tokens`: –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (Combo points, Runes –∏ —Ç.–¥.).
*   **Feints:**
    *   `feints` (`FeintHandDTO`): –°–∏—Å—Ç–µ–º–∞ "—Ä—É–∫–∏" —Ñ–∏–Ω—Ç–æ–≤ (–∞—Ä—Å–µ–Ω–∞–ª + —Ç–µ–∫—É—â–∞—è —Ä—É–∫–∞).

### 2.3. `ActorRawDTO` (Math Source)
–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–≤–∏–∂–∫–∞.

*   **`attributes`**: –ë–∞–∑–æ–≤—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã (Strength, Agility, Intellect...). –°—Ç—Ä—É–∫—Ç—É—Ä–∞: `{base: 10, source: {...}, temp: {...}}`.
*   **`modifiers`**: –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –æ—Ç –ø–∞—Å—Å–∏–≤–æ–∫/—ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏.

### 2.4. `ActorStats` (Calculated)
–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã `StatsEngine`. –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ **–Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è** –≤ –±–∞–∑–µ, –∞ –≤—ã—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –ª–µ—Ç—É –∏–∑ `raw` + `statuses`.

*   **`mods`** (`CombatModifiersDTO`): –§–∏–Ω–∞–ª—å–Ω—ã–µ –ø–ª–æ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (Physical Damage, Crit Chance, Evasion).
*   **`skills`** (`CombatSkillsDTO`): –ó–Ω–∞—á–µ–Ω–∏—è —Å–∫–∏–ª–ª–æ–≤.

### 2.5. `ActorStatusesDTO` (Container)
–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.

*   **`abilities`** (`list[ActiveAbilityDTO]`): –°—Ç–æ–π–∫–∏, —á–∞–Ω–Ω–µ–ª–∏–Ω–≥, –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–µ —É–¥–∞—Ä—ã.
*   **`effects`** (`list[ActiveEffectDTO]`): –ë–∞—Ñ—Ñ—ã, –¥–µ–±–∞—Ñ—Ñ—ã, –∫–æ–Ω—Ç—Ä–æ–ª—å.

#### `ActiveEffectDTO`
*   `uid`: –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∏–Ω—Å—Ç–∞–Ω—Å–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞.
*   `effect_id`: ID —ç—Ñ—Ñ–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `buff_strength`).
*   `source_id`: –ö—Ç–æ –Ω–∞–ª–æ–∂–∏–ª.
*   `expire_at_exchange`: –ù–æ–º–µ—Ä —Ä–∞–∑–º–µ–Ω–∞, –∫–æ–≥–¥–∞ —ç—Ñ—Ñ–µ–∫—Ç –∏—Å—á–µ–∑–Ω–µ—Ç.
*   `impact`: –í–ª–∏—è–Ω–∏–µ –Ω–∞ Vitals (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{"hp": -10}` –∫–∞–∂–¥—ã–π —Ö–æ–¥).
*   `control`: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫–æ–Ω—Ç—Ä–æ–ª—è (`ControlInstructionDTO`).
*   `modified_keys`: –°–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π –≤ `raw.modifiers`, –∫–æ—Ç–æ—Ä—ã–µ —ç—Ç–æ—Ç —ç—Ñ—Ñ–µ–∫—Ç –∏–∑–º–µ–Ω–∏–ª (–¥–ª—è –æ—Ç–∫–∞—Ç–∞).

---

## 3. üé¥ Feint System DTO

### 3.1. `FeintHandDTO`
–û–ø–∏—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —Ñ–∏–Ω—Ç–æ–≤ –∞–∫—Ç–æ—Ä–∞.

*   **`arsenal`** (`list[str]`): –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–∏–Ω—Ç–æ–≤ (–∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞/—ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏).
*   **`hand`** (`dict[str, dict]`): –¢–µ–∫—É—â–∏–µ —Ñ–∏–Ω—Ç—ã –≤ —Ä—É–∫–µ.
    *   –ö–ª—é—á: ID —Ñ–∏–Ω—Ç–∞.
    *   –ó–Ω–∞—á–µ–Ω–∏–µ: –°—Ç–æ–∏–º–æ—Å—Ç—å (`FeintCostDTO`).

### 3.2. `FeintCostDTO`
–°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–Ω—Ç–∞.

*   **`tactics`** (`dict[str, int]`): –°–ª–æ–≤–∞—Ä—å —Ç–æ–∫–µ–Ω–æ–≤.
    *   –ü—Ä–∏–º–µ—Ä: `{"hit": 2, "tempo": 1}`.
