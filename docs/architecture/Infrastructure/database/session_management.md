# üîÑ Database Session Management

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](README.md)

> **Source:** `apps/common/database/session.py`

## 1. Configuration
–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ `asyncpg` —Å –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

*   **Pool Size:** 20 (Max Overflow: 10).
*   **Expire on Commit:** `False` (–û–±—ä–µ–∫—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞, –Ω–æ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ Detached, –µ—Å–ª–∏ —Å–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞).
*   **SSL:** –í–∫–ª—é—á–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ `settings.db_ssl_require=True`.

## 2. Session Lifecycle (`get_async_session`)

–í –ø—Ä–æ–µ–∫—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä `get_async_session`, –∫–æ—Ç–æ—Ä—ã–π —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

```python
async with get_async_session() as session:
    # ... logic ...
    # AUTO-COMMIT –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –±–ª–æ–∫–∞
```

*   **Success:** –ï—Å–ª–∏ –±–ª–æ–∫ –∫–æ–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω –±–µ–∑ –æ—à–∏–±–æ–∫ -> `session.commit()`.
*   **Exception:** –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ -> `session.rollback()`.
*   **Finally:** –°–µ—Å—Å–∏—è –≤—Å–µ–≥–¥–∞ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è (`session.close()`).

## 3. Best Practices

### ‚ùå Anti-Patterns
*   **N+1 Problem:** –ù–µ –¥–µ–ª–∞–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –≤ —Ü–∏–∫–ª–∞—Ö. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `selectinload` –¥–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–µ–π.
*   **Detached Objects:** –ù–µ –ø—ã—Ç–∞–π—Ç–µ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ª–µ–Ω–∏–≤—ã–º –∞—Ç—Ä–∏–±—É—Ç–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `user.inventory`) –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ –∏–∑ –±–ª–æ–∫–∞ `async with`, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞—Ä–∞–Ω–µ–µ.

### ‚úÖ Eager Loading
```python
# –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
stmt = select(User).options(selectinload(User.inventory))
```
