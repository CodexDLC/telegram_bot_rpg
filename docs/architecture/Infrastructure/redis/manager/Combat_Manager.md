# ‚öîÔ∏è Combat Manager (Redis)

[‚¨ÖÔ∏è –ù–∞–∑–∞–¥: Managers](../managers.md)

---

## üéØ –û–ø–∏—Å–∞–Ω–∏–µ
**Location:** `apps/common/services/redis/manager/combat_manager.py`

**CombatManager** ‚Äî —ç—Ç–æ –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–π –¥—Ä–∞–π–≤–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –±–æ–µ–≤–æ–π —Å–µ—Å—Å–∏–∏ (RBC v3.0) –≤ Redis.
–û–Ω –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç—å –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, Lua-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

---

## üîë Key Schema (–°—Ö–µ–º–∞ –ö–ª—é—á–µ–π)
–í—Å–µ –∫–ª—é—á–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ `session_id`.

| –ö–ª—é—á | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `combat:rbc:{sid}:meta` | `HASH` | –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (status, step, teams). |
| `combat:rbc:{sid}:targets` | `JSON` | –û—á–µ—Ä–µ–¥–∏ —Ü–µ–ª–µ–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ (`{char_id: [target_id, ...]}`). |
| `combat:rbc:{sid}:actor:{cid}` | `JSON` | –ï–¥–∏–Ω—ã–π –æ–±—ä–µ–∫—Ç –∞–∫—Ç–æ—Ä–∞ (Meta, Raw, Loadout, XP). |
| `combat:rbc:{sid}:moves:{cid}` | `JSON` | –ù–∞–º–µ—Ä–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞ (`exchange`, `item`, `instant`). |
| `combat:rbc:{sid}:q:actions` | `LIST` | –°–∏—Å—Ç–µ–º–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á –¥–ª—è –í–æ—Ä–∫–µ—Ä–∞. |
| `combat:rbc:{sid}:log` | `LIST` | –õ–æ–≥ –±–æ—è. |
| `combat:rbc:{sid}:sys:busy` | `STRING` | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–µ—Å—Å–∏–∏ (Busy Lock) –¥–ª—è –≤–æ—Ä–∫–µ—Ä–∞. |

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ë–ª–æ–∫–∏

### 1. Global State & Targets
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏ –æ—á–µ—Ä–µ–¥—è–º–∏ —Ü–µ–ª–µ–π.
*   **`pop_player_target` (Atomic):** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `JSON.ARRPOP` —á–µ—Ä–µ–∑ Lua, —á—Ç–æ–±—ã –∞—Ç–æ–º–∞—Ä–Ω–æ –∑–∞–±—Ä–∞—Ç—å —Ü–µ–ª—å –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –∏–≥—Ä–æ–∫–∞.
*   **`peek_player_target`:** –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ª–µ–¥—É—é—â–µ–π —Ü–µ–ª–∏ –±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è (–¥–ª—è UI).

### 2. Batch Loading (–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
–ú–µ—Ç–æ–¥—ã –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ RTT (Round Trip Time) –∫ Redis.
*   **`load_full_context_data`:** –ó–∞–≥—Ä—É–∂–∞–µ—Ç **–≤—Å–µ** –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∑–∞ –æ–¥–∏–Ω Pipeline-–∑–∞–ø—Ä–æ—Å. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –í–æ—Ä–∫–µ—Ä–æ–º –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º.
*   **`load_snapshot_data_batch`:** –ó–∞–≥—Ä—É–∂–∞–µ—Ç **—á–∞—Å—Ç–∏—á–Ω—ã–µ** –¥–∞–Ω–Ω—ã–µ (—Ç–æ–ª—å–∫–æ Meta –∏ Loadout) –¥–ª—è UI. –≠–∫–æ–Ω–æ–º–∏—Ç —Ç—Ä–∞—Ñ–∏–∫.

### 3. Intent Management (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –•–æ–¥–æ–≤)
–°–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Lua-—Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏.
*   **`register_exchange_move_atomic`:**
    1.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Ü–µ–ª–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ `:targets`.
    2.  –£–¥–∞–ª—è–µ—Ç —Ü–µ–ª—å (POP).
    3.  –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ö–æ–¥ –≤ `:moves`.
    *   *–í—Å–µ —ç—Ç–æ ‚Äî –æ–¥–Ω–∞ –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è.*
*   **`register_moves_batch_atomic`:** –¢–æ –∂–µ —Å–∞–º–æ–µ, –Ω–æ –¥–ª—è –ø–∞—á–∫–∏ —Ö–æ–¥–æ–≤ (AI).

### 4. Locking System (Busy Lock)
–ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è Race Conditions –º–µ–∂–¥—É –≤–æ—Ä–∫–µ—Ä–∞–º–∏.
*   **`check_and_lock_busy_for_collector`:** –ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é (`SET NX`).
*   **`acquire_worker_lock`:** –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –ª–æ–∫ –Ω–∞ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤–æ—Ä–∫–µ—Ä–∞.

### 5. Universal Hot-Join
–ú–µ—Ö–∞–Ω–∏–∑–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –±–æ–π.
*   **Lua Script:**
    1.  –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–∫–∏ –∫–æ–º–∞–Ω–¥ –≤ `:meta`.
    2.  –í–Ω–µ–¥—Ä—è–µ—Ç –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –≤–æ –≤—Å–µ —Å–ø–∏—Å–∫–∏ —Ü–µ–ª–µ–π –≤—Ä–∞–≥–æ–≤ (`:targets`).
    3.  –î–æ–±–∞–≤–ª—è–µ—Ç –≤—Ä–∞–≥–æ–≤ –≤ —Å–ø–∏—Å–æ–∫ —Ü–µ–ª–µ–π –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞.

---

## üìù Lua Scripts Reference

### Target Pop & Move Register
```lua
-- –ê–ª–≥–æ—Ä–∏—Ç–º:
-- 1. –ù–∞–π—Ç–∏ –∏–Ω–¥–µ–∫—Å —Ü–µ–ª–∏ –≤ –º–∞—Å—Å–∏–≤–µ targets
-- 2. –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ -> —É–¥–∞–ª–∏—Ç—å (ARRPOP)
-- 3. –ó–∞–ø–∏—Å–∞—Ç—å –º—É–≤ –≤ —Å–ª–æ–≤–∞—Ä—å moves (JSON.SET)
```

### Hot Join Topology
```lua
-- –ê–ª–≥–æ—Ä–∏—Ç–º:
-- 1. –û–±–Ω–æ–≤–∏—Ç—å teams
-- 2. –ü—Ä–æ–π—Ç–∏—Å—å –ø–æ –≤—Å–µ–º targets
-- 3. –ï—Å–ª–∏ –≤—Ä–∞–≥ -> –¥–æ–±–∞–≤–∏—Ç—å ID –Ω–æ–≤–∏—á–∫–∞ –≤ —Å–ø–∏—Å–æ–∫
-- 4. –î–æ–±–∞–≤–∏—Ç—å ID –≤—Ä–∞–≥–∞ –≤ —Å–ø–∏—Å–æ–∫ –Ω–æ–≤–∏—á–∫–∞
```
