# Intent System Specification (RBC v3.1)

## 1. Назначение
Intent System — это шлюз между пользовательским вводом (Telegram Callback, Text Command) и игровой логикой.
Ее задача — абстрагировать "нажатие кнопки" в унифицированный объект намерения (`Intent`), который понимает боевая система.

## 2. Проблема
Клиент (Telegram Bot) может присылать данные в разных форматах.
Игровая логика не должна зависеть от того, пришло ли действие как `callback_data="atk_123"` или как текстовая команда `/attack`.

## 3. Структура Интента (Abstract Model)
Независимо от способа передачи, на выходе Intent System должен быть сформирован объект:

```python
class CombatIntent:
    source_id: str      # Кто совершает действие
    target_id: str      # На кого направлено (если применимо)
    action_type: str    # Тип действия (ATTACK, SKILL, ITEM, WAIT)
    
    # Payload - детали действия.
    # Может содержать ID финта, ID предмета или параметры атаки.
    payload: dict       
    
    timestamp: float    # Время создания (для валидации таймаутов)
```

## 4. Варианты Реализации (Implementation Options)
На этапе разработки Pipeline Builder будет выбран один из двух подходов:

### Option A: ID-Based (Stateful)
Сервер генерирует уникальные ID для каждой кнопки в меню игрока.
*   **Server:** Сохраняет маппинг `uuid_123 -> {action: "heavy_hit", cost: 2}`.
*   **Client:** Шлет `callback_data="uuid_123"`.
*   **Intent System:** Восстанавливает параметры действия по ID.
*   *Плюсы:* Безопасно, короткие пейлоады.
*   *Минусы:* Требует хранения состояния меню.

### Option B: Payload-Based (Stateless)
Вся информация зашита в кнопку.
*   **Client:** Шлет `callback_data="act:heavy_hit|tgt:mob_1"`.
*   **Intent System:** Парсит строку и собирает объект.
*   *Плюсы:* Не нужно хранить состояние меню.
*   *Минусы:* Ограничение на длину callback_data в Telegram (64 байта).

## 5. Валидация
Перед передачей в Pipeline Builder, интент проходит базовую валидацию:
1.  **Ownership:** Может ли этот юзер управлять этим `source_id`?
2.  **State:** Жив ли актер? Не находится ли он в стане (если действие не "пропуск хода")?

## 6. Интеграция
Intent System передает готовый объект `CombatIntent` в `TurnManager`, который затем скармливает его в `PipelineBuilder`.
