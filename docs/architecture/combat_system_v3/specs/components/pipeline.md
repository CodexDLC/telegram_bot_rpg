# Component: CombatPipeline

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](../README.md) | üè† [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../../../README.md)

**Concept:** –ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è (A –±—å–µ—Ç B).
**Implementation:** –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤ –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ `Executor`.

> –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–∏—Å—Ç–µ–º–µ —Ñ–ª–∞–≥–æ–≤ –∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ —á–∏—Ç–∞–π—Ç–µ –≤ [Trigger System Spec](./features/trigger_system.md).

---

## üìë –§–∞–∑—ã –ü–∞–π–ø–ª–∞–π–Ω–∞

### –§–∞–∑–∞ 0: Context Build (ContextBuilder)
*   **–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å "–ø—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è" (`PipelineContextDTO`).
*   **–î–µ–π—Å—Ç–≤–∏—è:**
    *   –°–æ–±—Ä–∞—Ç—å –±–∞–∑–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ –∏–∑ –ò–Ω—Ç–µ–Ω—Ç–∞.
    *   –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (Interference).

### –§–∞–∑–∞ 1: Pre-Calculation (AbilityService)
*   **–¶–µ–ª—å:** –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø–æ—á–≤—É.
*   **–î–µ–π—Å—Ç–≤–∏—è:**
    *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã.
    *   –í–ø—Ä—ã—Å–Ω—É—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç—ã –≤ `temp` (Instant Mods).
    *   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥–∏ (Force Crit, Ignore Block).

### –§–∞–∑–∞ 1.5: Stats Calculation (StatsEngine)
*   **–¶–µ–ª—å:** –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ü–∏—Ñ—Ä—ã.
*   **–î–µ–π—Å—Ç–≤–∏—è:**
    *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `dirty_stats` (–µ—Å–ª–∏ AbilityService —á—Ç–æ-—Ç–æ –ø–æ–º–µ–Ω—è–ª).
    *   –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å `ActorStats` –¥–ª—è –ê—Ç–∞–∫—É—é—â–µ–≥–æ –∏ –ó–∞—â–∏—Ç–Ω–∏–∫–∞.

### –§–∞–∑–∞ 1.6: Liveness Check
*   **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.
*   **–î–µ–π—Å—Ç–≤–∏—è:**
    *   –ï—Å–ª–∏ –ê—Ç–∞–∫—É—é—â–∏–π –º–µ—Ä—Ç–≤ -> –ü—Ä–µ—Ä–≤–∞—Ç—å (–∫—Ä–æ–º–µ –ø–æ—Å–º–µ—Ä—Ç–Ω—ã—Ö –∞–±–∏–ª–æ–∫).
    *   –ï—Å–ª–∏ –ó–∞—â–∏—Ç–Ω–∏–∫ –º–µ—Ä—Ç–≤ -> –ü—Ä–µ—Ä–≤–∞—Ç—å (–∫—Ä–æ–º–µ –Ω–µ–∫—Ä–æ–º–∞–Ω—Ç–∏–∏).

### –§–∞–∑–∞ 2: Combat Calculator (CombatResolver)
*   **–¶–µ–ª—å:** –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç.
*   **–î–µ–π—Å—Ç–≤–∏—è:**
    *   Accuracy -> Evasion -> Parry -> Block -> Damage.
*   **–†–µ–∑—É–ª—å—Ç–∞—Ç:** `InteractionResultDTO`.

### –§–∞–∑–∞ 3: Post-Calculation (AbilityService)
*   **–¶–µ–ª—å:** –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
*   **–î–µ–π—Å—Ç–≤–∏—è:**
    *   –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã (On Hit, On Crit).
    *   –ù–∞–ª–æ–∂–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç—ã (Bleed, Poison).

### –§–∞–∑–∞ 4: Mechanics (MechanicsService)
*   **–¶–µ–ª—å:** –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (Commit).
*   **–î–µ–π—Å—Ç–≤–∏—è:**
    *   `HP -= Damage`.
    *   `Tokens += 1`.
    *   `XP += Event`.
    *   –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—Ä—Ç–∏ (–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `is_dead`).
