# Component: CombatCollector

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](../README.md) | üè† [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../../../README.md)

**File:** `apps/game_core/modules/combat/combat_engine/processors/collector.py`
**Responsibility:** –õ–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏–π (Intents), –º–∞—Ç—á–º–µ–π–∫–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ –∑–∞–¥–∞—á.

## 1. –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª (`collect_actions`)

### A. –ó–∞–≥—Ä—É–∑–∫–∞ –°–Ω—ç–ø—à–æ—Ç–∞
–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ª–µ–≥–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ Redis:
*   `Meta` (–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –∫–æ–º–∞–Ω–¥—ã).
*   `Moves` (–≤—Å–µ –∑–∞—è–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è).
*   `Targets` (–æ—á–µ—Ä–µ–¥–∏ —Ü–µ–ª–µ–π).

### B. AI Check
–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤—Å–µ –ª–∏ –±–æ—Ç—ã —Å–¥–µ–ª–∞–ª–∏ —Ö–æ–¥—ã.
*   –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å —Ü–µ–ª–µ–π –±–æ—Ç–∞ (`targets`) —Å –∑–∞—è–≤–ª–µ–Ω–Ω—ã–º–∏ –∞—Ç–∞–∫–∞–º–∏ (`moves.exchange`).
*   –ï—Å–ª–∏ –µ—Å—Ç—å —Ü–µ–ª—å, –Ω–æ –Ω–µ—Ç –∞—Ç–∞–∫–∏ -> –°–æ–∑–¥–∞–µ—Ç `AiTurnRequestDTO`.

### C. Instant Harvesting
–°–æ–±–∏—Ä–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è —Ç–∏–ø–∞ `item` –∏ `instant`.
*   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `TargetResolver` –¥–ª—è –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è –∞–ª–∏–∞—Å–æ–≤ ("all_enemies") –≤ ID.
*   –°–æ–∑–¥–∞–µ—Ç `CombatActionDTO` (–æ–¥–∏–Ω –Ω–∞ –º—É–≤).

### D. Exchange Matchmaking
–ò—â–µ—Ç –ø–∞—Ä—ã –¥–ª—è –æ–±–º–µ–Ω–∞ —É–¥–∞—Ä–∞–º–∏.
1.  **Normal Match:** –ò—â–µ—Ç –≤–∑–∞–∏–º–Ω—ã–µ –∞—Ç–∞–∫–∏ (A->B –∏ B->A). –ï—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç -> –°–æ–∑–¥–∞–µ—Ç –ø–∞—Ä–Ω—ã–π `CombatActionDTO`.
2.  **Force Attack:** –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª `check_timeout`, –∏—â–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π –º—É–≤. –ï—Å–ª–∏ –ø–∞—Ä—ã –Ω–µ—Ç -> –°–æ–∑–¥–∞–µ—Ç –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π `CombatActionDTO` (is_forced=True).

### E. Batch Transfer
–ê—Ç–æ–º–∞—Ä–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã–µ `CombatActionDTO` –≤ –æ—á–µ—Ä–µ–¥—å `q:actions` –∏ —É–¥–∞–ª—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–µ –º—É–≤—ã –∏–∑ `moves`.

### F. Dynamic Batch Size
–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞ –¥–ª—è –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.
*   –ß–µ–º –±–æ–ª—å—à–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –±–æ—é, —Ç–µ–º –º–µ–Ω—å—à–µ –±–∞—Ç—á (—á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å –ø–∞–º—è—Ç—å –≤–æ—Ä–∫–µ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–æ–π –ø–æ–ª–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤).
