# Technical Spec: Universal Stats Engine (Waterfall Calculation)

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](../README.md) | üè† [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../../../README.md)

**–¢–∏–ø:** Core Logic / Math Engine
**–†–æ–ª—å:** –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ Text-Based Math Protocol.
**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –ë–æ–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞, –ú–µ–Ω—é –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤ –¥–∏–∞–ª–æ–≥–∞—Ö.

---

## 1. –ê–∫—Å–∏–æ–º–∞ –ë–∞–ª–∞–Ω—Å–∞ v3.0 (Philosophy)

–ú—ã —Ä–∞–∑–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–∏–ª—ã –Ω–∞ —Ç—Ä–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å —Ä–∞–∑–Ω–æ–π –º–∞—Ç–µ–º–∞—Ç–∏–∫–æ–π.

### A. –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –°–∏–ª–∞ (Internal Power) -> –ë–ê–ó–ê
–≠—Ç–æ —Ç–æ, –∫–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂ —è–≤–ª—è–µ—Ç—Å—è. –ï–≥–æ —Ç–µ–ª–æ, –æ–ø—ã—Ç, –∑–Ω–∞–Ω–∏—è.
*   **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** –ê—Ç—Ä–∏–±—É—Ç—ã, –°–∫–∏–ª–ª—ã, –î–∞—Ä—ã.
*   **–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:** –°–ª–æ–∂–µ–Ω–∏–µ (`+`).

### B. –í–Ω–µ—à–Ω–µ–µ –£—Å–∏–ª–µ–Ω–∏–µ (External Power) -> –ú–ù–û–ñ–ò–¢–ï–õ–ò
–≠—Ç–æ —Ç–æ, —á—Ç–æ –ø–µ—Ä—Å–æ–Ω–∞–∂ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç. –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞, –º–∞–≥–∏—è.
*   **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** –ü—Ä–µ–¥–º–µ—Ç—ã, –ë–∞—Ñ—Ñ—ã.
*   **–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:** –£–º–Ω–æ–∂–µ–Ω–∏–µ (`*`).

### C. –í—Ä–µ–º–µ–Ω–Ω—ã–µ –≠—Ñ—Ñ–µ–∫—Ç—ã (Temp Layer) -> –î–ò–ù–ê–ú–ò–ö–ê
–≠—Ç–æ —Ç–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.
*   **–ò—Å—Ç–æ—á–Ω–∏–∫–∏:** –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–±–∏–ª–∫–∏, –¥–µ–±–∞—Ñ—Ñ—ã, –∑–µ–ª—å—è.
*   **–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:** –õ—é–±–∞—è (`+`, `-`, `*`, `=`).
*   **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –•—Ä–∞–Ω–∏—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ–ª–µ `temp` –∏ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è—Ç—å –≤—Å—ë.

---

## 2. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: Text-Based Math Protocol
–ú—ã –æ—Ç–∫–∞–∑—ã–≤–∞–µ–º—Å—è –æ—Ç —Å–ª–æ–∂–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤ –∫–æ–¥–µ. –í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∫–∞–∫ **—Å—Ç—Ä–æ–∫–∏-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏**.

*   `"15"` -> –ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (Base).
*   `"+50"` -> –ê–¥–¥–∏—Ç–∏–≤–Ω—ã–π –±–æ–Ω—É—Å (Flat Add).
*   `"-10"` -> –®—Ç—Ä–∞—Ñ (Flat Sub).
*   `"*1.5"` -> –ú—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä (Multiplier).
*   `"*0.5"` -> –î–µ–ª–∏—Ç–µ–ª—å (Multiplier < 1.0).
*   `"=100"` -> –ñ–µ—Å—Ç–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (Override).

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** Zero-Transformation Pipeline. –ï—Å–ª–∏ –≤ –ë–î —Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä–æ–∫–∏ `"+50"`, —Ç–æ –ê—Å—Å–µ–º–±–ª–µ—Ä –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞–µ—Ç JSON –∏–∑ –ë–î –≤ Redis –±–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥–∞.

---

## 3. –ê–ª–≥–æ—Ä–∏—Ç–º: Waterfall Calculation (–í–æ–¥–æ–ø–∞–¥)

–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞—Å—á–µ—Ç–∞ –∏–¥–µ—Ç –≤ —Ç—Ä–∏ —Ñ–∞–∑—ã, –≥–¥–µ –¥–∞–Ω–Ω—ã–µ "—Ç–µ–∫—É—Ç" —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑.

**–û–±—â–∞—è —Ñ–æ—Ä–º—É–ª–∞:** `Final = (Sum(Base) + Sum(Flat)) * Product(Multipliers)`
*(–ï—Å–ª–∏ –µ—Å—Ç—å Override `=`, —Ç–æ `Final = Override`)*

### –õ–æ–≥–∏–∫–∞ Override (=)
–ï—Å–ª–∏ –≤ —Å–ª–æ–≤–∞—Ä–µ `temp` (–∏–ª–∏ `sources`) –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ, –Ω–∞—á–∏–Ω–∞—é—â–µ–µ—Å—è —Å `=`, –≤—Å—è –æ—Å—Ç–∞–ª—å–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è, –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ.
*   *–ü—Ä–∏–º–µ—Ä:* `Base: 10`, `Source: +5`, `Temp: =1`. –†–µ–∑—É–ª—å—Ç–∞—Ç: `1`. (–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–µ–±–∞—Ñ—Ñ–æ–≤ —Ç–∏–ø–∞ "–û–±–µ–∑–¥–≤–∏–∂–∏–≤–∞–Ω–∏–µ").

### –§–∞–∑–∞ 1: –†–∞—Å—á–µ—Ç –ê—Ç—Ä–∏–±—É—Ç–æ–≤ (Primary Stats)
–ë–µ—Ä–µ–º –±–ª–æ–∫ `attributes` –∏–∑ `v:raw`.
*   **–í—Ö–æ–¥:**
    *   Base: `10`
    *   Sources: `{"race": "+2"}`
    *   Temp: `{"buff": "+5"}`
*   **–†–∞—Å—á–µ—Ç:** `10 + 2 + 5 = 17`
*   **–í—ã—Ö–æ–¥:** `final_strength = 17`

### –§–∞–∑–∞ 2: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è (Derivation Bridge)
–ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –ê—Ç—Ä–∏–±—É—Ç—ã –≤ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã, –∏—Å–ø–æ–ª—å–∑—É—è –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ (`DERIVATION_RULES`).

*   **–ü—Ä–∞–≤–∏–ª–æ:** `1 Strength = +1.5 Physical Damage`
*   **–î–µ–π—Å—Ç–≤–∏–µ:**
    1.  –ë–µ—Ä–µ–º `final_strength` (17).
    2.  –°—á–∏—Ç–∞–µ–º –±–æ–Ω—É—Å: `17 * 1.5 = 25.5`.
    3.  –°–æ–∑–¥–∞–µ–º **–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ò—Å—Ç–æ—á–Ω–∏–∫**: `"+25.5"`.
    4.  –í–ø—Ä—ã—Å–∫–∏–≤–∞–µ–º –µ–≥–æ –≤ `modifiers.physical_damage_min`.

### –§–∞–∑–∞ 3: –†–∞—Å—á–µ—Ç –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (Secondary Stats)
–ë–µ—Ä–µ–º –±–ª–æ–∫ `modifiers` (—Å —É–∂–µ –≤–ø—Ä—ã—Å–Ω—É—Ç—ã–º–∏ –±–æ–Ω—É—Å–∞–º–∏ –æ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤).
*   **–í—Ö–æ–¥:**
    *   `derived:strength`: `"+25.5"` (–∏–∑ –§–∞–∑—ã 2) -> –≠—Ç–æ –ë–ê–ó–ê.
    *   `skill:sword_mastery`: `"+10"` -> –≠—Ç–æ –ë–ê–ó–ê.
    *   `item:sword`: `"*1.1"` (–í–Ω–µ—à–Ω–µ–µ —É—Å–∏–ª–µ–Ω–∏–µ).
    *   `buff:rage`: `"*1.2"` (–í–Ω–µ—à–Ω–µ–µ —É—Å–∏–ª–µ–Ω–∏–µ, Temp).
*   **–†–∞—Å—á–µ—Ç:** `(25.5 + 10) * 1.1 * 1.2 = 46.86`
*   **–í—ã—Ö–æ–¥:** `final_damage = 46.86`

---

## 4. Optimization: Dirty Flags (–°–∏–≥–Ω–∞–ª—å–Ω—ã–π –ö—ç—à)

–ß—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –≤—Å–µ 50+ —Å—Ç–∞—Ç–æ–≤ –∫–∞–∂–¥—ã–π —Ç–∏–∫, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ö–∞–Ω–∏–∑–º `dirty_stats`.

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
1.  **Check:** –í –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è –í–æ—Ä–∫–µ—Ä –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `actor.dirty_stats`.
2.  **Full Calc:** –ï—Å–ª–∏ `actor.stats` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫) -> –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç –≤—Å–µ—Ö –ø–æ–ª–µ–π.
3.  **Partial Calc:** –ï—Å–ª–∏ `actor.stats` –µ—Å—Ç—å, –Ω–æ `dirty_stats` –Ω–µ –ø—É—Å—Ç -> –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º **—Ç–æ–ª—å–∫–æ** —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø–æ–ª—è (–∏ –∑–∞–≤–∏—Å–∏–º—ã–µ –æ—Ç –Ω–∏—Ö).
4.  **Skip:** –ï—Å–ª–∏ `dirty_stats` –ø—É—Å—Ç -> –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `actor.stats`.
5.  **Clear:** –ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –æ—á–∏—â–∞–µ–º `dirty_stats`.

### –ö—Ç–æ —Å—Ç–∞–≤–∏—Ç —Ñ–ª–∞–≥–∏?
*   `AbilityService`: –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `raw.temp` –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–ª—é—á–∏ –≤ `dirty_stats`.
*   `ItemService`: –ü—Ä–∏ —Å–º–µ–Ω–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏ (–µ—Å–ª–∏ —Ç–∞–∫–æ–µ –≤–æ–∑–º–æ–∂–Ω–æ –≤ –±–æ—é) –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–ª—é—á–∏.
