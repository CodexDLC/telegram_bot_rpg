# Component: CombatLifecycleService

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](../README.md) | üè† [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../../../README.md)

**File:** `apps/game_core/modules/combat/session/initialization/combat_lifecycle_service.py`
**Layer:** API Layer (Initialization).
**Responsibility:** –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Å–µ—Å—Å–∏–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ, –æ—á–∏—Å—Ç–∫–∞).

## 1. –°–æ–∑–¥–∞–Ω–∏–µ –ë–æ—è (`create_battle`)

### –®–∞–≥ 1: Load Templates
–ó–∞–≥—Ä—É–∂–∞–µ—Ç —à–∞–±–ª–æ–Ω—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–∏–≥—Ä–æ–∫–æ–≤ –∏ –º–æ–Ω—Å—Ç—Ä–æ–≤) –∏–∑ `ContextManager`.
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç MGET –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—Å–µ—Ö).

### –®–∞–≥ 2: Assembly (–°–±–æ—Ä–∫–∞)
–ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —à–∞–±–ª–æ–Ω—ã –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö RBC v3.0.
*   **ID Generation:**
    *   –ò–≥—Ä–æ–∫–∏: –ò—Å–ø–æ–ª—å–∑—É—é—Ç —Å–≤–æ–π `char_id`.
    *   –ú–æ–Ω—Å—Ç—Ä—ã: –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ ID (`orc_1`, `orc_2`).
    *   Shadow: –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ ID (`-101`).
*   **Data Mapping:**
    *   `math_model` -> `:raw` (–ê—Ç—Ä–∏–±—É—Ç—ã, –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã).
    *   `loadout` -> `:loadout` (–°–∫–∏–ª–ª—ã, –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞).
    *   `vitals` -> `:state` (HP, EN).
*   **Target Graph:**
    *   –°–æ–∑–¥–∞–µ—Ç —Å–ø–∏—Å–∫–∏ –≤—Ä–∞–≥–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞.
    *   –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ—Ç –∏—Ö (`random.shuffle`), —á—Ç–æ–±—ã —Å–ª–æ–º–∞—Ç—å —Ñ–æ–∫—É—Å.

### –®–∞–≥ 3: Persist (–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç `CombatManager.create_session_batch` –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤—Å–µ–≥–æ –ø–∞–∫–µ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Redis –∑–∞ –æ–¥–Ω—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.

### –®–∞–≥ 4: Chaos Start
–°—Ç–∞–≤–∏—Ç –∑–∞–¥–∞—á—É `chaos_check_task` –≤ ARQ (–æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç), —á—Ç–æ–±—ã –±–æ–π –Ω–µ –≤–∏—Å–µ–ª –≤–µ—á–Ω–æ, –µ—Å–ª–∏ –≤—Å–µ —É–π–¥—É—Ç –≤ AFK.

## 2. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ë–æ—è (`complete_session`)

### –®–∞–≥ 1: Cleanup
–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –∫–ª—é—á–∏ —Å–µ—Å—Å–∏–∏ –∏–∑ Redis (`cleanup_rbc_session`).

### –®–∞–≥ 2: Unlink
–û—Ç–≤—è–∑—ã–≤–∞–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ –æ—Ç —Å–µ—Å—Å–∏–∏ (—á–µ—Ä–µ–∑ `AccountManager`), —á—Ç–æ–±—ã –æ–Ω–∏ –º–æ–≥–ª–∏ –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –±–æ–π.
