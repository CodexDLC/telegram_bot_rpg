# Component: ContextBuilder

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](../README.md) | üè† [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../../../README.md)

**File:** `apps/game_core/modules/combat/combat_engine/logic/context_builder.py`
**Responsibility:** –§–∞–±—Ä–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–∑–¥–∞–µ—Ç `PipelineContextDTO` ‚Äî "–ø—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è" –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É–¥–∞—Ä–∞.

## 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—á–µ—Ç —É–¥–∞—Ä–∞, –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞, —Ñ–ª–∞–≥–∏ –∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤ –æ–¥–∏–Ω –æ–±—ä–µ–∫—Ç.
`ContextBuilder` –±–µ—Ä–µ—Ç "—Å—ã—Ä—ã–µ" –¥–∞–Ω–Ω—ã–µ (–∫—Ç–æ –±—å–µ—Ç, –∫–æ–≥–æ –±—å–µ—Ç, —á–µ–º –±—å–µ—Ç) –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∏—Ö –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç.

---

## 2. –í—Ö–æ–¥–Ω—ã–µ –î–∞–Ω–Ω—ã–µ
```python
def build_context(actor, intent, external_mods: dict = None) -> PipelineContextDTO:
```
*   `actor`: –ê—Ç–∞–∫—É—é—â–∏–π.
*   `intent`: –ù–∞–º–µ—Ä–µ–Ω–∏–µ (–∫–∞–∫–æ–π —Å–∫–∏–ª–ª/—Ñ–∏–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è).
*   `external_mods`: –í–Ω–µ—à–Ω–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç InterferenceService ‚Äî –µ—Å–ª–∏ –∞—Ç–∞–∫—É –ø—Ä–µ—Ä–≤–∞–ª–∏ –∏–ª–∏ –æ—Å–ª–∞–±–∏–ª–∏ –¥–æ –Ω–∞—á–∞–ª–∞).

---

## 3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ PipelineContextDTO

```python
class PipelineContextDTO:
    # A. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –§–∞–∑–∞–º–∏ (Phase Control)
    # –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ —á–∞—Å—Ç–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞ –±—É–¥—É—Ç –∑–∞–ø—É—â–µ–Ω—ã.
    phases: dict = {
        "run_pre_calc": True,   # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π (AbilityService)
        "run_calculator": True, # –†–∞—Å—á–µ—Ç —É—Ä–æ–Ω–∞/–∑–∞—â–∏—Ç—ã (CombatResolver)
        "run_post_calc": True   # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (AbilityService)
    }

    # B. –§–ª–∞–≥–∏ (Flags)
    # –£–ø—Ä–∞–≤–ª—è—é—Ç –ª–æ–≥–∏–∫–æ–π –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞.
    flags: dict = {
        "force": {"crit": False, "hit": False},
        "restriction": {"cannot_crit": False},
        "damage": {"physical": True, "fire": False}
    }

    # C. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (Mods)
    # –ß–∏—Å–ª–æ–≤—ã–µ –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞.
    mods: dict = {"damage_mult": 1.0, "accuracy_mult": 1.0}

    # D. –¢—Ä–∏–≥–≥–µ—Ä—ã (Triggers)
    # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Post-Calc.
    triggers: dict = {}
```

---

## 4. –õ–æ–≥–∏–∫–∞ –°–±–æ—Ä–∫–∏ (Assembly Flow)

### –®–∞–≥ 1: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ External Modifiers
–≠—Ç–æ —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç. –ï—Å–ª–∏ `Executor` —Ä–µ—à–∏–ª, —á—Ç–æ –∞—Ç–∞–∫–∞ —Å–æ—Ä–≤–∞–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑-–∑–∞ –æ–≥–ª—É—à–µ–Ω–∏—è), –æ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç —ç—Ç–æ –≤ `external_mods`.

*   –ï—Å–ª–∏ `external_mods` —Å–æ–¥–µ—Ä–∂–∏—Ç `disable_attack=True`:
    *   `phases["run_calculator"] = False` (–£—Ä–æ–Ω –Ω–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è).
    *   `phases["run_post_calc"] = True` (–û—Å—Ç–∞–≤–ª—è–µ–º, —á—Ç–æ–±—ã —Å–Ω—è—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–µ–±–∞—Ñ—Ñ—ã).

### –®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ –ò–Ω—Ç–µ–Ω—Ç–∞
*   –ï—Å–ª–∏ —ç—Ç–æ **–ú–∞–≥–∏—è**: –í–∫–ª—é—á–∞–µ—Ç —Ñ–ª–∞–≥–∏ –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ —É—Ä–æ–Ω–∞.
*   –ï—Å–ª–∏ —ç—Ç–æ **–§–∏–Ω—Ç**: –í–∫–ª—é—á–∞–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Ñ–ª–∞–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ignore_block`).

### –®–∞–≥ 3: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –§–ª–∞–≥–æ–≤
–ó–∞–ø–æ–ª–Ω—è–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–ª–∞–≥–æ–≤ –∏ —Ñ–∞–∑.
