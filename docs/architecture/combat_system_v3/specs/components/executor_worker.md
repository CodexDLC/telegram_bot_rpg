# Component: ExecutorTask

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](../README.md) | üè† [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../../../README.md)

**File:** `apps/game_core/modules/combat/combat_engine/workers/tasks/executor_task.py`
**Responsibility:** –í—Ö–æ–¥–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è ARQ Worker. –£–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–∫–µ—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π.

## 1. –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

### –®–∞–≥ 1: Load Context (Heavy)
–ó–∞–≥—Ä—É–∂–∞–µ—Ç **–ø–æ–ª–Ω—ã–π** –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—è (`BattleContext`) —á–µ—Ä–µ–∑ `CombatDataService`.
–≠—Ç–æ –¥–æ—Ä–æ–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è, –ø–æ—ç—Ç–æ–º—É –º—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è –ø–∞—á–∫–∞–º–∏ (Batch).

### –®–∞–≥ 2: Lock Acquisition
–ü—ã—Ç–∞–µ—Ç—Å—è –∑–∞—Ö–≤–∞—Ç–∏—Ç—å –ª–æ–∫ `sys:busy` –Ω–∞ —Å–≤–æ–µ –∏–º—è.
*   –ï—Å–ª–∏ –ª–æ–∫ –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –≤–æ—Ä–∫–µ—Ä–æ–º -> –í—ã—Ö–æ–¥ (–∑–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–∫–∏).
*   –ï—Å–ª–∏ –ª–æ–∫ —Å–≤–æ–±–æ–¥–µ–Ω (–∏–ª–∏ `pending`) -> –ó–∞—Ö–≤–∞—Ç.

### –®–∞–≥ 3: Fetch Actions
–ó–∞–±–∏—Ä–∞–µ—Ç –ø–∞—á–∫—É –¥–µ–π—Å—Ç–≤–∏–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏ `q:actions`.
*   –†–∞–∑–º–µ—Ä –ø–∞—á–∫–∏ –∑–∞–¥–∞–µ—Ç—Å—è –ö–æ–ª–ª–µ–∫—Ç–æ—Ä–æ–º (`job.batch_size`).

### –®–∞–≥ 4: Process Batch (Pure Logic)
–ü–µ—Ä–µ–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –¥–µ–π—Å—Ç–≤–∏—è –≤ `CombatExecutor`.
–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç in-place.

### –®–∞–≥ 5: Commit (Zombie Check)
–ü–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ª–æ–∫ –≤—Å–µ –µ—â–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –Ω–∞–º.
*   –ï—Å–ª–∏ –ª–æ–∫ –ø–æ—Ç–µ—Ä—è–Ω (—Ç–∞–π–º–∞—É—Ç) -> –í—ã—Ö–æ–¥ (Zombie detected).
*   –ï—Å–ª–∏ –ª–æ–∫ –Ω–∞—à -> –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Redis (`commit_session`).

### –®–∞–≥ 6: Release & Signal
*   –°–Ω–∏–º–∞–µ—Ç –ª–æ–∫.
*   –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–∏–≥–Ω–∞–ª `heartbeat` –ö–æ–ª–ª–µ–∫—Ç–æ—Ä—É (—á—Ç–æ–±—ã —Ç–æ—Ç –ø—Ä–æ–≤–µ—Ä–∏–ª –æ—á–µ—Ä–µ–¥—å –∏ –∑–∞–ø—É—Å—Ç–∏–ª –Ω–∞—Å —Å–Ω–æ–≤–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ).
