# Component: CollectorTask

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](../README.md) | üè† [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../../../README.md)

**File:** `apps/game_core/modules/combat/combat_engine/workers/tasks/collector_task.py`
**Responsibility:** –í—Ö–æ–¥–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è ARQ Worker. –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Å–±–æ—Ä–∞ –∏ –∑–∞–ø—É—Å–∫–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π.

## 1. –¢—Ä–∏–≥–≥–µ—Ä
–ó–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ —Å–∏–≥–Ω–∞–ª—É `CollectorSignalDTO` –∏–∑ –æ—á–µ—Ä–µ–¥–∏ `arq:combat_collector`.
–°–∏–≥–Ω–∞–ª—ã –ø—Ä–∏—Ö–æ–¥—è—Ç –æ—Ç:
*   `TurnManager` (–ò–≥—Ä–æ–∫ —Å–¥–µ–ª–∞–ª —Ö–æ–¥ -> `check_immediate`).
*   `TurnManager` (–¢–∞–π–º–µ—Ä –∏—Å—Ç–µ–∫ -> `check_timeout`).
*   `Executor` (–ó–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É -> `heartbeat`).

## 2. –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

### –®–∞–≥ 1: –°–±–æ—Ä –∏ –ú–∞—Ç—á–º–µ–π–∫–∏–Ω–≥
–í—ã–∑—ã–≤–∞–µ—Ç `CombatCollector.collect_actions(session_id, signal)`.
–ü–æ–ª—É—á–∞–µ—Ç:
*   `batch_size`: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –¥–ª—è –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.
*   `ai_tasks`: –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –¥–ª—è AI (–±–æ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ç—É–ø—è—Ç).

### –®–∞–≥ 2: Dispatch AI
–ï—Å–ª–∏ –µ—Å—Ç—å `ai_tasks`, —Å—Ç–∞–≤–∏—Ç –∏—Ö –≤ –æ—á–µ—Ä–µ–¥—å `ai_turn_task`.
–≠—Ç–æ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –±–æ—Ç–æ–≤ –ø—Ä–æ—Å–Ω—É—Ç—å—Å—è –∏ —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥.

### –®–∞–≥ 3: Dispatch Executor
–ï—Å–ª–∏ `batch_size > 0`:
1.  **Check Lock:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (`sys:busy`).
2.  **Enqueue:** –ï—Å–ª–∏ —Å–≤–æ–±–æ–¥–µ–Ω, —Å—Ç–∞–≤–∏—Ç –∑–∞–¥–∞—á—É `execute_batch_task` –≤ –æ—á–µ—Ä–µ–¥—å `arq:combat_executor`.
3.  **Skip:** –ï—Å–ª–∏ –∑–∞–Ω—è—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç (–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å —Å–∞–º –ø—Ä–∏—à–ª–µ—Ç `heartbeat` –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –∏ –º—ã —Å–Ω–æ–≤–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –æ—á–µ—Ä–µ–¥—å).
