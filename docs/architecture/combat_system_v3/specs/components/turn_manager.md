# Component: TurnManager

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](../README.md) | üè† [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../../../README.md)

**File:** `apps/game_core/modules/combat/session/runtime/combat_turn_manager.py`
**Responsibility:** –ü—Ä–∏–µ–º –∑–∞—è–≤–æ–∫ –æ—Ç –∏–≥—Ä–æ–∫–æ–≤/AI, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∑–∞–ø–∏—Å—å –≤ Redis –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞–º–∏ ARQ.

## 1. Core Philosophy: Double Signaling

–î–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç–∏ (Reactivity) –∏ –∑–∞—â–∏—Ç—ã –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏–π (Safety), –∫–∞–∂–¥—ã–π —Ö–æ–¥ –∏–≥—Ä–æ–∫–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç **–¥–≤–∞** —Å–∏–≥–Ω–∞–ª–∞ –≤ ARQ.

### Signal A: The "Immediate" (Check Now)
*   **Purpose:** –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è.
*   **Action:** `enqueue_job('combat_collector_task', signal_type="check_immediate")`.
*   **Logic:** –ö–æ–ª–ª–µ–∫—Ç–æ—Ä –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É. –ï—Å–ª–∏ –≤—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ —É–∂–µ –ø–æ—Ö–æ–¥–∏–ª, –±–æ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (–∑–∞–¥–µ—Ä–∂–∫–∞ < 0.1s).

### Signal B: The "Timeout" (Force Attack)
*   **Purpose:** –ì–∞—Ä–∞–Ω—Ç–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ö–æ–¥–∞.
*   **Action:** `enqueue_job(..., signal_type="check_timeout", _defer_until=NOW + 60s)`.
*   **Logic:** –ï—Å–ª–∏ –≤—Ç–æ—Ä–æ–π –∏–≥—Ä–æ–∫ —Ç–∞–∫ –∏ –Ω–µ –ø–æ—Ö–æ–¥–∏–ª (AFK), —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥ –ö–æ–ª–ª–µ–∫—Ç–æ—Ä –ø—Ä–æ—Å–Ω–µ—Ç—Å—è –ø–æ —ç—Ç–æ–º—É —Å–∏–≥–Ω–∞–ª—É. –û–Ω —É–≤–∏–¥–∏—Ç, —á—Ç–æ –ø–∞—Ä—ã –Ω–µ—Ç, –∏ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç –∑–∞—è–≤–∫—É –≤ **Force Action** (–æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–π —É–¥–∞—Ä).

---

## 2. Workflow

### A. Player Move (`register_move_request`)
1.  **Validation:** –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Payload.
2.  **Atomic Reserve:**
    *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `register_exchange_move_atomic` (Lua).
    *   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Ü–µ–ª—å –≤ –æ—á–µ—Ä–µ–¥–∏ `targets`.
    *   –ï—Å–ª–∏ –µ—Å—Ç—å -> –£–¥–∞–ª—è–µ—Ç —Ü–µ–ª—å (POP) –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –º—É–≤.
    *   –ï—Å–ª–∏ –Ω–µ—Ç -> –û—à–∏–±–∫–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞).
3.  **Signaling:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç Immediate –∏ Timeout —Å–∏–≥–Ω–∞–ª—ã.

### B. AI Batch Move (`register_moves_batch`)
1.  **Collection:** –°–æ–±–∏—Ä–∞–µ—Ç N –Ω–∞–º–µ—Ä–µ–Ω–∏–π –æ—Ç AI Worker.
2.  **Atomic Batch:**
    *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `register_moves_batch_atomic` (Lua).
    *   –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º—É–≤–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —É–¥–∞–ª—è–µ—Ç —Ü–µ–ª—å.
3.  **Signaling:**
    *   –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **–æ–¥–∏–Ω** Immediate —Å–∏–≥–Ω–∞–ª (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è).
    *   –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç **–æ–¥–∏–Ω** Timeout —Å–∏–≥–Ω–∞–ª –Ω–∞ –≤–µ—Å—å –±–∞—Ç—á.

---

## 3. Key Features

*   **Spam Protection:** –ò–≥—Ä–æ–∫ –Ω–µ –º–æ–∂–µ—Ç –∑–∞—è–≤–∏—Ç—å –¥–≤–∞ —É–¥–∞—Ä–∞ –ø–æ –æ–¥–Ω–æ–π —Ü–µ–ª–∏ (–±–ª–∞–≥–æ–¥–∞—Ä—è –∞—Ç–æ–º–∞—Ä–Ω–æ–º—É POP).
*   **Latency Hiding:** –ò–≥—Ä–æ–∫ –Ω–µ –∂–¥–µ—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞. –û–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º—É–≤ –∏ –ø–æ–ª—É—á–∞–µ—Ç "OK". –í—Å—è –º–∞–≥–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ.
*   **AFK Handling:** –¢–∞–π–º–µ—Ä Force Attack –∑–∞–≤–æ–¥–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –º–æ–º–µ–Ω—Ç –∑–∞—è–≤–∫–∏.
