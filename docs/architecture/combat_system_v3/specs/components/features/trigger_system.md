# Feature: Trigger & Flag System

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](../../README.md) | üè† [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../../../../README.md)

## 1. Overview
–°–∏—Å—Ç–µ–º–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∏ —Ñ–ª–∞–≥–æ–≤ ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞–π–ø–ª–∞–π–Ω–æ–º –±–æ—è. –û–Ω–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –º–µ–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Ä–∞—Å—á–µ—Ç–∞ (—Ñ–æ—Ä–º—É–ª—ã, –ø—Ä–æ–≤–µ—Ä–∫–∏) –∏ –Ω–∞–∫–ª–∞–¥—ã–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç—ã, –Ω–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—è –∫–æ–¥ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞.

–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è: **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏**.
*   **Pipeline Builder** —Å–æ–±–∏—Ä–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –∏–∑ –∏–Ω—Ç–µ–Ω—Ç–∞ –∏ –ø–∞—Å—Å–∏–≤–æ–∫.
*   **Ability Service** –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç "—Å–ª–æ–∂–Ω—ã–µ" —Ç—Ä–∏–≥–≥–µ—Ä—ã (—ç—Ñ—Ñ–µ–∫—Ç—ã, —Å—Ç–∞—Ç—É—Å—ã) –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç —Ñ–ª–∞–≥–∏.
*   **Combat Calculator** –∏—Å–ø–æ–ª–Ω—è–µ—Ç –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤.

## 1.5. Philosophy: Universal Trigger Mechanism

### –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è
–¢—Ä–∏–≥–≥–µ—Ä—ã ‚Äî —ç—Ç–æ **–£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø** —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤:
- –û—Ä—É–∂–∏–µ (weapon triggers)
- –§–∏–Ω—Ç—ã (feint triggers)
- –°–∫–∏–ª–ª—ã (ability triggers)
- –°—Ç–æ–π–∫–∏ (stance triggers)

**–í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –û–î–ù–£ –±–∏–±–ª–∏–æ—Ç–µ–∫—É** `TRIGGER_RULES` –∏ **–û–î–ù–£ –ª–æ–≥–∏–∫—É** –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ `CombatResolver._resolve_triggers()`.

### –†–∞–∑–Ω–∏—Ü–∞ —Ç–æ–ª—å–∫–æ –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏

| –ò—Å—Ç–æ—á–Ω–∏–∫ | –ì–¥–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è | –ö–æ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è |
|----------|------------------|-------------------|
| **Weapon** | `ContextBuilder` (–∏–∑ `weapon.triggers`) | `ON_CRIT` / `ON_HIT` |
| **Ability** | `AbilityService.pre_process()` (–∏–∑ `skill.triggers`) | –õ—é–±–æ–µ —Å–æ–±—ã—Ç–∏–µ |
| **Feint** | `AbilityService.pre_process()` (–∏–∑ `feint.triggers`) | –õ—é–±–æ–µ —Å–æ–±—ã—Ç–∏–µ |

### Data Flow
```mermaid
graph TD
    TR[TRIGGER_RULES Library] -->|Definitions| CB
    TR -->|Definitions| AS

    subgraph Sources
        W[Weapon.triggers]
        S[Skill.triggers]
        F[Feint.triggers]
    end

    W --> CB[Context Builder]
    S --> AS[Ability Service]
    F --> AS

    CB -->|ctx.triggers.*| CR[Combat Resolver]
    AS -->|ctx.triggers.*| CR

    CR -->|Logic Execution| RES[Result]
```

### –ü—Ä–∏–º–µ—Ä: –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

**–ú–µ—á (weapon):**
```python
BaseItemDTO(
    id="longsword",
    triggers=["trigger_bleed"]  # –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è Context Builder
)
```

**–§–∏–Ω—Ç (ability):**
```python
{
    "feint_id": "bleeding_strike",
    "triggers": ["trigger_bleed"]  # –ê–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è Ability Service
}
```

**–†–µ–∑–æ–ª–≤–µ—Ä:**
```python
# –û–±–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –û–î–ò–ù–ê–ö–û–í–û
if ctx.triggers.trigger_bleed:
    res.ability_flags.apply_bleed = True
```

---

## 2. –¢–∏–ø—ã –§–ª–∞–≥–æ–≤ (Flag Taxonomy)

–§–ª–∞–≥–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ —Å–ª–æ–≤–∞—Ä–µ `context.flags`.

### A. Control Flags (–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–º)
–í–∫–ª—é—á–∞—é—Ç –∏–ª–∏ –≤—ã–∫–ª—é—á–∞—é—Ç —Ü–µ–ª—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞ –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ.
*   `check_evasion` (bool): –ï—Å–ª–∏ False, —Ñ–∞–∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–≤–æ—Ä–æ—Ç–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è (–∞–≤—Ç–æ-–ø–æ–ø–∞–¥–∞–Ω–∏–µ).
*   `check_crit` (bool): –ï—Å–ª–∏ False, –∫—Ä–∏—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.
*   `check_block` (bool): –ï—Å–ª–∏ False, —â–∏—Ç –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è.

### B. Force Flags (–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
–ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞ –≤–∫–ª—é—á–µ–Ω–∞.
*   `force_hit` (bool): –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–æ—Å–∫–∞ –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç—å (–≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–ª).
*   `force_crit` (bool): –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å —à–∞–Ω—Å –∫—Ä–∏—Ç–∞ (–≤—Å–µ–≥–¥–∞ –∫—Ä–∏—Ç).
*   `force_miss` (bool): –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –æ—Å–ª–µ–ø–ª–µ–Ω–∏–∏).

### C. Trigger Flags (–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ª–æ–≥–∏–∫–∏)
–°–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è. –¢—Ä–∏–≥–≥–µ—Ä—ã –º–æ–≥—É—Ç –±—ã—Ç—å:
1.  **Formula Triggers:** –ú–µ–Ω—è—é—Ç –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Ñ–æ—Ä–º—É–ª—É.
    *   –ü—Ä–∏–º–µ—Ä: `trigger_crit_power` -> –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É–ª—É `CritDmg * 2.5` –≤–º–µ—Å—Ç–æ `* 1.5`.
2.  **Effect Triggers:** –°–∏–≥–Ω–∞–ª –¥–ª—è Ability Service –Ω–∞–ª–æ–∂–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç.
    *   –ü—Ä–∏–º–µ—Ä: `TRIGGER_BLEED_ON_HIT`.

---

## 3. Pipeline Flow (–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)

### Phase 1: Pipeline Builder (Context Assembly)
–í –Ω–∞—á–∞–ª–µ —Ä–∞–∑–º–µ–Ω–∞ (Exchange) —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç.
*   **Input:** Intent (–§–∏–Ω—Ç "Head Attack"), Actor Stats (Passive "Sword Mastery").
*   **Process:**
    *   –§–∏–Ω—Ç –∏–º–µ–µ—Ç –∫–æ–Ω—Ñ–∏–≥: `{"flags": {"force_crit": True, "trigger": "BLEED_ON_HIT"}}`.
    *   –ü–∞—Å—Å–∏–≤–∫–∞ –∏–º–µ–µ—Ç –∫–æ–Ω—Ñ–∏–≥: `{"flags": {"check_evasion": False}}` (–ù–µ–ª—å–∑—è —É–≤–µ—Ä–Ω—É—Ç—å—Å—è).
*   **Output:** `initial_flags = {"force_crit": True, "trigger": "BLEED_ON_HIT", "check_evasion": False}`.

### Phase 2: Ability Service (Pre-Calculation)
–°–µ—Ä–≤–∏—Å —Å–∫–∞–Ω–∏—Ä—É–µ—Ç `initial_flags` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –µ–º—É —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤.
*   **Input:** `initial_flags`.
*   **Logic:**
    *   –í–∏–¥–∏—Ç `BLEED_ON_HIT`.
    *   –ü–æ–Ω–∏–º–∞–µ—Ç: "–≠—Ç–æ –º–æ—è —Ä–∞–±–æ—Ç–∞. –ù–æ –Ω–∞–ª–æ–∂–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç –Ω—É–∂–Ω–æ *—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏* –±—É–¥–µ—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–µ".
    *   –î–µ–π—Å—Ç–≤–∏–µ: –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –∫–æ–ª–ª–±–µ–∫ (Post-Calc Hook).
    *   *Note:* –°–∞–º —Ñ–ª–∞–≥ `BLEED_ON_HIT` –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ –º—É—Å–æ—Ä–∏—Ç—å, –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å (–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –µ–≥–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç).

### Phase 3: Combat Calculator (Execution)
–°—á–∏—Ç–∞–µ—Ç —Ü–∏—Ñ—Ä—ã.
*   –í–∏–¥–∏—Ç `check_evasion: False` -> –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç `roll_evasion()`.
*   –í–∏–¥–∏—Ç `force_crit: True` -> –°—Ç–∞–≤–∏—Ç `is_crit = True`.
*   **Output:** `ResultDTO(is_hit=True, is_crit=True, damage=150)`.

### Phase 4: Ability Service (Post-Calculation)
–°—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Ö—É–∫–∏.
*   **Check:** –ë—ã–ª –ª–∏ `is_hit` –≤ ResultDTO? –î–∞.
*   **Action:** –ù–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç `Bleeding` –Ω–∞ —Ü–µ–ª—å.

---

## 4. –ü—Ä–∏–º–µ—Ä: "Critical Bleed" (–†–∞–∑–±–æ—Ä –∫–µ–π—Å–∞)

–§–∏–Ω—Ç `swords` –∏–º–µ–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä `CRITICAL_BLEED`.

1.  **Builder** —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç —ç—Ç–æ –≤:
    ```python
    flags = {
        "force_crit": True,       # –ß–∞—Å—Ç—å "Critical"
        "trigger_bleed": True     # –ß–∞—Å—Ç—å "Bleed"
    }
    ```
2.  **Ability Service (Pre)**:
    *   –í–∏–¥–∏—Ç `trigger_bleed`.
    *   –ì–æ—Ç–æ–≤–∏—Ç DTO —ç—Ñ—Ñ–µ–∫—Ç–∞: `{type: "dot", name: "bleeding", power: 10}`.
    *   –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ `on_hit`.
3.  **Calculator**:
    *   –í–∏–¥–∏—Ç `force_crit`. –°—á–∏—Ç–∞–µ—Ç –∫—Ä–∏—Ç-—É—Ä–æ–Ω.
    *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `is_hit=True`.
4.  **Ability Service (Post)**:
    *   –í–∏–¥–∏—Ç `is_hit`.
    *   –ü—Ä–∏–º–µ–Ω—è–µ—Ç `bleeding` –∫ —Ü–µ–ª–∏.

## 5. –•—Ä–∞–Ω–µ–Ω–∏–µ –¢—Ä–∏–≥–≥–µ—Ä–æ–≤
*   **–ë–∞–∑–æ–≤—ã–µ —Ñ–ª–∞–≥–∏ (Control/Force):** –•–∞—Ä–¥–∫–æ–¥ –≤ `CombatCalculator` (–æ–Ω –∏—Ö –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `if flags.get('force_crit')`).
*   **–≠—Ñ—Ñ–µ–∫—Ç-—Ç—Ä–∏–≥–≥–µ—Ä—ã:** –°–ª–æ–≤–∞—Ä—å –≤ `AbilityService`.
    ```python
    # AbilityService Config
    KNOWN_TRIGGERS = {
        "TRIGGER_BLEED": BleedEffectFactory,
        "TRIGGER_STUN": StunEffectFactory,
        "TRIGGER_VAMPIRISM": VampirismLogic
    }
    ```
