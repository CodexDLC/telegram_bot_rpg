# Actor Data Structure (RBC v3.0)

‚¨ÖÔ∏è [–ù–∞–∑–∞–¥](../README.md) | üè† [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../../../../README.md)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –ê–∫—Ç–µ—Ä–∞ –≤ –¥–≤—É—Ö —Å–æ—Å—Ç–æ—è–Ω–∏—è—Ö:
1.  **Redis Storage:** –ö–∞–∫ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±–∞–∑–µ (Persistent).
2.  **Worker Runtime:** –ö–∞–∫ –¥–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –ø–∞–º—è—Ç–∏ –≤–æ—Ä–∫–µ—Ä–∞ (In-Memory).

---

## üèõÔ∏è Part 1: Redis Storage (Persistent Layer)
**Root Pattern:** `combat:rbc:{sid}:actor:{char_id}:*`

### 1.1. The State (Hash)
**Key:** `...:state`
**Role:** Hot Data. –ò–∑–º–µ–Ω—è–µ–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∂–∏–∑–Ω–µ–¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

| Field | Type | Description |
| :--- | :--- | :--- |
| `hp` | int | –¢–µ–∫—É—â–µ–µ –∑–¥–æ—Ä–æ–≤—å–µ. |
| `max_hp` | int | –ú–∞–∫—Å. –∑–¥–æ—Ä–æ–≤—å–µ. |
| `en` | int | –¢–µ–∫—É—â–∞—è —ç–Ω–µ—Ä–≥–∏—è. |
| `max_en` | int | –ú–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏—è. |
| `tactics` | int | –û—á–∫–∏ —Ç–∞–∫—Ç–∏–∫–∏ (–¥–ª—è —Å–º–µ–Ω—ã —Ü–µ–ª–∏). |
| `afk_level` | int | –£—Ä–æ–≤–µ–Ω—å —à—Ç—Ä–∞—Ñ–∞. |
| `is_dead` | int (0/1) | –§–ª–∞–≥ —Å–º–µ—Ä—Ç–∏ (0=Alive, 1=Dead). |
| `exchange_count` | int | –õ–∏—á–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ —Ä–∞–∑–º–µ–Ω–æ–≤. |
| `tokens` | json | `{ "gift": 5, "parry": 1 }` - –¢–æ–∫–µ–Ω—ã –î–∞—Ä–∞ –∏ –±–æ–µ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã. |

### 1.2. The Source (RedisJSON)
**Key:** `...:raw`
**Role:** Cold Data. –ò—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã.
*   **base:** –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞.
*   **sources:** –°–ª–æ–≤–∞—Ä—å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫.
*   **temp:** –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ª–æ–≤–∞—Ä—å –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤.
*   **known_abilities:** Whitelist –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–±–∏–ª–æ–∫.
*   **equipment_layout:** –ú–∞–ø–ø–∏–Ω–≥ —Å–ª–æ—Ç–æ–≤ –Ω–∞ —Ç–∏–ø—ã –Ω–∞–≤—ã–∫–æ–≤.

### 1.3. Active Abilities (RedisJSON)
**Key:** `...:active_abilities`
**Role:** Dynamic Modifiers.
*   **expire_at_exchange:** –ü–æ—Ä–æ–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.
*   **impact:** –ü—Ä—è–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ (`{"hp": -10}`).

### 1.4. XP Buffer (RedisJSON)
**Key:** `...:data_xp`
**Role:** Accumulator. –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π.
*   –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –°–ª–æ–≤–∞—Ä—å —Å—á–µ—Ç—á–∏–∫–æ–≤ (`{"dodge_success": 5, "crit_hits": 2}`).
*   *Note:* –ù–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–∫–∏–ª–ª–∞—Ö, —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã —Å–æ–±—ã—Ç–∏–π.

---

## üíª Part 2: Worker Runtime (In-Memory Layer)

–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ Python-–∫–ª–∞—Å—Å–æ–≤ (DTO) —Å–º. –≤ **[DTO Specification](./dtos.md)**.

*   `ActorSnapshot`
*   `ActorState`
*   `ActorRawDTO`
*   `ActiveAbilityDTO`
