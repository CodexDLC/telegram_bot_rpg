# Technical Design Doc #3: World Populator & Content Generation

**Версия:** 1.0 **Дата:** 06.12.2025 **Слой:** Game Service Layer **Суть:** Сервис фонового расширения мира и подготовка "Технического JSON" для LLM.

## 1. Триггер Расширения (Quest Trigger)

Генерация начинается не случайно, а детерминировано — по факту принятия задания.

### 1.1 Quest Service Handshake

Когда игрок берет квест "Найти пропавший патруль":

1. **Quest Service** генерирует уникальный ключ: `rift_inst_quest_42`.
    
2. Ключ кладется в payload квеста (Callback).
    
3. В БД Рифтов **записи еще нет**.
    
4. Отправляется задача в `BackgroundWorker`: "Подготовить маршрут к `rift_inst_quest_42`".
    

## 2. Логика Наполнения (Populator Logic)

Сервис прокладывает путь, но (Важно!) учитывает тип рифта.

### 2.1 Разделение Влияния

- **Сценарий А (Global Rift):** Если путь идет мимо "Бессмертного Рифта" -> Populator запрашивает Threat System (Doc #2) и добавляет теги искажения (`ash`, `distortion`).
    
- **Сценарий Б (Instance Rift):** Сам квестовый рифт не фонит. Путь к нему генерируется на основе чистых тегов биома (`forest`, `road`).
    

### 2.2 Формирование "Skeleton JSON"

Бэкенд формирует жесткую структуру данных для клетки. LLM здесь не принимает решений, она только описывает.

**Пример Skeleton JSON (Выход Populator'а):**

JSON

```
{
  "coordinates": {"x": 15, "y": 40},
  "biom_tags": ["dense_forest", "night", "rain"],
  "terrain_modifiers": [], // Пусто, так как это временный инст
  "points_of_interest": ["broken_cart"], // Бэкенд решил, что тут декор
  "service_object_key": "rift_inst_quest_42" // Ссылка на будущий вход
}
```

## 3. Генерация Описания (LLM Worker)

Асинхронная задача берет Skeleton JSON и скармливает нейросети.

- **Prompt Role:** "Ты — генератор описаний (Fluff Text). Не меняй факты. Если сказано 'телега', опиши телегу."
    
- **Input:** Skeleton JSON.
    
- **Output:** _"Ночной лес встретил вас шумом дождя. Сквозь ливень виднеется сломанная телега, а чуть поодаль ощущается странная вибрация..."_
    
- **Save:** Текст сохраняется в `content_payload` клетки.